
=== FILE: addons/ops_matrix_accounting/wizard/__init__.py ===

from . import ops_financial_report_wizard
from . import ops_general_ledger_wizard
from . import ops_general_ledger_wizard_enhanced

=== FILE: addons/ops_matrix_accounting/wizard/ops_general_ledger_wizard_enhanced.py ===

# -*- coding: utf-8 -*-
"""
OPS Matrix Accounting - Enhanced General Ledger Wizard
======================================================

Comprehensive General Ledger wizard with matrix dimension filtering
(Branch and Business Unit) and advanced consolidation options.

Author: OPS Matrix Framework
"""

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
from odoo.tools import date_utils, float_round
from datetime import datetime, timedelta
import logging

_logger = logging.getLogger(__name__)


class OpsGeneralLedgerWizardEnhanced(models.TransientModel):
    """Enhanced General Ledger Report Wizard with Matrix Dimensions"""
    _name = 'ops.general.ledger.wizard.enhanced'
    _description = 'General Ledger Report Wizard with Matrix Dimensions'
    
    # ============================================
    # 1. PERIOD FILTERS
    # ============================================
    date_from = fields.Date(
        string='From Date',
        required=True,
        default=lambda self: date_utils.start_of(datetime.now(), 'year')
    )
    date_to = fields.Date(
        string='To Date',
        required=True,
        default=lambda self: date_utils.end_of(datetime.now(), 'month')
    )
    
    # ============================================
    # 2. COMPANY & JOURNALS
    # ============================================
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        required=True,
        default=lambda self: self.env.company
    )
    journal_ids = fields.Many2many(
        'account.journal',
        string='Journals',
        help='Leave empty for all journals',
        domain="[('company_id', '=', company_id)]"
    )
    
    # ============================================
    # 3. MATRIX DIMENSION FILTERS
    # ============================================
    
    # Branch Filter
    branch_ids = fields.Many2many(
        'ops.branch',
        'gl_wizard_branch_rel',
        'wizard_id',
        'branch_id',
        string='Branches',
        help='Filter by specific branches. Leave empty for all branches.',
        domain="[('company_id', '=', company_id)]"
    )
    
    # Business Unit Filter
    business_unit_ids = fields.Many2many(
        'ops.business.unit',
        'gl_wizard_bu_rel',
        'wizard_id',
        'bu_id',
        string='Business Units',
        help='Filter by specific business units. Leave empty for all BUs.',
        domain="[('company_ids', 'in', [company_id])]"
    )
    
    # Matrix Combination Mode
    matrix_filter_mode = fields.Selection([
        ('any', 'Any Dimension (Branch OR BU)'),
        ('both', 'Both Dimensions (Branch AND BU)'),
        ('exact', 'Exact Combination'),
    ], string='Matrix Filter Mode', default='any', help="""
        - Any: Show transactions that match ANY selected branch/BU
        - Both: Show transactions that match BOTH selected branch AND BU
        - Exact: Show transactions with exact branch/BU combinations
    """)
    
    # ============================================
    # 4. ACCOUNT FILTERS
    # ============================================
    account_ids = fields.Many2many(
        'account.account',
        'gl_wizard_account_rel',
        'wizard_id',
        'account_id',
        string='Accounts',
        help='Filter by specific accounts. Leave empty for all accounts.',
        domain="[('company_id', '=', company_id), ('deprecated', '=', False)]"
    )
    
    account_type_ids = fields.Many2many(
        'account.account.type',
        string='Account Types',
        help='Filter by account types'
    )
    
    display_account = fields.Selection([
        ('all', 'All Accounts'),
        ('movement', 'With Movements'),
        ('not_zero', 'With Balance Not Zero'),
    ], string='Display Accounts', default='movement', required=True)
    
    # ============================================
    # 5. TRANSACTION FILTERS
    # ============================================
    target_move = fields.Selection([
        ('posted', 'Posted Entries'),
        ('all', 'All Entries'),
    ], string='Target Moves', default='posted', required=True)
    
    reconciled = fields.Selection([
        ('all', 'All Items'),
        ('reconciled', 'Reconciled Only'),
        ('unreconciled', 'Unreconciled Only'),
    ], string='Reconciliation Status', default='all', required=True)
    
    # Partner Filter
    partner_ids = fields.Many2many(
        'res.partner',
        'gl_wizard_partner_rel',
        'wizard_id',
        'partner_id',
        string='Partners',
        help='Filter by specific partners'
    )
    
    # ============================================
    # 6. CONSOLIDATION & GROUPING OPTIONS
    # ============================================
    consolidate_by_branch = fields.Boolean(
        string='Consolidate by Branch',
        help='Show totals grouped by branch',
        default=False
    )
    
    consolidate_by_bu = fields.Boolean(
        string='Consolidate by Business Unit',
        help='Show totals grouped by business unit',
        default=False
    )
    
    consolidate_by_partner = fields.Boolean(
        string='Consolidate by Partner',
        help='Show totals grouped by partner',
        default=False
    )
    
    group_by_date = fields.Selection([
        ('none', 'No Grouping'),
        ('day', 'Daily'),
        ('week', 'Weekly'),
        ('month', 'Monthly'),
        ('quarter', 'Quarterly'),
        ('year', 'Yearly'),
    ], string='Group by Date', default='none', required=True)
    
    # ============================================
    # 7. OUTPUT OPTIONS
    # ============================================
    report_format = fields.Selection([
        ('detailed', 'Detailed Lines'),
        ('summary', 'Summary Only'),
        ('both', 'Both Detailed and Summary'),
    ], string='Report Format', default='detailed', required=True)
    
    sort_by = fields.Selection([
        ('date', 'Date'),
        ('account', 'Account'),
        ('partner', 'Partner'),
        ('branch', 'Branch'),
        ('bu', 'Business Unit'),
    ], string='Sort By', default='date', required=True)
    
    include_initial_balance = fields.Boolean(
        string='Include Initial Balance',
        default=True,
        help='Show opening balance before period'
    )
    
    # ============================================
    # 8. COMPUTED FIELDS
    # ============================================
    filter_summary = fields.Char(
        compute='_compute_filter_summary',
        string='Filter Summary',
        help='Summary of active filters'
    )
    
    record_count = fields.Integer(
        compute='_compute_record_count',
        string='Estimated Records',
        help='Estimated number of records matching filters'
    )
    
    # ============================================
    # COMPUTED METHODS
    # ============================================
    
    @api.depends('branch_ids', 'business_unit_ids', 'account_ids', 'journal_ids', 
                 'date_from', 'date_to', 'target_move', 'reconciled', 'partner_ids')
    def _compute_filter_summary(self):
        """Compute human-readable summary of active filters."""
        for wizard in self:
            parts = []
            
            # Date range
            if wizard.date_from and wizard.date_to:
                parts.append(f"Period: {wizard.date_from} to {wizard.date_to}")
            
            # Matrix dimensions
            if wizard.branch_ids:
                if len(wizard.branch_ids) <= 3:
                    branch_names = wizard.branch_ids.mapped('code')
                    parts.append(f"Branches: {', '.join(branch_names)}")
                else:
                    parts.append(f"Branches: {len(wizard.branch_ids)} selected")
            
            if wizard.business_unit_ids:
                if len(wizard.business_unit_ids) <= 3:
                    bu_names = wizard.business_unit_ids.mapped('code')
                    parts.append(f"BUs: {', '.join(bu_names)}")
                else:
                    parts.append(f"BUs: {len(wizard.business_unit_ids)} selected")
            
            # Accounts and journals
            if wizard.account_ids:
                parts.append(f"Accounts: {len(wizard.account_ids)} selected")
            
            if wizard.journal_ids:
                parts.append(f"Journals: {len(wizard.journal_ids)} selected")
            
            # Partners
            if wizard.partner_ids:
                parts.append(f"Partners: {len(wizard.partner_ids)} selected")
            
            # Transaction filters
            if wizard.target_move == 'posted':
                parts.append("Posted only")
            
            if wizard.reconciled == 'unreconciled':
                parts.append("Unreconciled")
            elif wizard.reconciled == 'reconciled':
                parts.append("Reconciled")
            
            wizard.filter_summary = " | ".join(parts) if parts else "No filters applied"
    
    @api.depends('date_from', 'date_to', 'company_id', 'branch_ids', 'business_unit_ids', 
                 'account_ids', 'target_move', 'journal_ids', 'partner_ids')
    def _compute_record_count(self):
        """Estimate number of records matching current filters."""
        for wizard in self:
            if not wizard.date_from or not wizard.date_to:
                wizard.record_count = 0
                continue
            
            try:
                # Build domain
                domain = wizard._build_domain()
                
                # Count records
                count = self.env['account.move.line'].search_count(domain)
                wizard.record_count = count
            except Exception as e:
                _logger.error(f"Error counting records: {e}")
                wizard.record_count = 0
    
    # ============================================
    # DOMAIN BUILDING METHODS
    # ============================================
    
    def _build_domain(self):
        """Build complete domain for account move line query."""
        self.ensure_one()
        
        domain = [
            ('date', '>=', self.date_from),
            ('date', '<=', self.date_to),
            ('company_id', '=', self.company_id.id),
        ]
        
        # Target moves filter
        if self.target_move == 'posted':
            domain.append(('move_id.state', '=', 'posted'))
        
        # Reconciliation filter
        if self.reconciled == 'unreconciled':
            domain.append(('reconciled', '=', False))
        elif self.reconciled == 'reconciled':
            domain.append(('reconciled', '=', True))
        
        # Account filters
        if self.account_ids:
            domain.append(('account_id', 'in', self.account_ids.ids))
        
        if self.account_type_ids:
            account_ids = self.env['account.account'].search([
                ('account_type', 'in', self.account_type_ids.ids),
                ('company_id', '=', self.company_id.id)
            ])
            domain.append(('account_id', 'in', account_ids.ids))
        
        # Journal filters
        if self.journal_ids:
            domain.append(('journal_id', 'in', self.journal_ids.ids))
        
        # Partner filter
        if self.partner_ids:
            domain.append(('partner_id', 'in', self.partner_ids.ids))
        
        # Matrix dimension filters
        matrix_domain = self._build_matrix_domain()
        if matrix_domain:
            domain += matrix_domain
        
        return domain
    
    def _build_matrix_domain(self):
        """Build matrix dimension domain based on filter mode."""
        matrix_domain = []
        
        # If no matrix filters, return empty
        if not self.branch_ids and not self.business_unit_ids:
            return matrix_domain
        
        # Build branch domain
        branch_domain = []
        if self.branch_ids:
            branch_domain = [('ops_branch_id', 'in', self.branch_ids.ids)]
        
        # Build BU domain
        bu_domain = []
        if self.business_unit_ids:
            bu_domain = [('ops_business_unit_id', 'in', self.business_unit_ids.ids)]
        
        # Apply filter mode
        if self.matrix_filter_mode == 'any':
            # OR condition: Branch OR BU
            if branch_domain and bu_domain:
                matrix_domain = ['|'] + branch_domain + bu_domain
            elif branch_domain:
                matrix_domain = branch_domain
            elif bu_domain:
                matrix_domain = bu_domain
        
        elif self.matrix_filter_mode == 'both':
            # AND condition: Branch AND BU
            if branch_domain and bu_domain:
                matrix_domain = branch_domain + bu_domain
            else:
                # If only one dimension selected in "both" mode, treat as "any"
                matrix_domain = branch_domain or bu_domain
        
        elif self.matrix_filter_mode == 'exact':
            # Exact combinations: apply both filters, post-filter in Python
            matrix_domain = []
            if branch_domain:
                matrix_domain += branch_domain
            if bu_domain:
                matrix_domain += bu_domain
        
        return matrix_domain
    
    def _get_exact_matrix_combinations(self):
        """Get list of exact branch-BU combinations for exact filter mode."""
        combinations = set()
        if self.branch_ids and self.business_unit_ids:
            for branch in self.branch_ids:
                for bu in self.business_unit_ids:
                    # Check if BU actually operates in this branch
                    if branch in bu.branch_ids:
                        combinations.add((branch.id, bu.id))
        return combinations
    
    # ============================================
    # VALIDATION METHODS
    # ============================================
    
    def _validate_filters(self):
        """Validate wizard filters before generating report."""
        self.ensure_one()
        
        if self.date_from > self.date_to:
            raise ValidationError(_("From date cannot be after To date."))
        
        # Check matrix filter logic
        if self.matrix_filter_mode == 'exact' and (not self.branch_ids or not self.business_unit_ids):
            raise ValidationError(_(
                "Exact combination mode requires both Branch and Business Unit filters."
            ))
        
        # Check for very large date ranges
        date_diff = (self.date_to - self.date_from).days
        if date_diff > 365 and self.report_format == 'detailed' and not self.account_ids:
            return {
                'warning': {
                    'title': _('Large Date Range'),
                    'message': _(
                        'You are generating a detailed report for more than 1 year without account filter. '
                        'This may take a long time. Consider using summary format or filtering by accounts.'
                    ),
                }
            }
        
        # Check for large result sets
        if self.record_count > 50000 and self.report_format == 'detailed':
            return {
                'warning': {
                    'title': _('Large Result Set'),
                    'message': _(
                        'This filter will return approximately %(count)d records. '
                        'Consider using summary format or applying additional filters.'
                    ) % {'count': self.record_count},
                }
            }
        
        return True
    
    # ============================================
    # REPORT GENERATION METHODS
    # ============================================
    
    def action_generate_report(self):
        """Generate the general ledger report with matrix filters."""
        self.ensure_one()
        
        # Validate filters
        validation_result = self._validate_filters()
        if isinstance(validation_result, dict) and 'warning' in validation_result:
            # Return warning but allow user to proceed
            pass
        
        # Generate report data
        report_data = self._prepare_report_data()
        
        # Return report action
        return self._return_report_action(report_data)
    
    def _prepare_report_data(self):
        """Prepare complete report data."""
        self.ensure_one()
        
        domain = self._build_domain()
        MoveLine = self.env['account.move.line']
        
        # Get initial balances if requested
        initial_balances = {}
        if self.include_initial_balance:
            initial_balances = self._get_initial_balances()
        
        # Get move lines
        order_by = self._get_sort_order()
        lines = MoveLine.search(domain, order=order_by)
        
        # Apply exact matrix filtering if needed
        if self.matrix_filter_mode == 'exact' and self.branch_ids and self.business_unit_ids:
            exact_combinations = self._get_exact_matrix_combinations()
            lines = lines.filtered(
                lambda l: (l.ops_branch_id.id, l.ops_business_unit_id.id) in exact_combinations
            )
        
        # Process lines based on report format
        if self.report_format == 'summary':
            processed_data = self._process_summary_data(lines)
        elif self.report_format == 'detailed':
            processed_data = self._process_detailed_data(lines)
        else:  # both
            processed_data = {
                'summary': self._process_summary_data(lines),
                'detailed': self._process_detailed_data(lines),
            }
        
        # Prepare final report data
        report_data = {
            'wizard_id': self.id,
            'company_name': self.company_id.name,
            'company_currency': self.company_id.currency_id.name,
            'date_from': str(self.date_from),
            'date_to': str(self.date_to),
            'filters': self._get_filter_summary_dict(),
            'initial_balances': initial_balances,
            'data': processed_data,
            'report_format': self.report_format,
            'totals': {
                'total_debit': sum(line.debit for line in lines),
                'total_credit': sum(line.credit for line in lines),
                'total_balance': sum(line.balance for line in lines),
                'line_count': len(lines),
            },
        }
        
        return report_data
    
    def _get_initial_balances(self):
        """Get initial balances for accounts before the period."""
        self.ensure_one()
        
        MoveLine = self.env['account.move.line']
        
        # Build domain for transactions before period
        domain = [
            ('date', '<', self.date_from),
            ('company_id', '=', self.company_id.id),
            ('move_id.state', '=', 'posted'),
        ]
        
        # Apply same filters as main report
        if self.account_ids:
            domain.append(('account_id', 'in', self.account_ids.ids))
        if self.journal_ids:
            domain.append(('journal_id', 'in', self.journal_ids.ids))
        if self.partner_ids:
            domain.append(('partner_id', 'in', self.partner_ids.ids))
        
        # Matrix filters
        matrix_domain = self._build_matrix_domain()
        if matrix_domain:
            domain += matrix_domain
        
        # Group by account (and other dimensions if consolidating)
        groupby_fields = ['account_id']
        if self.consolidate_by_branch and self.branch_ids:
            groupby_fields.append('ops_branch_id')
        if self.consolidate_by_bu and self.business_unit_ids:
            groupby_fields.append('ops_business_unit_id')
        if self.consolidate_by_partner and self.partner_ids:
            groupby_fields.append('partner_id')
        
        # Aggregate initial balances
        initial_data = MoveLine._read_group(
            domain,
            groupby_fields,
            ['debit:sum', 'credit:sum', 'balance:sum']
        )
        
        # Process into dictionary
        balances = {}
        for item in initial_data:
            key = tuple(item.get(field, False) for field in groupby_fields)
            balances[key] = {
                'debit': item.get('debit', 0),
                'credit': item.get('credit', 0),
                'balance': item.get('balance', 0),
            }
        
        return balances
    
    def _process_summary_data(self, lines):
        """Process lines into summary format with grouping."""
        self.ensure_one()
        
        # Determine grouping
        groupby_fields = ['account_id']
        if self.consolidate_by_branch:
            groupby_fields.append('ops_branch_id')
        if self.consolidate_by_bu:
            groupby_fields.append('ops_business_unit_id')
        if self.consolidate_by_partner:
            groupby_fields.append('partner_id')
        
        # Group data
        grouped_data = {}
        for line in lines:
            # Create group key
            key_parts = []
            key_parts.append(line.account_id.id)
            if self.consolidate_by_branch:
                key_parts.append(line.ops_branch_id.id if line.ops_branch_id else False)
            if self.consolidate_by_bu:
                key_parts.append(line.ops_business_unit_id.id if line.ops_business_unit_id else False)
            if self.consolidate_by_partner:
                key_parts.append(line.partner_id.id if line.partner_id else False)
            
            key = tuple(key_parts)
            
            if key not in grouped_data:
                grouped_data[key] = {
                    'account_id': line.account_id.id,
                    'account_code': line.account_id.code,
                    'account_name': line.account_id.name,
                    'debit': 0,
                    'credit': 0,
                    'balance': 0,
                    'count': 0,
                }
                
                if self.consolidate_by_branch:
                    grouped_data[key]['branch_id'] = line.ops_branch_id.id if line.ops_branch_id else False
                    grouped_data[key]['branch_name'] = line.ops_branch_id.name if line.ops_branch_id else ''
                if self.consolidate_by_bu:
                    grouped_data[key]['bu_id'] = line.ops_business_unit_id.id if line.ops_business_unit_id else False
                    grouped_data[key]['bu_name'] = line.ops_business_unit_id.name if line.ops_business_unit_id else ''
                if self.consolidate_by_partner:
                    grouped_data[key]['partner_id'] = line.partner_id.id if line.partner_id else False
                    grouped_data[key]['partner_name'] = line.partner_id.name if line.partner_id else ''
            
            grouped_data[key]['debit'] += line.debit
            grouped_data[key]['credit'] += line.credit
            grouped_data[key]['balance'] += line.balance
            grouped_data[key]['count'] += 1
        
        return list(grouped_data.values())
    
    def _process_detailed_data(self, lines):
        """Process lines into detailed format."""
        self.ensure_one()
        
        detailed_data = []
        running_balance = 0
        
        for line in lines:
            running_balance += line.balance
            
            detailed_data.append({
                'id': line.id,
                'date': str(line.date),
                'move_id': line.move_id.id,
                'move_name': line.move_id.name,
                'journal_code': line.journal_id.code,
                'account_code': line.account_id.code,
                'account_name': line.account_id.name,
                'partner_name': line.partner_id.name if line.partner_id else '',
                'branch_code': line.ops_branch_id.code if line.ops_branch_id else '',
                'branch_name': line.ops_branch_id.name if line.ops_branch_id else '',
                'bu_code': line.ops_business_unit_id.code if line.ops_business_unit_id else '',
                'bu_name': line.ops_business_unit_id.name if line.ops_business_unit_id else '',
                'name': line.name,
                'ref': line.ref or '',
                'debit': line.debit,
                'credit': line.credit,
                'balance': line.balance,
                'running_balance': running_balance,
                'reconciled': line.reconciled,
                'currency_id': line.currency_id.name if line.currency_id else '',
                'amount_currency': line.amount_currency,
            })
        
        return detailed_data
    
    def _get_sort_order(self):
        """Get sort order based on wizard selection."""
        sort_mapping = {
            'date': 'date, move_id, id',
            'account': 'account_id, date, id',
            'partner': 'partner_id, date, id',
            'branch': 'ops_branch_id, date, id',
            'bu': 'ops_business_unit_id, date, id',
        }
        return sort_mapping.get(self.sort_by, 'date, move_id, id')
    
    def _get_filter_summary_dict(self):
        """Get filter summary as dictionary for report."""
        return {
            'branch_count': len(self.branch_ids),
            'branch_names': self.branch_ids.mapped('name') if self.branch_ids else [],
            'bu_count': len(self.business_unit_ids),
            'bu_names': self.business_unit_ids.mapped('name') if self.business_unit_ids else [],
            'account_count': len(self.account_ids),
            'journal_count': len(self.journal_ids),
            'partner_count': len(self.partner_ids),
            'date_range': f"{self.date_from} to {self.date_to}",
            'target_move': self.target_move,
            'reconciled': self.reconciled,
            'matrix_filter_mode': self.matrix_filter_mode,
            'consolidate_by_branch': self.consolidate_by_branch,
            'consolidate_by_bu': self.consolidate_by_bu,
            'consolidate_by_partner': self.consolidate_by_partner,
            'group_by_date': self.group_by_date,
            'display_account': self.display_account,
            'include_initial_balance': self.include_initial_balance,
        }
    
    def _return_report_action(self, data):
        """Return appropriate report action."""
        return {
            'type': 'ir.actions.report',
            'report_name': 'ops_matrix_accounting.report_general_ledger_matrix',
            'report_type': 'qweb-pdf',
            'data': data,
            'config': False,
        }
    
    # ============================================
    # ACTION METHODS
    # ============================================
    
    def action_export_to_excel(self):
        """Export report to Excel format."""
        self.ensure_one()
        
        # Prepare report data
        report_data = self._prepare_report_data()
        
        return {
            'type': 'ir.actions.report',
            'report_name': 'ops_matrix_accounting.report_general_ledger_matrix_xlsx',
            'report_type': 'xlsx',
            'data': report_data,
            'config': False,
        }
    
    def action_view_transactions(self):
        """Open filtered journal entries in tree view."""
        self.ensure_one()
        
        domain = self._build_domain()
        
        # Get move IDs
        lines = self.env['account.move.line'].search(domain)
        
        # Apply exact matrix filtering if needed
        if self.matrix_filter_mode == 'exact' and self.branch_ids and self.business_unit_ids:
            exact_combinations = self._get_exact_matrix_combinations()
            lines = lines.filtered(
                lambda l: (l.ops_branch_id.id, l.ops_business_unit_id.id) in exact_combinations
            )
        
        move_ids = lines.mapped('move_id').ids
        
        return {
            'name': _('Journal Entries'),
            'type': 'ir.actions.act_window',
            'res_model': 'account.move',
            'view_mode': 'tree,form',
            'domain': [('id', 'in', move_ids)],
            'context': {
                'search_default_group_by_date': 1 if self.group_by_date != 'none' else 0,
            },
        }
    
    def action_view_account_moves(self):
        """View moves for specific account (called from report)."""
        self.ensure_one()
        
        account_id = self.env.context.get('account_id')
        if not account_id:
            raise UserError(_("No account specified"))
        
        domain = self._build_domain()
        domain.append(('account_id', '=', account_id))
        
        return {
            'name': _('Account Moves'),
            'type': 'ir.actions.act_window',
            'res_model': 'account.move.line',
            'view_mode': 'tree,form',
            'domain': domain,
        }
    
    # ============================================
    # ONCHANGE METHODS
    # ============================================
    
    @api.onchange('company_id')
    def _onchange_company_id(self):
        """Reset filters when company changes."""
        if self.company_id:
            self.branch_ids = False
            self.business_unit_ids = False
            self.account_ids = False
            self.journal_ids = False
            self.partner_ids = False
    
    @api.onchange('branch_ids')
    def _onchange_branch_ids(self):
        """Update BU domain when branches change."""
        if self.branch_ids:
            return {
                'domain': {
                    'business_unit_ids': [('branch_ids', 'in', self.branch_ids.ids)]
                }
            }
        return {}
    
    @api.onchange('business_unit_ids')
    def _onchange_business_unit_ids(self):
        """Update branch domain when BUs change."""
        if self.business_unit_ids:
            branch_ids = self.business_unit_ids.mapped('branch_ids').ids
            return {
                'domain': {
                    'branch_ids': [('id', 'in', branch_ids)]
                }
            }
        return {}
    
    @api.onchange('report_format')
    def _onchange_report_format(self):
        """Adjust options based on report format."""
        if self.report_format == 'summary':
            # Enable consolidation for summary
            if not any([self.consolidate_by_branch, self.consolidate_by_bu, self.consolidate_by_partner]):
                self.consolidate_by_branch = bool(self.branch_ids)
                self.consolidate_by_bu = bool(self.business_unit_ids)

=== FILE: addons/ops_matrix_accounting/wizard/ops_general_ledger_wizard.py ===

from odoo import models, fields, api

class OpsGeneralLedgerWizard(models.TransientModel):
    _name = 'ops.general.ledger.wizard'
    _inherit = 'ops.financial.report.wizard'
    _description = 'General Ledger Report Wizard'

    account_ids = fields.Many2many('account.account', string='Accounts', 
                                     help='Leave empty to include all accounts')

    def action_print_pdf(self):
        self.ensure_one()
        data = {
            'date_from': self.date_from,
            'date_to': self.date_to,
            'target_move': self.target_move,
            'journal_ids': self.journal_ids.ids,
            'account_ids': self.account_ids.ids if self.account_ids else [],
            'company_id': self.company_id.id,
        }
        return self.env.ref('ops_matrix_accounting.action_report_general_ledger').report_action(self, data=data)

=== FILE: addons/ops_matrix_accounting/wizard/ops_financial_report_wizard.py ===

from odoo import models, fields, api, _
from odoo.exceptions import UserError
from dateutil.relativedelta import relativedelta
import io
import base64

class OpsFinancialReportWizard(models.TransientModel):
    """
    Lightweight Financial Reporting Wizard for Zero DB Bloat.
    Uses native Odoo views for on-screen analysis and in-memory generation for exports.
    """
    _name = 'ops.financial.report.wizard'
    _description = 'Financial Report Wizard'

    report_type = fields.Selection([
        ('pl', 'P&L'),
        ('bs', 'Balance Sheet'),
        ('gl', 'General Ledger'),
        ('aged', 'Aged Partner')
    ], string='Report Type', required=True, default='gl')
    
    date_from = fields.Date(string='Date From', required=True)
    date_to = fields.Date(string='Date To', required=True)
    
    branch_id = fields.Many2one(
        'res.company',
        string='Branch',
        help="Filter by branch (via analytic account)"
    )
    
    target_move = fields.Selection([
        ('posted', 'Posted Only'),
        ('all', 'All')
    ], string='Target Moves', default='posted', required=True)
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        required=True,
        default=lambda self: self.env.company
    )
    
    journal_ids = fields.Many2many(
        'account.journal',
        string='Journals',
        help='Leave empty to include all journals'
    )

    @api.model
    def default_get(self, fields_list):
        """Set default date range to current month."""
        res = super().default_get(fields_list)
        
        today = fields.Date.context_today(self)
        first_day = today.replace(day=1)
        last_day = (first_day + relativedelta(months=1, days=-1))
        
        if 'date_from' in fields_list:
            res['date_from'] = first_day
        if 'date_to' in fields_list:
            res['date_to'] = last_day
        
        return res

    def _get_domain(self):
        """Build domain for account.move.line based on wizard filters."""
        self.ensure_one()
        
        domain = [
            ('date', '>=', self.date_from),
            ('date', '<=', self.date_to),
            ('company_id', '=', self.company_id.id),
        ]
        
        # Filter by move state
        if self.target_move == 'posted':
            domain.append(('move_id.state', '=', 'posted'))
        
        # Filter by branch (via analytic account) - with validation
        if self.branch_id:
            if self.branch_id.ops_analytic_account_id:
                domain.append(('analytic_account_id', '=', self.branch_id.ops_analytic_account_id.id))
            else:
                # Log warning if branch has no analytic account
                import logging
                _logger = logging.getLogger(__name__)
                _logger.warning(
                    f"Branch '{self.branch_id.name}' (ID: {self.branch_id.id}) has no analytic account. "
                    "Branch filtering will be skipped."
                )
        
        # Filter by journals if specified
        if self.journal_ids:
            domain.append(('journal_id', 'in', self.journal_ids.ids))
        
        return domain

    def _get_context_groupings(self):
        """Return default groupings based on report type."""
        self.ensure_one()
        
        context = {}
        
        if self.report_type == 'pl':
            # P&L: Group by account type (Income/Expense)
            context.update({
                'pivot_row_groupby': ['account_id'],
                'pivot_column_groupby': [],
                'pivot_measures': ['debit', 'credit', 'balance'],
            })
        elif self.report_type == 'bs':
            # Balance Sheet: Group by account type (Asset/Liability)
            context.update({
                'pivot_row_groupby': ['account_id'],
                'pivot_column_groupby': [],
                'pivot_measures': ['debit', 'credit', 'balance'],
            })
        elif self.report_type == 'gl':
            # General Ledger: Group by account and date
            context.update({
                'pivot_row_groupby': ['account_id', 'date'],
                'pivot_column_groupby': [],
                'pivot_measures': ['debit', 'credit', 'balance'],
            })
        elif self.report_type == 'aged':
            # Aged Partner: Group by partner
            context.update({
                'pivot_row_groupby': ['partner_id'],
                'pivot_column_groupby': [],
                'pivot_measures': ['debit', 'credit', 'balance'],
            })
        
        return context

    def action_view_data(self):
        """
        Open account.move.line in pivot/tree view with filters applied.
        NO intermediate records created - Zero DB Bloat approach.
        """
        self.ensure_one()
        
        domain = self._get_domain()
        context = self._get_context_groupings()
        
        return {
            'name': _('%s - On-Screen Analysis') % dict(self._fields['report_type'].selection).get(self.report_type),
            'type': 'ir.actions.act_window',
            'res_model': 'account.move.line',
            'view_mode': 'pivot,tree',
            'domain': domain,
            'context': context,
            'target': 'current',
        }

    def action_print_pdf(self):
        """Generate PDF report using AbstractModel parser (in-memory processing)."""
        self.ensure_one()
        return self.env.ref('ops_matrix_accounting.action_report_ops_financial').report_action(self)

    def action_export_xlsx(self):
        """Export to Excel using in-memory generation."""
        self.ensure_one()
        
        # Get the report parser
        report_parser = self.env['report.ops_matrix_accounting.report_ops_financial_parser']
        report_data = report_parser._get_report_data(self)
        
        # Generate XLSX file
        try:
            import xlsxwriter
            output = io.BytesIO()
            workbook = xlsxwriter.Workbook(output, {'in_memory': True})
            worksheet = workbook.add_worksheet(report_data['title'])
            
            # Formats
            header_format = workbook.add_format({
                'bold': True,
                'bg_color': '#D3D3D3',
                'border': 1
            })
            
            # Write headers
            col = 0
            for header in report_data['headers']:
                worksheet.write(0, col, header, header_format)
                col += 1
            
            # Write data
            row = 1
            for line in report_data['lines']:
                col = 0
                for value in line.values():
                    worksheet.write(row, col, value)
                    col += 1
                row += 1
            
            workbook.close()
            output.seek(0)
            
            # Create attachment
            filename = f"{report_data['title']}_{self.date_from}_{self.date_to}.xlsx"
            attachment = self.env['ir.attachment'].create({
                'name': filename,
                'type': 'binary',
                'datas': base64.b64encode(output.read()),
                'mimetype': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            })
            
            return {
                'type': 'ir.actions.act_url',
                'url': f'/web/content/{attachment.id}?download=true',
                'target': 'new',
            }
            
        except ImportError:
            raise UserError(_('xlsxwriter library is not installed. Please install it to export to Excel.'))

=== FILE: addons/ops_matrix_accounting/reports/ops_financial_report_template.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Define the PDF Report Action -->
    <record id="action_report_ops_financial" model="ir.actions.report">
        <field name="name">Financial Report</field>
        <field name="model">ops.financial.report.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_ops_financial_document</field>
        <field name="report_file">ops_matrix_accounting.report_ops_financial_document</field>
        <field name="print_report_name">'Financial_Report_%s' % (object.report_type)</field>
    </record>

    <!-- QWeb PDF Template -->
    <template id="report_ops_financial_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <!-- report_data is already available from _get_report_values context -->
                <t t-call="web.external_layout">
                    <div class="page">
                        <!-- Header Section -->
                        <div class="row mb32">
                            <div class="col-12 text-center">
                                <h2><strong t-esc="report_data['title']"/></h2>
                            </div>
                        </div>

                        <!-- Matrix Headers -->
                        <div class="row mb16">
                            <div class="col-6">
                                <strong>Company:</strong> <span t-esc="report_data['company']"/><br/>
                                <strong>Branch:</strong> <span t-esc="report_data['branch']"/><br/>
                                <strong>Period:</strong> <span t-esc="report_data['date_from']"/> to <span t-esc="report_data['date_to']"/>
                            </div>
                            <div class="col-6 text-right">
                                <strong>Prepared By:</strong> <span t-esc="report_data['user']"/><br/>
                                <strong>Date:</strong> <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%Y-%m-%d %H:%M')"/><br/>
                                <strong>Target Moves:</strong> <span t-esc="report_data['target_move']"/>
                            </div>
                        </div>

                        <hr/>

                        <!-- Report Content - General Ledger -->
                        <t t-if="doc.report_type == 'gl'">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th>Date</th>
                                        <th>Entry</th>
                                        <th>Account</th>
                                        <th>Partner</th>
                                        <th>Label</th>
                                        <th class="text-right">Debit</th>
                                        <th class="text-right">Credit</th>
                                        <th class="text-right">Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="report_data['lines']" t-as="line">
                                        <tr>
                                            <td><span t-esc="line['date']"/></td>
                                            <td>
                                                <span t-esc="line['move_name']"/>
                                                <!-- Drill-down: Show move_id for auditability -->
                                                <t t-if="line.get('move_id')">
                                                    <br/><small class="text-muted">(ID: <span t-esc="line['move_id']"/>)</small>
                                                </t>
                                            </td>
                                            <td><span t-esc="line['account']"/></td>
                                            <td><span t-esc="line['partner']"/></td>
                                            <td><span t-esc="line['label']"/></td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['debit']"/></td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['credit']"/></td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['balance']"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>

                        <!-- Report Content - P&L -->
                        <t t-if="doc.report_type == 'pl'">
                            <h4>Income</h4>
                            <table class="table table-sm table-bordered mb16">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th>Account</th>
                                        <th class="text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="report_data['income_lines']" t-as="line">
                                        <tr>
                                            <td>
                                                <span t-esc="line['account']"/>
                                                <!-- Show account code for drill-down -->
                                                <t t-if="line.get('account_id')">
                                                    <br/><small class="text-muted">(Account ID: <span t-esc="line['account_id']"/>)</small>
                                                </t>
                                            </td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['amount']"/></td>
                                        </tr>
                                    </t>
                                    <tr style="font-weight: bold; background-color: #e9ecef;">
                                        <td>Total Income</td>
                                        <td class="text-right"><span t-esc="'%.2f' % report_data['income_total']"/></td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4>Expenses</h4>
                            <table class="table table-sm table-bordered mb16">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th>Account</th>
                                        <th class="text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="report_data['expense_lines']" t-as="line">
                                        <tr>
                                            <td>
                                                <span t-esc="line['account']"/>
                                                <!-- Show account code for drill-down -->
                                                <t t-if="line.get('account_id')">
                                                    <br/><small class="text-muted">(Account ID: <span t-esc="line['account_id']"/>)</small>
                                                </t>
                                            </td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['amount']"/></td>
                                        </tr>
                                    </t>
                                    <tr style="font-weight: bold; background-color: #e9ecef;">
                                        <td>Total Expenses</td>
                                        <td class="text-right"><span t-esc="'%.2f' % report_data['expense_total']"/></td>
                                    </tr>
                                </tbody>
                            </table>

                            <table class="table table-sm table-bordered">
                                <tbody>
                                    <tr style="font-weight: bold;">
                                        <td>Gross Profit</td>
                                        <td class="text-right"><span t-esc="'%.2f' % report_data['gross_profit']"/></td>
                                    </tr>
                                    <tr style="font-weight: bold; font-size: 1.1em; background-color: #d4edda;">
                                        <td>Net Profit</td>
                                        <td class="text-right"><span t-esc="'%.2f' % report_data['net_profit']"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </t>

                        <!-- Report Content - Balance Sheet -->
                        <t t-if="doc.report_type == 'bs'">
                            <div class="row">
                                <div class="col-6">
                                    <h4>Assets</h4>
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr style="background-color: #f5f5f5;">
                                                <th>Account</th>
                                                <th class="text-right">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="report_data['asset_lines']" t-as="line">
                                                <tr>
                                                    <td><span t-esc="line['account']"/></td>
                                                    <td class="text-right"><span t-esc="'%.2f' % line['amount']"/></td>
                                                </tr>
                                            </t>
                                            <tr style="font-weight: bold; background-color: #e9ecef;">
                                                <td>Total Assets</td>
                                                <td class="text-right"><span t-esc="'%.2f' % report_data['asset_total']"/></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-6">
                                    <h4>Liabilities</h4>
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr style="background-color: #f5f5f5;">
                                                <th>Account</th>
                                                <th class="text-right">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="report_data['liability_lines']" t-as="line">
                                                <tr>
                                                    <td><span t-esc="line['account']"/></td>
                                                    <td class="text-right"><span t-esc="'%.2f' % line['amount']"/></td>
                                                </tr>
                                            </t>
                                            <tr style="font-weight: bold; background-color: #e9ecef;">
                                                <td>Total Liabilities</td>
                                                <td class="text-right"><span t-esc="'%.2f' % report_data['liability_total']"/></td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <h4>Equity</h4>
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr style="background-color: #f5f5f5;">
                                                <th>Account</th>
                                                <th class="text-right">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="report_data['equity_lines']" t-as="line">
                                                <tr>
                                                    <td><span t-esc="line['account']"/></td>
                                                    <td class="text-right"><span t-esc="'%.2f' % line['amount']"/></td>
                                                </tr>
                                            </t>
                                            <tr style="font-weight: bold; background-color: #e9ecef;">
                                                <td>Total Equity</td>
                                                <td class="text-right"><span t-esc="'%.2f' % report_data['equity_total']"/></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </t>

                        <!-- Report Content - Aged Partner -->
                        <t t-if="doc.report_type == 'aged'">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th>Partner</th>
                                        <th class="text-right">Debit</th>
                                        <th class="text-right">Credit</th>
                                        <th class="text-right">Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="report_data['lines']" t-as="line">
                                        <tr>
                                            <td><span t-esc="line['partner']"/></td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['debit']"/></td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['credit']"/></td>
                                            <td class="text-right"><span t-esc="'%.2f' % line['balance']"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>

=== FILE: addons/ops_matrix_accounting/reports/ops_consolidated_report_templates.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Company Consolidation Report PDF Template -->
    <record id="report_company_consolidation_pdf" model="ir.actions.report">
        <field name="name">Company Consolidation Report</field>
        <field name="model">ops.company.consolidation</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_company_consolidation_document</field>
        <field name="report_file">ops_matrix_accounting.report_company_consolidation_document</field>
        <field name="binding_model_id" ref="model_ops_company_consolidation"/>
        <field name="binding_type">report</field>
    </record>
    
    <template id="report_company_consolidation_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <div class="page">
                        <h2>Company Consolidated P&amp;L Report</h2>
                        <div class="row mt-3">
                            <div class="col-6">
                                <strong>Company:</strong> <span t-field="o.company_id.name"/>
                            </div>
                            <div class="col-6">
                                <strong>Period:</strong> 
                                <span t-field="o.date_from"/> to <span t-field="o.date_to"/>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <strong>Detail Level:</strong> <span t-field="o.report_detail_level"/>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <p class="text-center">
                                    <em>Report data is computed dynamically. For detailed analysis, use the report wizard.</em>
                                </p>
                            </div>
                        </div>
                        
                        <div class="row mt-3" t-if="o.report_data">
                            <div class="col-12">
                                <h4>Summary</h4>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Total Income</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('total_income', 0))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Expenses</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('total_expense', 0))"/>
                                        </td>
                                    </tr>
                                    <tr class="font-weight-bold">
                                        <td><strong>Net Profit</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('net_profit', 0))"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
    
    <!-- Company Consolidation Excel Export -->
    <record id="report_company_consolidation_xlsx" model="ir.actions.report">
        <field name="name">Company Consolidation Excel</field>
        <field name="model">ops.company.consolidation</field>
        <field name="report_type">xlsx</field>
        <field name="report_name">ops_matrix_accounting.report_company_consolidation_xlsx</field>
        <field name="report_file">ops_matrix_accounting.report_company_consolidation_xlsx</field>
        <field name="binding_model_id" ref="model_ops_company_consolidation"/>
        <field name="binding_type">report</field>
    </record>
    
    <!-- Branch P&L Report PDF Template -->
    <record id="report_branch_pl_pdf" model="ir.actions.report">
        <field name="name">Branch P&amp;L Report</field>
        <field name="model">ops.branch.report</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_branch_pl_document</field>
        <field name="report_file">ops_matrix_accounting.report_branch_pl_document</field>
        <field name="binding_model_id" ref="model_ops_branch_report"/>
        <field name="binding_type">report</field>
    </record>
    
    <template id="report_branch_pl_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <div class="page">
                        <h2>Branch Profit &amp; Loss Report</h2>
                        <div class="row mt-3">
                            <div class="col-6">
                                <strong>Branch:</strong> <span t-field="o.branch_id.name"/>
                            </div>
                            <div class="col-6">
                                <strong>Branch Code:</strong> <span t-field="o.branch_id.code"/>
                            </div>
                        </div>
                        
                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>Company:</strong> <span t-field="o.branch_id.company_id.name"/>
                            </div>
                            <div class="col-6">
                                <strong>Period:</strong> 
                                <span t-field="o.date_from"/> to <span t-field="o.date_to"/>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <p class="text-center">
                                    <em>Report data is computed dynamically. For detailed analysis, use the report wizard.</em>
                                </p>
                            </div>
                        </div>
                        
                        <div class="row mt-3" t-if="o.report_data">
                            <div class="col-12">
                                <h4>Financial Summary</h4>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Total Income</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('total_income', 0))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Expenses</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('total_expense', 0))"/>
                                        </td>
                                    </tr>
                                    <tr class="font-weight-bold">
                                        <td><strong>Net Profit</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('net_profit', 0))"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
    
    <!-- Business Unit Report PDF Template -->
    <record id="report_business_unit_pdf" model="ir.actions.report">
        <field name="name">Business Unit Report</field>
        <field name="model">ops.business.unit.report</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_business_unit_document</field>
        <field name="report_file">ops_matrix_accounting.report_business_unit_document</field>
        <field name="binding_model_id" ref="model_ops_business_unit_report"/>
        <field name="binding_type">report</field>
    </record>
    
    <template id="report_business_unit_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <div class="page">
                        <h2>Business Unit Profitability Report</h2>
                        <div class="row mt-3">
                            <div class="col-6">
                                <strong>Business Unit:</strong> <span t-field="o.business_unit_id.name"/>
                            </div>
                            <div class="col-6">
                                <strong>BU Code:</strong> <span t-field="o.business_unit_id.code"/>
                            </div>
                        </div>
                        
                        <div class="row mt-2">
                            <div class="col-12">
                                <strong>Period:</strong> 
                                <span t-field="o.date_from"/> to <span t-field="o.date_to"/>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <p class="text-center">
                                    <em>Report data is computed dynamically. For detailed analysis, use the report wizard.</em>
                                </p>
                            </div>
                        </div>
                        
                        <div class="row mt-3" t-if="o.report_data">
                            <div class="col-12">
                                <h4>Performance Summary</h4>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Total Income</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('total_income', 0))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Expenses</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('total_expense', 0))"/>
                                        </td>
                                    </tr>
                                    <tr class="font-weight-bold">
                                        <td><strong>Net Profit</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(o.report_data.get('totals', {}).get('net_profit', 0))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Profit Margin</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:.2f}%'.format(o.report_data.get('totals', {}).get('profit_margin', 0))"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
    
    <!-- Consolidated Balance Sheet PDF Template -->
    <record id="report_consolidated_balance_sheet_pdf" model="ir.actions.report">
        <field name="name">Consolidated Balance Sheet</field>
        <field name="model">ops.consolidated.balance.sheet</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_consolidated_balance_sheet_document</field>
        <field name="report_file">ops_matrix_accounting.report_consolidated_balance_sheet_document</field>
        <field name="binding_model_id" ref="model_ops_consolidated_balance_sheet"/>
        <field name="binding_type">report</field>
    </record>
    
    <template id="report_consolidated_balance_sheet_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <div class="page">
                        <h2>Consolidated Balance Sheet</h2>
                        <div class="row mt-3">
                            <div class="col-6">
                                <strong>As of Date:</strong> <span t-field="o.date"/>
                            </div>
                            <div class="col-6">
                                <strong>Currency:</strong> <span t-field="o.currency_id.name"/>
                            </div>
                        </div>
                        
                        <div class="row mt-2">
                            <div class="col-12">
                                <strong>Companies:</strong> 
                                <span t-esc="', '.join(o.company_ids.mapped('name'))"/>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <p class="text-center">
                                    <em>Report data is computed dynamically. For detailed analysis, use the report wizard.</em>
                                </p>
                            </div>
                        </div>
                        
                        <div class="row mt-3" t-if="o.report_data">
                            <div class="col-12">
                                <h4>Consolidated Position</h4>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th colspan="2" class="text-center bg-light">ASSETS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="font-weight-bold">
                                            <td>Total Assets</td>
                                            <td class="text-right">
                                                <span t-esc="'{:,.2f}'.format(o.report_data.get('consolidated', {}).get('total_assets', 0))"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <thead>
                                        <tr>
                                            <th colspan="2" class="text-center bg-light">LIABILITIES &amp; EQUITY</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Total Liabilities</td>
                                            <td class="text-right">
                                                <span t-esc="'{:,.2f}'.format(o.report_data.get('consolidated', {}).get('total_liabilities', 0))"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Total Equity</td>
                                            <td class="text-right">
                                                <span t-esc="'{:,.2f}'.format(o.report_data.get('consolidated', {}).get('total_equity', 0))"/>
                                            </td>
                                        </tr>
                                        <tr class="font-weight-bold border-top">
                                            <td>Total Liabilities &amp; Equity</td>
                                            <td class="text-right">
                                                <span t-esc="'{:,.2f}'.format(o.report_data.get('consolidated', {}).get('total_liabilities', 0) + o.report_data.get('consolidated', {}).get('total_equity', 0))"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>

</odoo>

=== FILE: addons/ops_matrix_accounting/reports/ops_financial_report_parser.py ===

from odoo import models, api, _

class OpsFinancialReportParser(models.AbstractModel):
    """
    Abstract Report Parser for Financial Reports.
    Optimized for Odoo 19 with _read_group() and search_read() for performance.
    """
    _name = 'report.ops_matrix_accounting.report_ops_financial_parser'
    _description = 'Financial Report Parser'

    @api.model
    def _get_report_values(self, docids, data=None):
        """Main entry point for QWeb PDF generation."""
        wizard = self.env['ops.financial.report.wizard'].browse(docids)
        if not wizard:
            wizard = self.env['ops.financial.report.wizard'].browse(self.env.context.get('active_id'))
        
        report_data = self._get_report_data(wizard)
        
        return {
            'doc_ids': docids,
            'doc_model': 'ops.financial.report.wizard',
            'docs': wizard,
            'report_data': report_data,
        }

    def _get_report_data(self, wizard):
        """
        Fetch and process report data using optimized database queries.
        Returns structured dictionary ready for rendering.
        """
        wizard.ensure_one()
        
        # Get base domain from wizard
        domain = wizard._get_domain()
        
        # Route to appropriate report processor
        if wizard.report_type == 'pl':
            return self._process_pl_data(wizard, domain)
        elif wizard.report_type == 'bs':
            return self._process_bs_data(wizard, domain)
        elif wizard.report_type == 'gl':
            return self._process_gl_data(wizard, domain)
        elif wizard.report_type == 'aged':
            return self._process_aged_data(wizard, domain)
        
        return {}

    def _process_gl_data(self, wizard, domain):
        """
        Process General Ledger data using search_read for detail lines.
        PERFORMANCE: Avoids loading full recordsets; fetches dict list directly.
        """
        # For GL, we need detail lines so we use search_read instead of full search
        # PERFORMANCE: Add limit to prevent excessive data fetching on very large datasets
        lines_data = self.env['account.move.line'].search_read(
            domain,
            ['date', 'move_id', 'account_id', 'partner_id', 'name', 'debit', 'credit', 'balance'],
            order='date, account_id, move_id',
            limit=10000  # Reasonable limit for PDF reports
        )
        
        lines = []
        account_totals = {}
        
        for line_dict in lines_data:
            # Get related data (only IDs are returned by search_read)
            account = self.env['account.account'].browse(line_dict['account_id'][0]) if line_dict.get('account_id') else False
            account_code = account.code if account else ''
            account_name = account.name if account else ''
            account_key = f"{account_code} - {account_name}"
            
            # Initialize account totals
            if account_key not in account_totals:
                account_totals[account_key] = {
                    'debit': 0.0,
                    'credit': 0.0,
                    'balance': 0.0
                }
            
            # Accumulate totals
            account_totals[account_key]['debit'] += line_dict['debit']
            account_totals[account_key]['credit'] += line_dict['credit']
            account_totals[account_key]['balance'] += line_dict['balance']
            
            lines.append({
                'date': line_dict['date'],
                'move_name': line_dict['move_id'][1] if line_dict.get('move_id') else '',
                'move_id': line_dict['move_id'][0] if line_dict.get('move_id') else False,  # For drill-down
                'account': account_key,
                'account_id': account.id if account else False,  # For drill-down
                'partner': line_dict['partner_id'][1] if line_dict.get('partner_id') else '',
                'label': line_dict['name'] or '',
                'debit': line_dict['debit'],
                'credit': line_dict['credit'],
                'balance': line_dict['balance'],
            })
        
        return {
            'title': 'General Ledger',
            'date_from': wizard.date_from,
            'date_to': wizard.date_to,
            'branch': wizard.branch_id.name if wizard.branch_id else 'All Branches',
            'company': wizard.company_id.name,
            'user': self.env.user.name,
            'target_move': dict(wizard._fields['target_move'].selection).get(wizard.target_move),
            'headers': ['Date', 'Entry', 'Account', 'Partner', 'Label', 'Debit', 'Credit', 'Balance'],
            'lines': lines,
            'account_totals': account_totals,
        }

    def _process_pl_data(self, wizard, domain):
        """
        Process P&L data using _read_group for aggregation.
        PERFORMANCE: Database-level aggregation prevents OOM on large datasets.
        """
        # Use _read_group to aggregate at database level
        MoveLine = self.env['account.move.line']
        
        grouped_data = MoveLine._read_group(
            domain,
            ['account_id', 'debit', 'credit', 'balance'],
            ['account_id'],
        )
        
        income_lines = []
        expense_lines = []
        
        income_total = 0.0
        expense_total = 0.0
        cogs_total = 0.0
        
        # Process grouped results
        for group in grouped_data:
            account = self.env['account.account'].browse(group['account_id'][0]) if group.get('account_id') else False
            if not account:
                continue
                
            account_key = f"{account.code} - {account.name}"
            account_type = account.account_type
            
            debit_sum = group.get('debit', 0.0)
            credit_sum = group.get('credit', 0.0)
            
            if account_type in ['income', 'income_other']:
                amount = credit_sum - debit_sum
                income_total += amount
                income_lines.append({
                    'account': account_key,
                    'account_id': account.id,  # For drill-down
                    'amount': amount,
                })
            elif account_type in ['expense', 'expense_depreciation', 'expense_direct_cost']:
                amount = debit_sum - credit_sum
                expense_total += amount
                
                # Track COGS separately
                if account_type == 'expense_direct_cost':
                    cogs_total += amount
                
                expense_lines.append({
                    'account': account_key,
                    'account_id': account.id,  # For drill-down
                    'amount': amount,
                })
        
        # Calculate profit metrics
        gross_profit = income_total - cogs_total
        net_profit = income_total - expense_total
        
        return {
            'title': 'Profit & Loss',
            'date_from': wizard.date_from,
            'date_to': wizard.date_to,
            'branch': wizard.branch_id.name if wizard.branch_id else 'All Branches',
            'company': wizard.company_id.name,
            'user': self.env.user.name,
            'target_move': dict(wizard._fields['target_move'].selection).get(wizard.target_move),
            'headers': ['Account', 'Amount'],
            'income_lines': income_lines,
            'expense_lines': expense_lines,
            'income_total': income_total,
            'expense_total': expense_total,
            'cogs_total': cogs_total,
            'gross_profit': gross_profit,
            'net_profit': net_profit,
            'lines': income_lines + expense_lines,  # For Excel export
        }

    def _process_bs_data(self, wizard, domain):
        """
        Process Balance Sheet data using _read_group for aggregation.
        PERFORMANCE: Database-level aggregation prevents OOM on large datasets.
        """
        # Use _read_group to aggregate at database level
        MoveLine = self.env['account.move.line']
        
        grouped_data = MoveLine._read_group(
            domain,
            ['account_id', 'debit', 'credit', 'balance'],
            ['account_id'],
        )
        
        asset_lines = []
        liability_lines = []
        equity_lines = []
        
        asset_total = 0.0
        liability_total = 0.0
        equity_total = 0.0
        
        # Process grouped results
        for group in grouped_data:
            account = self.env['account.account'].browse(group['account_id'][0]) if group.get('account_id') else False
            if not account:
                continue
                
            account_key = f"{account.code} - {account.name}"
            account_type = account.account_type
            balance = group.get('balance', 0.0)
            
            if account_type in ['asset_receivable', 'asset_cash', 'asset_current', 'asset_prepayments', 
                                'asset_fixed', 'asset_non_current']:
                asset_total += balance
                asset_lines.append({
                    'account': account_key,
                    'amount': balance,
                })
            elif account_type in ['liability_payable', 'liability_current', 'liability_non_current']:
                liability_total += balance
                liability_lines.append({
                    'account': account_key,
                    'amount': balance,
                })
            elif account_type == 'equity':
                equity_total += balance
                equity_lines.append({
                    'account': account_key,
                    'amount': balance,
                })
        
        return {
            'title': 'Balance Sheet',
            'date_from': wizard.date_from,
            'date_to': wizard.date_to,
            'branch': wizard.branch_id.name if wizard.branch_id else 'All Branches',
            'company': wizard.company_id.name,
            'user': self.env.user.name,
            'target_move': dict(wizard._fields['target_move'].selection).get(wizard.target_move),
            'headers': ['Account', 'Amount'],
            'asset_lines': asset_lines,
            'liability_lines': liability_lines,
            'equity_lines': equity_lines,
            'asset_total': asset_total,
            'liability_total': liability_total,
            'equity_total': equity_total,
            'lines': asset_lines + liability_lines + equity_lines,  # For Excel export
        }

    def _process_aged_data(self, wizard, domain):
        """
        Process Aged Partner data using _read_group for aggregation.
        PERFORMANCE: Database-level aggregation prevents OOM on large datasets.
        """
        # Use _read_group to aggregate at database level
        MoveLine = self.env['account.move.line']
        
        grouped_data = MoveLine._read_group(
            domain,
            ['partner_id', 'debit', 'credit', 'balance'],
            ['partner_id'],
        )
        
        lines = []
        
        for group in grouped_data:
            if not group.get('partner_id'):
                continue
                
            partner = self.env['res.partner'].browse(group['partner_id'][0])
            lines.append({
                'partner': partner.name,
                'debit': group.get('debit', 0.0),
                'credit': group.get('credit', 0.0),
                'balance': group.get('balance', 0.0),
            })
        
        return {
            'title': 'Aged Partner Report',
            'date_from': wizard.date_from,
            'date_to': wizard.date_to,
            'branch': wizard.branch_id.name if wizard.branch_id else 'All Branches',
            'company': wizard.company_id.name,
            'user': self.env.user.name,
            'target_move': dict(wizard._fields['target_move'].selection).get(wizard.target_move),
            'headers': ['Partner', 'Debit', 'Credit', 'Balance'],
            'lines': lines,
        }

=== FILE: addons/ops_matrix_accounting/reports/__init__.py ===

from . import ops_general_ledger_report
# Disabled XLSX report - requires external module 'report_xlsx'
# from . import ops_general_ledger_xlsx
from . import ops_financial_report_parser

=== FILE: addons/ops_matrix_accounting/reports/ops_general_ledger_xlsx.py ===

from odoo import models
from odoo.exceptions import UserError
import io
import base64

class OpsGeneralLedgerXlsx(models.AbstractModel):
    """
    General Ledger XLSX Export.
    Uses in-memory generation to maintain "Zero DB Bloat" design.
    """
    _name = 'report.ops_matrix_accounting.report_general_ledger_xlsx'
    _description = 'General Ledger XLSX Report'
    _inherit = 'report.report_xlsx.abstract'

    def generate_xlsx_report(self, workbook, data, partners):
        """
        Generate XLSX report using xlsxwriter.
        
        Args:
            workbook: xlsxwriter.Workbook instance
            data: Report data dict from wizard
            partners: Wizard recordset (docids)
        """
        try:
            # Get report data from the parser
            report_parser = self.env['report.ops_matrix_accounting.report_general_ledger']
            report_values = report_parser._get_report_values(partners.ids, data)
            
            # Create worksheet
            worksheet = workbook.add_worksheet('General Ledger')
            
            # Define formats
            header_format = workbook.add_format({
                'bold': True,
                'bg_color': '#D3D3D3',
                'border': 1,
                'align': 'center',
                'valign': 'vcenter',
            })
            
            account_header_format = workbook.add_format({
                'bold': True,
                'bg_color': '#E9ECEF',
                'border': 1,
            })
            
            total_format = workbook.add_format({
                'bold': True,
                'bg_color': '#FFF3CD',
                'border': 1,
                'num_format': '#,##0.00',
            })
            
            currency_format = workbook.add_format({
                'num_format': '#,##0.00',
                'border': 1,
            })
            
            date_format = workbook.add_format({
                'num_format': 'yyyy-mm-dd',
                'border': 1,
            })
            
            text_format = workbook.add_format({
                'border': 1,
            })
            
            # Set column widths
            worksheet.set_column('A:A', 12)  # Date
            worksheet.set_column('B:B', 15)  # Journal
            worksheet.set_column('C:C', 25)  # Partner
            worksheet.set_column('D:D', 35)  # Label
            worksheet.set_column('E:E', 15)  # Reference
            worksheet.set_column('F:F', 15)  # Debit
            worksheet.set_column('G:G', 15)  # Credit
            worksheet.set_column('H:H', 15)  # Balance
            
            # Write report header
            row = 0
            worksheet.merge_range(row, 0, row, 7, 'GENERAL LEDGER REPORT', header_format)
            row += 1
            
            # Write metadata
            company = report_values.get('company')
            worksheet.write(row, 0, 'Company:', text_format)
            worksheet.write(row, 1, company.name if company else '', text_format)
            row += 1
            
            worksheet.write(row, 0, 'Period:', text_format)
            period_text = f"{data.get('date_from', '')} to {data.get('date_to', '')}"
            worksheet.write(row, 1, period_text, text_format)
            row += 1
            
            worksheet.write(row, 0, 'Target Moves:', text_format)
            worksheet.write(row, 1, data.get('target_move', 'posted'), text_format)
            row += 2
            
            # Process accounts
            accounts = report_values.get('accounts', [])
            
            for account in accounts:
                # Account header
                account_title = f"{account['account_code']} - {account['account_name']}"
                worksheet.merge_range(row, 0, row, 7, account_title, account_header_format)
                row += 1
                
                # Column headers
                headers = ['Date', 'Journal', 'Partner', 'Label', 'Reference', 'Debit', 'Credit', 'Balance']
                for col, header in enumerate(headers):
                    worksheet.write(row, col, header, header_format)
                row += 1
                
                # Account lines
                for line in account.get('lines', []):
                    worksheet.write(row, 0, line['move_date'], date_format)
                    worksheet.write(row, 1, line['journal'], text_format)
                    worksheet.write(row, 2, line['partner'], text_format)
                    worksheet.write(row, 3, line['label'], text_format)
                    worksheet.write(row, 4, line['reference'], text_format)
                    worksheet.write(row, 5, line['debit'], currency_format)
                    worksheet.write(row, 6, line['credit'], currency_format)
                    worksheet.write(row, 7, line['balance'], currency_format)
                    row += 1
                
                # Account totals
                worksheet.write(row, 4, 'Account Total:', total_format)
                worksheet.write(row, 5, account['total_debit'], total_format)
                worksheet.write(row, 6, account['total_credit'], total_format)
                worksheet.write(row, 7, account['total_balance'], total_format)
                row += 2
            
            # Grand totals
            grand_total = report_values.get('grand_total', {})
            worksheet.merge_range(row, 0, row, 4, 'GRAND TOTAL', total_format)
            worksheet.write(row, 5, grand_total.get('debit', 0.0), total_format)
            worksheet.write(row, 6, grand_total.get('credit', 0.0), total_format)
            worksheet.write(row, 7, grand_total.get('balance', 0.0), total_format)
            
        except Exception as e:
            raise UserError(f"Error generating XLSX report: {str(e)}")

    def _get_objs_for_report(self, docids, data):
        """
        Override to provide wizard data to the report.
        This method is called by the abstract XLSX report class.
        """
        if data:
            return self.env['ops.general.ledger.wizard'].browse(docids)
        return self.env['ops.general.ledger.wizard']

=== FILE: addons/ops_matrix_accounting/reports/ops_general_ledger_report.py ===

from odoo import models, api

class OpsGeneralLedgerReport(models.AbstractModel):
    """
    General Ledger Report Parser.
    Optimized for Odoo 19 with search_read() for better performance.
    """
    _name = 'report.ops_matrix_accounting.report_general_ledger'
    _description = 'General Ledger Report Parser'

    @api.model
    def _get_report_values(self, docids, data=None):
        if not data:
            data = {}
        
        date_from = data.get('date_from')
        date_to = data.get('date_to')
        target_move = data.get('target_move', 'posted')
        journal_ids = data.get('journal_ids', [])
        account_ids = data.get('account_ids', [])
        company_id = data.get('company_id')

        # Build domain conditions
        domain = []

        if date_from:
            domain.append(('date', '>=', date_from))
        if date_to:
            domain.append(('date', '<=', date_to))
        if target_move == 'posted':
            domain.append(('move_id.state', '=', 'posted'))
        if journal_ids:
            domain.append(('journal_id', 'in', journal_ids))
        if account_ids:
            domain.append(('account_id', 'in', account_ids))
        if company_id:
            domain.append(('company_id', '=', company_id))

        # PERFORMANCE OPTIMIZATION: Use search_read instead of search
        # This fetches dict list directly, avoiding heavy Recordset instantiation
        move_lines_data = self.env['account.move.line'].search_read(
            domain,
            ['account_id', 'date', 'journal_id', 'partner_id', 'name', 'ref', 'debit', 'credit'],
            order='account_id, date, id'
        )

        # Group by account
        accounts_data = {}
        for line_dict in move_lines_data:
            # Get account data from the tuple returned by search_read
            account_id = line_dict['account_id'][0] if line_dict.get('account_id') else False
            if not account_id:
                continue
                
            account = self.env['account.account'].browse(account_id)
            account_code = account.code
            account_name = account.name
            
            if account_code not in accounts_data:
                accounts_data[account_code] = {
                    'account_code': account_code,
                    'account_name': account_name,
                    'lines': [],
                    'total_debit': 0.0,
                    'total_credit': 0.0,
                    'total_balance': 0.0,
                }
            
            balance = line_dict['debit'] - line_dict['credit']
            
            line_data = {
                'account_code': account_code,
                'account_name': account_name,
                'move_date': line_dict['date'],
                'journal': line_dict['journal_id'][1] if line_dict.get('journal_id') else '',
                'partner': line_dict['partner_id'][1] if line_dict.get('partner_id') else '',
                'label': line_dict['name'],
                'reference': line_dict['ref'] or '',
                'debit': line_dict['debit'],
                'credit': line_dict['credit'],
                'balance': balance,
            }
            accounts_data[account_code]['lines'].append(line_data)
            accounts_data[account_code]['total_debit'] += line_dict['debit']
            accounts_data[account_code]['total_credit'] += line_dict['credit']
            accounts_data[account_code]['total_balance'] += balance

        # Calculate grand totals
        grand_total = {
            'debit': sum(acc['total_debit'] for acc in accounts_data.values()),
            'credit': sum(acc['total_credit'] for acc in accounts_data.values()),
            'balance': sum(acc['total_balance'] for acc in accounts_data.values()),
        }

        return {
            'doc_ids': docids,
            'doc_model': 'ops.general.ledger.wizard',
            'data': data,
            'accounts': list(accounts_data.values()),
            'grand_total': grand_total,
            'date_from': date_from,
            'date_to': date_to,
            'company': self.env['res.company'].browse(company_id) if company_id else self.env.company,
        }

=== FILE: addons/ops_matrix_accounting/reports/ops_general_ledger_template.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_general_ledger">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="text-center">
                        <h2>General Ledger Report</h2>
                        <p>
                            <strong>Period:</strong> <span t-esc="date_from"/> to <span t-esc="date_to"/>
                        </p>
                        <p>
                            <strong>Company:</strong> <span t-esc="company.name"/>
                        </p>
                    </div>

                    <t t-foreach="accounts" t-as="account">
                        <div class="mt-4">
                            <h4 style="background-color: #f0f0f0; padding: 8px;">
                                <strong><span t-esc="account['account_code']"/> - <span t-esc="account['account_name']"/></strong>
                            </h4>

                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr style="background-color: #e0e0e0;">
                                        <th>Date</th>
                                        <th>Journal</th>
                                        <th>Partner</th>
                                        <th>Ref</th>
                                        <th>Label</th>
                                        <th class="text-end">Debit</th>
                                        <th class="text-end">Credit</th>
                                        <th class="text-end">Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="account['lines']" t-as="line">
                                        <tr>
                                            <td><span t-esc="line['move_date']"/></td>
                                            <td><span t-esc="line['journal']"/></td>
                                            <td><span t-esc="line['partner'] or ''"/></td>
                                            <td><span t-esc="line['reference'] or ''"/></td>
                                            <td><span t-esc="line['label']"/></td>
                                            <td class="text-end"><span t-esc="'%.2f' % line['debit']"/></td>
                                            <td class="text-end"><span t-esc="'%.2f' % line['credit']"/></td>
                                            <td class="text-end"><strong><span t-esc="'%.2f' % line['balance']"/></strong></td>
                                        </tr>
                                    </t>
                                </tbody>
                                <tfoot>
                                    <tr style="background-color: #f5f5f5; font-weight: bold;">
                                        <td colspan="5" class="text-end">Account Total:</td>
                                        <td class="text-end"><span t-esc="'%.2f' % account['total_debit']"/></td>
                                        <td class="text-end"><span t-esc="'%.2f' % account['total_credit']"/></td>
                                        <td class="text-end"><span t-esc="'%.2f' % account['total_balance']"/></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </t>

                    <div class="mt-4">
                        <table class="table table-sm table-bordered">
                            <tfoot>
                                <tr style="background-color: #d0d0d0; font-weight: bold;">
                                    <td colspan="5" class="text-end">GRAND TOTAL:</td>
                                    <td class="text-end"><span t-esc="'%.2f' % grand_total['debit']"/></td>
                                    <td class="text-end"><span t-esc="'%.2f' % grand_total['credit']"/></td>
                                    <td class="text-end"><span t-esc="'%.2f' % grand_total['balance']"/></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </t>
        </t>
    </template>

    <record id="action_report_general_ledger" model="ir.actions.report">
        <field name="name">General Ledger</field>
        <field name="model">ops.general.ledger.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_general_ledger</field>
        <field name="report_file">ops_matrix_accounting.report_general_ledger</field>
        <field name="binding_model_id" ref="model_ops_general_ledger_wizard"/>
        <field name="binding_type">report</field>
    </record>


</odoo>

=== FILE: addons/ops_matrix_accounting/security/ir.model.access.csv ===

id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_ops_pdc_user,ops.pdc.user,model_ops_pdc,ops_matrix_core.group_ops_user,1,1,1,0
access_ops_pdc_manager,ops.pdc.manager,model_ops_pdc,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_budget_user,ops.budget.user,model_ops_budget,ops_matrix_core.group_ops_user,1,0,0,0
access_ops_budget_manager,ops.budget.manager,model_ops_budget,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_budget_line_user,ops.budget.line.user,model_ops_budget_line,ops_matrix_core.group_ops_user,1,0,0,0
access_ops_budget_line_manager,ops.budget.line.manager,model_ops_budget_line,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_gl_wizard_user,ops.general.ledger.wizard.user,model_ops_general_ledger_wizard,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_gl_wizard_enhanced_user,ops.general.ledger.wizard.enhanced.user,model_ops_general_ledger_wizard_enhanced,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_gl_wizard_enhanced_manager,ops.general.ledger.wizard.enhanced.manager,model_ops_general_ledger_wizard_enhanced,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_fin_report_wizard_user,ops.financial.report.wizard.user,model_ops_financial_report_wizard,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_company_consolidation_user,ops.company.consolidation.user,model_ops_company_consolidation,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_company_consolidation_manager,ops.company.consolidation.manager,model_ops_company_consolidation,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_branch_report_user,ops.branch.report.user,model_ops_branch_report,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_branch_report_manager,ops.branch.report.manager,model_ops_branch_report,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_business_unit_report_user,ops.business.unit.report.user,model_ops_business_unit_report,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_business_unit_report_manager,ops.business.unit.report.manager,model_ops_business_unit_report,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_consolidated_balance_sheet_user,ops.consolidated.balance.sheet.user,model_ops_consolidated_balance_sheet,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_consolidated_balance_sheet_manager,ops.consolidated.balance.sheet.manager,model_ops_consolidated_balance_sheet,ops_matrix_core.group_ops_manager,1,1,1,1
access_ops_matrix_profitability_analysis_user,ops.matrix.profitability.analysis.user,model_ops_matrix_profitability_analysis,ops_matrix_core.group_ops_user,1,1,1,1
access_ops_matrix_profitability_analysis_manager,ops.matrix.profitability.analysis.manager,model_ops_matrix_profitability_analysis,ops_matrix_core.group_ops_manager,1,1,1,1
=== FILE: addons/ops_matrix_accounting/hooks.py ===

# -*- coding: utf-8 -*-
from odoo import api, SUPERUSER_ID
import logging

_logger = logging.getLogger(__name__)


def post_init_hook(env):
    """
    Post-init hook for ops_matrix_accounting module.
    Auto-configures Chart of Accounts and Currency for non-technical users.
    This makes the module "Plug-and-Play".
    
    NOTE: In Odoo 19, post_init_hook receives 'env' as single argument, not (cr, registry).
    """
    
    _logger.info("=== OPS Matrix Accounting: Auto-Configuration Started ===")
    
    # Get the main company
    company = env.company
    
    # Step 1: Check if Chart of Accounts is already set
    if company.chart_template_id:
        _logger.info(f" Chart of Accounts already set: {company.chart_template_id.name}")
    else:
        _logger.info("No Chart of Accounts found. Searching for available templates...")
        
        # Search for any available Chart of Accounts template
        # Priority: generic > any localization
        coa_template = env['account.chart.template'].search([
            ('name', 'ilike', 'generic')
        ], limit=1)
        
        if not coa_template:
            # Fallback: Get any available chart template
            coa_template = env['account.chart.template'].search([], limit=1)
        
        if coa_template:
            try:
                # Try loading the chart template
                _logger.info(f"Installing Chart Template: {coa_template.name}")
                coa_template.try_loading(company=company)
                _logger.info(f" Chart of Accounts installed: {coa_template.name}")
            except Exception as e:
                _logger.warning(f"Could not auto-install Chart of Accounts: {e}")
                _logger.warning("User will need to manually install CoA from Accounting > Configuration")
        else:
            _logger.warning("No Chart of Accounts template found.")
            _logger.warning("User must install a localization module (e.g., l10n_us, l10n_generic_coa) first.")
    
    # Step 2: Ensure Company Currency is set to USD (or keep existing)
    if not company.currency_id:
        _logger.info("No currency set. Setting to USD...")
        usd = env['res.currency'].search([('name', '=', 'USD')], limit=1)
        if usd:
            company.currency_id = usd.id
            _logger.info(" Company currency set to USD")
        else:
            _logger.warning("USD currency not found in system")
    else:
        _logger.info(f" Company currency already set: {company.currency_id.name}")
    
    # Step 3: Ensure fiscal year is set up
    if not env['account.fiscal.year'].search_count([('company_id', '=', company.id)]):
        _logger.info("No fiscal year found. System will prompt user to create one.")
    else:
        _logger.info(" Fiscal year already configured")
    
    _logger.info("=== OPS Matrix Accounting: Auto-Configuration Complete ===")

=== FILE: addons/ops_matrix_accounting/data/templates/ops_budget_templates.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <!-- Budget templates are created through the UI and require specific Branch/Business Unit assignments -->
        <!-- No generic templates are provided as templates must be branch and business unit specific -->
    </data>
</odoo>

=== FILE: addons/ops_matrix_accounting/models/ops_consolidated_reporting.py ===

# -*- coding: utf-8 -*-
"""
OPS Matrix Accounting - Consolidated Financial Reporting
=========================================================

This module provides comprehensive financial reporting engines for hierarchical
consolidated reports across Company, Branch, and Business Unit dimensions.

Author: OPS Matrix Framework
"""

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
from odoo.tools import date_utils, float_round
from datetime import datetime, timedelta
import logging

_logger = logging.getLogger(__name__)


class OpsCompanyConsolidation(models.TransientModel):
    """Company-Level Consolidated P&L Report"""
    _name = 'ops.company.consolidation'
    _description = 'Company-Level Consolidated P&L Report'
    
    # Filter Fields
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        required=True,
        default=lambda self: self.env.company
    )
    date_from = fields.Date(
        string='From Date',
        required=True,
        default=lambda self: date_utils.start_of(datetime.now(), 'month')
    )
    date_to = fields.Date(
        string='To Date',
        required=True,
        default=lambda self: date_utils.end_of(datetime.now(), 'month')
    )
    
    # Comparison Period
    compare_with_previous = fields.Boolean(
        string='Compare with Previous Period',
        default=True
    )
    previous_date_from = fields.Date(
        string='Previous From Date',
        compute='_compute_previous_dates',
        store=False
    )
    previous_date_to = fields.Date(
        string='Previous To Date',
        compute='_compute_previous_dates',
        store=False
    )
    
    # Branch Filtering
    branch_ids = fields.Many2many(
        'ops.branch',
        string='Filter Branches',
        help='Leave empty for all branches in company',
        domain="[('company_id', '=', company_id)]"
    )
    
    # Level of Detail
    report_detail_level = fields.Selection([
        ('summary', 'Summary Only'),
        ('by_branch', 'By Branch'),
        ('by_bu', 'By Business Unit'),
        ('by_account', 'By Account Group')
    ], string='Detail Level', default='summary', required=True)
    
    # Report Data (stored)
    report_data = fields.Json(
        string='Report Data',
        compute='_compute_report_data',
        store=False
    )
    
    # Computed Methods
    @api.depends('date_from', 'date_to')
    def _compute_previous_dates(self):
        """Compute previous period dates for comparison."""
        for wizard in self:
            if wizard.date_from and wizard.date_to:
                period_days = (wizard.date_to - wizard.date_from).days
                wizard.previous_date_from = wizard.date_from - timedelta(days=period_days + 1)
                wizard.previous_date_to = wizard.date_from - timedelta(days=1)
            else:
                wizard.previous_date_from = False
                wizard.previous_date_to = False
    
    @api.depends('company_id', 'date_from', 'date_to', 'branch_ids', 'report_detail_level')
    def _compute_report_data(self):
        """Main method to compute consolidated company P&L."""
        for wizard in self:
            if not wizard.date_from or not wizard.date_to:
                wizard.report_data = {}
                continue
            
            # Get company branches (filtered if selected)
            domain = [('company_id', '=', wizard.company_id.id)]
            if wizard.branch_ids:
                domain.append(('id', 'in', wizard.branch_ids.ids))
            
            branches = self.env['ops.branch'].search(domain)
            
            # Get account move lines for the period
            base_domain = [
                ('date', '>=', wizard.date_from),
                ('date', '<=', wizard.date_to),
                ('company_id', '=', wizard.company_id.id),
                ('move_id.state', '=', 'posted'),
            ]
            
            # Apply branch filter if specified
            if wizard.branch_ids:
                base_domain.append(('ops_branch_id', 'in', wizard.branch_ids.ids))
            
            # Get data based on detail level
            if wizard.report_detail_level == 'summary':
                data = wizard._get_summary_data(base_domain, branches)
            elif wizard.report_detail_level == 'by_branch':
                data = wizard._get_branch_detail_data(base_domain, branches)
            elif wizard.report_detail_level == 'by_bu':
                data = wizard._get_bu_detail_data(base_domain, branches)
            elif wizard.report_detail_level == 'by_account':
                data = wizard._get_account_detail_data(base_domain, branches)
            else:
                data = {}
            
            # Add comparison data if requested
            if wizard.compare_with_previous:
                comparison_data = wizard._get_comparison_data()
                data['comparison'] = comparison_data
            
            wizard.report_data = data
    
    def _get_summary_data(self, domain, branches):
        """Get high-level summary P&L data."""
        MoveLine = self.env['account.move.line']
        
        # Get total income
        income_domain = domain + [
            ('account_id.account_type', 'in', ['income', 'income_other'])
        ]
        income_data = MoveLine._read_group(
            income_domain,
            ['account_id'],
            ['credit:sum', 'debit:sum']
        )
        total_income = sum(item['credit'] - item['debit'] for item in income_data)
        
        # Get total expense
        expense_domain = domain + [
            ('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])
        ]
        expense_data = MoveLine._read_group(
            expense_domain,
            ['account_id'],
            ['debit:sum', 'credit:sum']
        )
        total_expense = sum(item['debit'] - item['credit'] for item in expense_data)
        
        # Get gross profit (income - COGS)
        cogs_domain = domain + [
            ('account_id.account_type', '=', 'expense_direct_cost')
        ]
        cogs_data = MoveLine._read_group(
            cogs_domain,
            ['account_id'],
            ['debit:sum', 'credit:sum']
        )
        total_cogs = sum(item['debit'] - item['credit'] for item in cogs_data)
        gross_profit = total_income - total_cogs
        
        # Get operating expenses
        operating_domain = domain + [
            ('account_id.account_type', 'in', ['expense', 'expense_depreciation'])
        ]
        operating_data = MoveLine._read_group(
            operating_domain,
            ['account_id'],
            ['debit:sum', 'credit:sum']
        )
        total_operating = sum(item['debit'] - item['credit'] for item in operating_data)
        
        net_profit = total_income - total_expense
        
        return {
            'company': self.company_id.name,
            'period': f"{self.date_from} to {self.date_to}",
            'branches': len(branches),
            'totals': {
                'total_income': total_income,
                'total_cogs': total_cogs,
                'gross_profit': gross_profit,
                'gross_margin': (gross_profit / total_income * 100) if total_income else 0,
                'total_operating': total_operating,
                'total_expense': total_expense,
                'net_profit': net_profit,
                'net_margin': (net_profit / total_income * 100) if total_income else 0,
            },
            'branch_performance': self._get_branch_performance_summary(branches, domain),
        }
    
    def _get_branch_detail_data(self, domain, branches):
        """Get P&L data broken down by branch."""
        MoveLine = self.env['account.move.line']
        
        branch_data = []
        for branch in branches:
            branch_domain = domain + [('ops_branch_id', '=', branch.id)]
            
            # Get income for branch
            income_domain = branch_domain + [
                ('account_id.account_type', 'in', ['income', 'income_other'])
            ]
            income_result = MoveLine._read_group(
                income_domain,
                [],
                ['credit:sum', 'debit:sum']
            )
            branch_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
            
            # Get expense for branch
            expense_domain = branch_domain + [
                ('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])
            ]
            expense_result = MoveLine._read_group(
                expense_domain,
                [],
                ['debit:sum', 'credit:sum']
            )
            branch_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
            
            branch_data.append({
                'branch_id': branch.id,
                'branch_code': branch.code,
                'branch_name': branch.name,
                'income': branch_income,
                'expense': branch_expense,
                'net_profit': branch_income - branch_expense,
                'bu_count': len(branch.business_unit_ids),
                'transactions': MoveLine.search_count(branch_domain),
            })
        
        # Sort by net profit (descending)
        branch_data.sort(key=lambda x: x['net_profit'], reverse=True)
        
        return {
            'company': self.company_id.name,
            'period': f"{self.date_from} to {self.date_to}",
            'branch_data': branch_data,
            'summary': {
                'total_income': sum(b['income'] for b in branch_data),
                'total_expense': sum(b['expense'] for b in branch_data),
                'total_net_profit': sum(b['net_profit'] for b in branch_data),
                'best_performing': branch_data[0] if branch_data else None,
                'worst_performing': branch_data[-1] if branch_data else None,
            }
        }
    
    def _get_bu_detail_data(self, domain, branches):
        """Get P&L data broken down by business unit."""
        MoveLine = self.env['account.move.line']
        
        # Get all BUs in selected branches
        branch_ids = branches.ids if branches else []
        bus = self.env['ops.business.unit'].search([
            ('branch_ids', 'in', branch_ids)
        ]) if branch_ids else self.env['ops.business.unit'].search([
            ('company_ids', 'in', [self.company_id.id])
        ])
        
        bu_data = []
        for bu in bus:
            bu_domain = domain + [('ops_business_unit_id', '=', bu.id)]
            
            # Get income for BU
            income_domain = bu_domain + [
                ('account_id.account_type', 'in', ['income', 'income_other'])
            ]
            income_result = MoveLine._read_group(
                income_domain,
                [],
                ['credit:sum', 'debit:sum']
            )
            bu_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
            
            # Get expense for BU
            expense_domain = bu_domain + [
                ('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])
            ]
            expense_result = MoveLine._read_group(
                expense_domain,
                [],
                ['debit:sum', 'credit:sum']
            )
            bu_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
            
            # Get branches where this BU operates
            bu_branches = bu.branch_ids.filtered(lambda b: b.id in branch_ids) if branch_ids else bu.branch_ids
            
            bu_data.append({
                'bu_id': bu.id,
                'bu_code': bu.code,
                'bu_name': bu.name,
                'income': bu_income,
                'expense': bu_expense,
                'net_profit': bu_income - bu_expense,
                'branch_count': len(bu_branches),
                'branch_names': ', '.join(bu_branches.mapped('code')),
                'profitability_ratio': (bu_income - bu_expense) / bu_income * 100 if bu_income else 0,
            })
        
        # Sort by profitability ratio (descending)
        bu_data.sort(key=lambda x: x['profitability_ratio'], reverse=True)
        
        return {
            'company': self.company_id.name,
            'period': f"{self.date_from} to {self.date_to}",
            'bu_data': bu_data,
            'summary': {
                'total_income': sum(b['income'] for b in bu_data),
                'total_expense': sum(b['expense'] for b in bu_data),
                'total_net_profit': sum(b['net_profit'] for b in bu_data),
                'most_profitable': bu_data[0] if bu_data else None,
                'least_profitable': bu_data[-1] if bu_data else None,
            }
        }
    
    def _get_account_detail_data(self, domain, branches):
        """Get detailed P&L data by account group."""
        MoveLine = self.env['account.move.line']
        
        # Define account types for P&L
        account_types = [
            ('income', 'Revenue'),
            ('income_other', 'Other Income'),
            ('expense_direct_cost', 'Cost of Goods Sold'),
            ('expense', 'Operating Expenses'),
            ('expense_depreciation', 'Depreciation'),
        ]
        
        account_data = []
        for acc_type, acc_name in account_types:
            type_domain = domain + [('account_id.account_type', '=', acc_type)]
            
            # Get sum for this account type
            result = MoveLine._read_group(
                type_domain,
                ['account_id'],
                ['debit:sum', 'credit:sum', 'balance:sum']
            )
            
            total_debit = sum(item['debit'] for item in result)
            total_credit = sum(item['credit'] for item in result)
            
            if acc_type.startswith('income'):
                amount = total_credit - total_debit
            else:
                amount = total_debit - total_credit
            
            # Get top 5 accounts in this type
            top_accounts = []
            for item in result:
                if item.get('account_id'):
                    account = self.env['account.account'].browse(item['account_id'][0])
                    top_accounts.append({
                        'account_code': account.code,
                        'account_name': account.name,
                        'amount': item['credit'] - item['debit'] if acc_type.startswith('income') else item['debit'] - item['credit'],
                    })
            
            # Sort top accounts
            top_accounts.sort(key=lambda x: abs(x['amount']), reverse=True)
            
            account_data.append({
                'account_type': acc_type,
                'account_type_name': acc_name,
                'total_amount': amount,
                'top_accounts': top_accounts[:5],
                'account_count': len(result),
            })
        
        return {
            'company': self.company_id.name,
            'period': f"{self.date_from} to {self.date_to}",
            'account_data': account_data,
            'branches': len(branches),
        }
    
    def _get_comparison_data(self):
        """Get comparison data with previous period."""
        MoveLine = self.env['account.move.line']
        
        previous_domain = [
            ('date', '>=', self.previous_date_from),
            ('date', '<=', self.previous_date_to),
            ('company_id', '=', self.company_id.id),
            ('move_id.state', '=', 'posted'),
        ]
        
        if self.branch_ids:
            previous_domain.append(('ops_branch_id', 'in', self.branch_ids.ids))
        
        # Get previous period totals
        income_result = MoveLine._read_group(
            previous_domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
            [],
            ['credit:sum', 'debit:sum']
        )
        previous_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
        
        expense_result = MoveLine._read_group(
            previous_domain + [('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])],
            [],
            ['debit:sum', 'credit:sum']
        )
        previous_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
        
        previous_net = previous_income - previous_expense
        
        return {
            'previous_income': previous_income,
            'previous_expense': previous_expense,
            'previous_net_profit': previous_net,
            'period': f"{self.previous_date_from} to {self.previous_date_to}",
        }
    
    def _get_branch_performance_summary(self, branches, domain):
        """Get high-level branch performance summary."""
        MoveLine = self.env['account.move.line']
        
        performance = []
        for branch in branches[:10]:  # Limit to top 10 for summary
            branch_domain = domain + [('ops_branch_id', '=', branch.id)]
            
            income_result = MoveLine._read_group(
                branch_domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
                [],
                ['credit:sum', 'debit:sum']
            )
            branch_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
            
            performance.append({
                'branch_code': branch.code,
                'branch_name': branch.name,
                'income': branch_income,
                'bu_count': len(branch.business_unit_ids),
            })
        
        return performance
    
    # Action Methods
    def action_generate_pdf(self):
        """Generate PDF report."""
        self.ensure_one()
        return self.env.ref('ops_matrix_accounting.report_company_consolidation_pdf').report_action(self)
    
    def action_generate_xlsx(self):
        """Generate Excel report."""
        self.ensure_one()
        return self.env.ref('ops_matrix_accounting.report_company_consolidation_xlsx').report_action(self)
    
    def action_view_branch_details(self, branch_id):
        """Drill down to branch report."""
        self.ensure_one()
        return {
            'name': _('Branch Report'),
            'type': 'ir.actions.act_window',
            'res_model': 'ops.branch.report',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_branch_id': branch_id,
                'default_date_from': self.date_from,
                'default_date_to': self.date_to,
            }
        }
    
    def action_view_bu_details(self, bu_id):
        """Drill down to BU report."""
        self.ensure_one()
        return {
            'name': _('Business Unit Report'),
            'type': 'ir.actions.act_window',
            'res_model': 'ops.business.unit.report',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_business_unit_id': bu_id,
                'default_date_from': self.date_from,
                'default_date_to': self.date_to,
            }
        }


class OpsBranchReport(models.TransientModel):
    """Branch-Level Profit & Loss Report"""
    _name = 'ops.branch.report'
    _description = 'Branch-Level Profit & Loss Report'
    
    # Filter Fields
    branch_id = fields.Many2one(
        'ops.branch',
        string='Branch',
        required=True,
        domain="[('company_id', 'in', company_ids)]"
    )
    date_from = fields.Date(
        string='From Date',
        required=True,
        default=lambda self: date_utils.start_of(datetime.now(), 'month')
    )
    date_to = fields.Date(
        string='To Date',
        required=True,
        default=lambda self: date_utils.end_of(datetime.now(), 'month')
    )
    
    # BU Filtering
    business_unit_ids = fields.Many2many(
        'ops.business.unit',
        string='Filter Business Units',
        domain="[('branch_ids', 'in', [branch_id])]"
    )
    
    # Report Data
    report_data = fields.Json(
        string='Report Data',
        compute='_compute_report_data',
        store=False
    )
    
    @api.depends('branch_id', 'date_from', 'date_to', 'business_unit_ids')
    def _compute_report_data(self):
        """Compute branch-level P&L report."""
        for wizard in self:
            if not wizard.branch_id or not wizard.date_from or not wizard.date_to:
                wizard.report_data = {}
                continue
            
            MoveLine = self.env['account.move.line']
            base_domain = [
                ('date', '>=', wizard.date_from),
                ('date', '<=', wizard.date_to),
                ('ops_branch_id', '=', wizard.branch_id.id),
                ('move_id.state', '=', 'posted'),
            ]
            
            # Apply BU filter if specified
            if wizard.business_unit_ids:
                base_domain.append(('ops_business_unit_id', 'in', wizard.business_unit_ids.ids))
            
            # Get BU performance data
            bu_performance = {}
            bus = wizard.business_unit_ids if wizard.business_unit_ids else wizard.branch_id.business_unit_ids
            
            for bu in bus:
                bu_domain = base_domain + [('ops_business_unit_id', '=', bu.id)]
                
                # Income for this BU
                income_result = MoveLine._read_group(
                    bu_domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
                    [],
                    ['credit:sum', 'debit:sum']
                )
                bu_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
                
                # Expense for this BU
                expense_result = MoveLine._read_group(
                    bu_domain + [('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])],
                    [],
                    ['debit:sum', 'credit:sum']
                )
                bu_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
                
                bu_performance[bu.id] = {
                    'bu_id': bu.id,
                    'bu_code': bu.code,
                    'bu_name': bu.name,
                    'income': bu_income,
                    'expense': bu_expense,
                    'net_profit': bu_income - bu_expense,
                    'margin': ((bu_income - bu_expense) / bu_income * 100) if bu_income else 0,
                    'transaction_count': MoveLine.search_count(bu_domain),
                }
            
            # Get branch totals
            income_result = MoveLine._read_group(
                base_domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
                [],
                ['credit:sum', 'debit:sum']
            )
            total_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
            
            expense_result = MoveLine._read_group(
                base_domain + [('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])],
                [],
                ['debit:sum', 'credit:sum']
            )
            total_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
            
            # Get top products/services (if sale/purchase modules installed)
            top_products = []
            if 'sale.order.line' in self.env:
                try:
                    sale_lines = self.env['sale.order.line'].search([
                        ('order_id.ops_branch_id', '=', wizard.branch_id.id),
                        ('order_id.date_order', '>=', wizard.date_from),
                        ('order_id.date_order', '<=', wizard.date_to),
                        ('order_id.state', 'in', ['sale', 'done']),
                    ], limit=10)
                    
                    for line in sale_lines:
                        top_products.append({
                            'product': line.product_id.name if line.product_id else 'N/A',
                            'quantity': line.product_uom_qty,
                            'revenue': line.price_subtotal,
                        })
                except Exception as e:
                    _logger.warning(f"Could not fetch sale order lines: {e}")
            
            wizard.report_data = {
                'branch': wizard.branch_id.name,
                'branch_code': wizard.branch_id.code,
                'company': wizard.branch_id.company_id.name,
                'period': f"{wizard.date_from} to {wizard.date_to}",
                'bu_performance': list(bu_performance.values()),
                'totals': {
                    'total_income': total_income,
                    'total_expense': total_expense,
                    'net_profit': total_income - total_expense,
                    'bu_count': len(bus),
                    'transaction_count': MoveLine.search_count(base_domain),
                },
                'top_products': top_products[:5],
            }
    
    def action_generate_pdf(self):
        """Generate PDF report for branch."""
        self.ensure_one()
        return self.env.ref('ops_matrix_accounting.report_branch_pl_pdf').report_action(self)


class OpsBusinessUnitReport(models.TransientModel):
    """Business Unit Profitability Report"""
    _name = 'ops.business.unit.report'
    _description = 'Business Unit Profitability Report'
    
    # Filter Fields
    business_unit_id = fields.Many2one(
        'ops.business.unit',
        string='Business Unit',
        required=True,
        domain="[('company_ids', 'in', company_ids)]"
    )
    date_from = fields.Date(
        string='From Date',
        required=True,
        default=lambda self: date_utils.start_of(datetime.now(), 'month')
    )
    date_to = fields.Date(
        string='To Date',
        required=True,
        default=lambda self: date_utils.end_of(datetime.now(), 'month')
    )
    
    # Branch Filtering
    branch_ids = fields.Many2many(
        'ops.branch',
        string='Filter Branches',
        domain="[('id', 'in', business_unit_branch_ids)]"
    )
    
    business_unit_branch_ids = fields.Many2many(
        'ops.branch',
        compute='_compute_business_unit_branch_ids',
        store=False
    )
    
    # Include branch consolidation
    consolidate_by_branch = fields.Boolean(
        string='Show Branch Breakdown',
        default=True
    )
    
    # Report Data
    report_data = fields.Json(
        string='Report Data',
        compute='_compute_report_data',
        store=False
    )
    
    @api.depends('business_unit_id')
    def _compute_business_unit_branch_ids(self):
        """Compute available branches for the selected business unit."""
        for wizard in self:
            if wizard.business_unit_id:
                wizard.business_unit_branch_ids = wizard.business_unit_id.branch_ids
            else:
                wizard.business_unit_branch_ids = False
    
    @api.depends('business_unit_id', 'date_from', 'date_to', 'branch_ids', 'consolidate_by_branch')
    def _compute_report_data(self):
        """Compute BU performance across branches."""
        for wizard in self:
            if not wizard.business_unit_id or not wizard.date_from or not wizard.date_to:
                wizard.report_data = {}
                continue
            
            MoveLine = self.env['account.move.line']
            base_domain = [
                ('date', '>=', wizard.date_from),
                ('date', '<=', wizard.date_to),
                ('ops_business_unit_id', '=', wizard.business_unit_id.id),
                ('move_id.state', '=', 'posted'),
            ]
            
            # Apply branch filter if specified
            branches = wizard.branch_ids if wizard.branch_ids else wizard.business_unit_id.branch_ids
            if wizard.branch_ids:
                base_domain.append(('ops_branch_id', 'in', wizard.branch_ids.ids))
            
            # Branch performance breakdown
            branch_performance = {}
            if wizard.consolidate_by_branch:
                for branch in branches:
                    branch_domain = base_domain + [('ops_branch_id', '=', branch.id)]
                    
                    # Income for this branch
                    income_result = MoveLine._read_group(
                        branch_domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
                        [],
                        ['credit:sum', 'debit:sum']
                    )
                    branch_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
                    
                    # Expense for this branch
                    expense_result = MoveLine._read_group(
                        branch_domain + [('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])],
                        [],
                        ['debit:sum', 'credit:sum']
                    )
                    branch_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
                    
                    branch_performance[branch.id] = {
                        'branch_id': branch.id,
                        'branch_code': branch.code,
                        'branch_name': branch.name,
                        'income': branch_income,
                        'expense': branch_expense,
                        'net_profit': branch_income - branch_expense,
                        'contribution_percentage': 0,  # Will calculate after totals
                        'transaction_count': MoveLine.search_count(branch_domain),
                    }
            
            # Get BU totals
            income_result = MoveLine._read_group(
                base_domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
                [],
                ['credit:sum', 'debit:sum']
            )
            total_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
            
            expense_result = MoveLine._read_group(
                base_domain + [('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])],
                [],
                ['debit:sum', 'credit:sum']
            )
            total_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
            
            total_net = total_income - total_expense
            
            # Calculate contribution percentages
            for branch_id, data in branch_performance.items():
                if total_income > 0:
                    data['contribution_percentage'] = (data['income'] / total_income * 100)
                else:
                    data['contribution_percentage'] = 0
            
            # Sort branches by contribution (descending)
            sorted_branches = sorted(
                branch_performance.values(),
                key=lambda x: x['contribution_percentage'],
                reverse=True
            )
            
            wizard.report_data = {
                'business_unit': wizard.business_unit_id.name,
                'business_unit_code': wizard.business_unit_id.code,
                'primary_branch': wizard.business_unit_id.primary_branch_id.name if wizard.business_unit_id.primary_branch_id else 'None',
                'period': f"{wizard.date_from} to {wizard.date_to}",
                'branch_performance': sorted_branches,
                'totals': {
                    'total_income': total_income,
                    'total_expense': total_expense,
                    'net_profit': total_net,
                    'profit_margin': (total_net / total_income * 100) if total_income else 0,
                    'branch_count': len(branches),
                    'active_branches': len([b for b in branch_performance.values() if b['transaction_count'] > 0]),
                    'total_transactions': MoveLine.search_count(base_domain),
                },
                'trend_data': wizard._get_trend_data(),
            }
    
    def _get_trend_data(self):
        """Get monthly trend data for the past 6 months."""
        MoveLine = self.env['account.move.line']
        trend_data = []
        
        for i in range(6, -1, -1):  # Last 6 months plus current
            month_start = date_utils.start_of(datetime.now() - timedelta(days=30*i), 'month')
            month_end = date_utils.end_of(month_start, 'month')
            
            domain = [
                ('date', '>=', month_start),
                ('date', '<=', month_end),
                ('ops_business_unit_id', '=', self.business_unit_id.id),
                ('move_id.state', '=', 'posted'),
            ]
            
            if self.branch_ids:
                domain.append(('ops_branch_id', 'in', self.branch_ids.ids))
            
            income_result = MoveLine._read_group(
                domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
                [],
                ['credit:sum', 'debit:sum']
            )
            month_income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
            
            expense_result = MoveLine._read_group(
                domain + [('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])],
                [],
                ['debit:sum', 'credit:sum']
            )
            month_expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
            
            trend_data.append({
                'month': month_start.strftime('%b %Y'),
                'income': month_income,
                'expense': month_expense,
                'net_profit': month_income - month_expense,
                'transaction_count': MoveLine.search_count(domain),
            })
        
        return trend_data
    
    def action_generate_pdf(self):
        """Generate PDF report for business unit."""
        self.ensure_one()
        return self.env.ref('ops_matrix_accounting.report_business_unit_pdf').report_action(self)


class OpsConsolidatedBalanceSheet(models.TransientModel):
    """Group-Level Balance Sheet Consolidation"""
    _name = 'ops.consolidated.balance.sheet'
    _description = 'Group-Level Balance Sheet Consolidation'
    
    # Company Selection
    company_ids = fields.Many2many(
        'res.company',
        string='Companies',
        required=True,
        default=lambda self: self.env.company
    )
    
    # Date for balance sheet
    date = fields.Date(
        string='As of Date',
        required=True,
        default=fields.Date.today
    )
    
    # Consolidation Options
    include_intercompany = fields.Boolean(
        string='Include Intercompany Eliminations',
        default=True
    )
    
    currency_id = fields.Many2one(
        'res.currency',
        string='Reporting Currency',
        default=lambda self: self.env.company.currency_id
    )
    
    # Report Data
    report_data = fields.Json(
        string='Report Data',
        compute='_compute_report_data',
        store=False
    )
    
    @api.depends('company_ids', 'date', 'include_intercompany', 'currency_id')
    def _compute_report_data(self):
        """Compute consolidated balance sheet for multiple companies."""
        for wizard in self:
            if not wizard.company_ids or not wizard.date:
                wizard.report_data = {}
                continue
            
            MoveLine = self.env['account.move.line']
            
            # Get balance sheet data for each company
            company_data = []
            total_assets = total_liabilities = total_equity = 0
            
            for company in wizard.company_ids:
                domain = [
                    ('date', '<=', wizard.date),
                    ('company_id', '=', company.id),
                    ('move_id.state', '=', 'posted'),
                    ('account_id.include_initial_balance', '=', True),
                ]
                
                # Group by account type
                grouped_data = MoveLine._read_group(
                    domain,
                    ['account_id'],
                    ['balance:sum']
                )
                
                # Initialize totals
                assets = liabilities = equity = income = expense = 0
                
                for group in grouped_data:
                    if group.get('account_id'):
                        account = self.env['account.account'].browse(group['account_id'][0])
                        balance = group.get('balance', 0)
                        
                        if account.account_type and account.account_type.startswith('asset'):
                            assets += balance
                        elif account.account_type and account.account_type.startswith('liability'):
                            liabilities += balance
                        elif account.account_type == 'equity':
                            equity += balance
                        elif account.account_type in ['income', 'income_other']:
                            income += balance
                        elif account.account_type in ['expense', 'expense_depreciation', 'expense_direct_cost']:
                            expense += balance
                
                # Calculate net income/loss for period
                net_income = income + expense  # Expense is negative in accounting
                
                company_data.append({
                    'company_id': company.id,
                    'company_name': company.name,
                    'company_code': company.ops_code if hasattr(company, 'ops_code') else company.name,
                    'assets': assets,
                    'liabilities': liabilities,
                    'equity': equity + net_income,  # Include current year profit/loss
                    'net_income': net_income,
                    'currency': company.currency_id.name,
                })
                
                # Accumulate totals
                total_assets += assets
                total_liabilities += liabilities
                total_equity += equity + net_income
            
            # Apply intercompany eliminations if requested
            eliminations = {'asset_eliminations': 0, 'liability_eliminations': 0}
            if wizard.include_intercompany and len(wizard.company_ids) > 1:
                eliminations = wizard._calculate_intercompany_eliminations(wizard.company_ids.ids, wizard.date)
                total_assets -= eliminations.get('asset_eliminations', 0)
                total_liabilities -= eliminations.get('liability_eliminations', 0)
            
            wizard.report_data = {
                'report_date': str(wizard.date),
                'companies': company_data,
                'consolidated': {
                    'total_assets': total_assets,
                    'total_liabilities': total_liabilities,
                    'total_equity': total_equity,
                    'balance_check': total_assets - (total_liabilities + total_equity),
                },
                'eliminations': eliminations,
                'reporting_currency': wizard.currency_id.name,
                'company_count': len(wizard.company_ids),
            }
    
    def _calculate_intercompany_eliminations(self, company_ids, date):
        """Calculate intercompany eliminations for consolidation."""
        MoveLine = self.env['account.move.line']
        
        # Find intercompany accounts (accounts marked as intercompany)
        intercompany_accounts = self.env['account.account'].search([
            ('company_id', 'in', company_ids),
            ('reconcile', '=', True),  # Use reconcile flag as proxy for intercompany
        ])
        
        asset_eliminations = 0
        liability_eliminations = 0
        
        for account in intercompany_accounts:
            if 'intercompany' not in account.name.lower():
                continue
                
            domain = [
                ('date', '<=', date),
                ('account_id', '=', account.id),
                ('company_id', 'in', company_ids),
                ('move_id.state', '=', 'posted'),
            ]
            
            result = MoveLine._read_group(
                domain,
                ['company_id'],
                ['balance:sum']
            )
            
            # Sum balances across companies
            total_balance = sum(item.get('balance', 0) for item in result)
            
            # If total balance across companies is not zero, there's an elimination
            if abs(total_balance) > 0.01:  # Tolerance for floating point
                if account.account_type and account.account_type.startswith('asset'):
                    asset_eliminations += total_balance
                elif account.account_type and account.account_type.startswith('liability'):
                    liability_eliminations += total_balance
        
        return {
            'asset_eliminations': asset_eliminations,
            'liability_eliminations': liability_eliminations,
        }
    
    def action_generate_pdf(self):
        """Generate PDF consolidated balance sheet."""
        self.ensure_one()
        return self.env.ref('ops_matrix_accounting.report_consolidated_balance_sheet_pdf').report_action(self)


class OpsMatrixProfitabilityAnalysis(models.TransientModel):
    """Matrix Profitability Analysis (Branch x BU)"""
    _name = 'ops.matrix.profitability.analysis'
    _description = 'Matrix Profitability Analysis (Branch x BU)'
    
    # Filter Fields
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        required=True,
        default=lambda self: self.env.company
    )
    date_from = fields.Date(
        string='From Date',
        required=True,
        default=lambda self: date_utils.start_of(datetime.now(), 'month')
    )
    date_to = fields.Date(
        string='To Date',
        required=True,
        default=lambda self: date_utils.end_of(datetime.now(), 'month')
    )
    
    # Report Data
    matrix_data = fields.Json(
        string='Matrix Data',
        compute='_compute_matrix_data',
        store=False
    )
    
    @api.depends('company_id', 'date_from', 'date_to')
    def _compute_matrix_data(self):
        """Compute profitability matrix across branches and BUs."""
        for wizard in self:
            if not wizard.company_id or not wizard.date_from or not wizard.date_to:
                wizard.matrix_data = {}
                continue
            
            MoveLine = self.env['account.move.line']
            
            # Get all branches and BUs for the company
            branches = self.env['ops.branch'].search([
                ('company_id', '=', wizard.company_id.id),
                ('active', '=', True)
            ])
            
            bus = self.env['ops.business.unit'].search([
                ('company_ids', 'in', [wizard.company_id.id]),
                ('active', '=', True)
            ])
            
            # Initialize matrix
            matrix = {}
            branch_totals = {branch.id: {'income': 0, 'expense': 0} for branch in branches}
            bu_totals = {bu.id: {'income': 0, 'expense': 0} for bu in bus}
            
            # Populate matrix with data
            for branch in branches:
                for bu in bus:
                    key = f"{branch.id}-{bu.id}"
                    
                    # Check if BU operates in this branch
                    if branch in bu.branch_ids:
                        domain = [
                            ('date', '>=', wizard.date_from),
                            ('date', '<=', wizard.date_to),
                            ('ops_branch_id', '=', branch.id),
                            ('ops_business_unit_id', '=', bu.id),
                            ('move_id.state', '=', 'posted'),
                        ]
                        
                        # Get income
                        income_result = MoveLine._read_group(
                            domain + [('account_id.account_type', 'in', ['income', 'income_other'])],
                            [],
                            ['credit:sum', 'debit:sum']
                        )
                        income = income_result[0]['credit'] - income_result[0]['debit'] if income_result else 0
                        
                        # Get expense
                        expense_result = MoveLine._read_group(
                            domain + [('account_id.account_type', 'in', ['expense', 'expense_depreciation', 'expense_direct_cost'])],
                            [],
                            ['debit:sum', 'credit:sum']
                        )
                        expense = expense_result[0]['debit'] - expense_result[0]['credit'] if expense_result else 0
                        
                        net_profit = income - expense
                        
                        matrix[key] = {
                            'branch_id': branch.id,
                            'branch_code': branch.code,
                            'branch_name': branch.name,
                            'bu_id': bu.id,
                            'bu_code': bu.code,
                            'bu_name': bu.name,
                            'income': income,
                            'expense': expense,
                            'net_profit': net_profit,
                            'profitability': (net_profit / income * 100) if income else 0,
                            'transaction_count': MoveLine.search_count(domain),
                        }
                        
                        # Update totals
                        branch_totals[branch.id]['income'] += income
                        branch_totals[branch.id]['expense'] += expense
                        bu_totals[bu.id]['income'] += income
                        bu_totals[bu.id]['expense'] += expense
            
            # Calculate overall totals
            total_income = sum(data['income'] for data in matrix.values())
            total_expense = sum(data['expense'] for data in matrix.values())
            total_net = total_income - total_expense
            
            # Find top performing combinations
            matrix_values = list(matrix.values())
            matrix_values.sort(key=lambda x: x['net_profit'], reverse=True)
            top_performers = matrix_values[:5]
            bottom_performers = matrix_values[-5:] if len(matrix_values) >= 5 else []
            
            wizard.matrix_data = {
                'company': wizard.company_id.name,
                'period': f"{wizard.date_from} to {wizard.date_to}",
                'matrix': matrix_values,
                'branch_totals': branch_totals,
                'bu_totals': bu_totals,
                'summary': {
                    'total_income': total_income,
                    'total_expense': total_expense,
                    'total_net_profit': total_net,
                    'total_combinations': len(matrix),
                    'active_combinations': len([m for m in matrix_values if m['transaction_count'] > 0]),
                    'top_performers': top_performers,
                    'bottom_performers': bottom_performers,
                    'average_profitability': sum(m['profitability'] for m in matrix_values) / len(matrix_values) if matrix_values else 0,
                },
            }
    
    def action_generate_heatmap(self):
        """Generate heatmap visualization data."""
        self.ensure_one()
        
        # Convert matrix data to heatmap format
        heatmap_data = []
        for item in self.matrix_data.get('matrix', []):
            heatmap_data.append({
                'x': item['branch_code'],
                'y': item['bu_code'],
                'value': item['profitability'],
                'income': item['income'],
                'expense': item['expense'],
                'net': item['net_profit'],
            })
        
        return {
            'type': 'ir.actions.client',
            'tag': 'ops_matrix_heatmap',
            'params': {
                'title': f'Profitability Matrix - {self.company_id.name}',
                'data': heatmap_data,
                'period': f"{self.date_from} to {self.date_to}",
            }
        }

=== FILE: addons/ops_matrix_accounting/models/__init__.py ===

from . import ops_pdc
from . import ops_budget
from . import ops_product_category_defaults
from . import ops_matrix_standard_extensions
from . import ops_consolidated_reporting

=== FILE: addons/ops_matrix_accounting/models/ops_budget.py ===

from odoo import models, fields, api
from odoo.exceptions import ValidationError
from psycopg2 import sql

class OpsBudget(models.Model):
    _name = 'ops.budget'
    _description = 'Matrix Budget Control'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'date_from desc, id desc'

    name = fields.Char(string='Budget Name', required=True, tracking=True)
    active = fields.Boolean(default=True)
    
    # Matrix Dimensions (Required)
    ops_branch_id = fields.Many2one(
        'res.company',
        string='Branch',
        required=True,
        tracking=True,
        help="Branch this budget applies to"
    )
    ops_business_unit_id = fields.Many2one(
        'ops.business.unit',
        string='Business Unit',
        required=True,
        tracking=True,
        help="Business unit this budget applies to"
    )
    
    # Date Range
    date_from = fields.Date(string='Start Date', required=True, tracking=True)
    date_to = fields.Date(string='End Date', required=True, tracking=True)
    
    # Budget Status
    state = fields.Selection([
        ('draft', 'Draft'),
        ('confirmed', 'Confirmed'),
        ('done', 'Closed'),
        ('cancelled', 'Cancelled')
    ], string='Status', default='draft', tracking=True)
    
    # Budget Lines
    line_ids = fields.One2many('ops.budget.line', 'budget_id', string='Budget Lines')
    
    # Totals
    total_planned = fields.Monetary(
        string='Total Planned',
        compute='_compute_totals',
        store=True
    )
    total_practical = fields.Monetary(
        string='Total Actual',
        compute='_compute_totals',
        store=True
    )
    total_committed = fields.Monetary(
        string='Total Committed',
        compute='_compute_totals',
        store=True
    )
    available_balance = fields.Monetary(
        string='Available Balance',
        compute='_compute_totals',
        store=True
    )
    currency_id = fields.Many2one(
        'res.currency',
        string='Currency',
        required=True,
        default=lambda self: self.env.company.currency_id
    )

    _unique_matrix_budget = models.Constraint(
        'unique(ops_branch_id, ops_business_unit_id, date_from, date_to)',
        'A budget already exists for this Branch/Business Unit combination in the specified date range!'
    )

    @api.constrains('date_from', 'date_to')
    def _check_dates(self):
        for budget in self:
            if budget.date_to < budget.date_from:
                raise ValidationError('End Date must be after Start Date')

            # Check for overlapping date ranges
            overlapping = self.search([
                ('id', '!=', budget.id),
                ('ops_branch_id', '=', budget.ops_branch_id.id),
                ('ops_business_unit_id', '=', budget.ops_business_unit_id.id),
                ('date_from', '<=', budget.date_to),
                ('date_to', '>=', budget.date_from)
            ])
            if overlapping:
                raise ValidationError(
                    'Budget dates overlap with existing budget(s) for the same Branch/Business Unit!'
                )

    @api.depends('line_ids.planned_amount', 'line_ids.practical_amount', 'line_ids.committed_amount')
    def _compute_totals(self):
        for budget in self:
            budget.total_planned = sum(budget.line_ids.mapped('planned_amount'))
            budget.total_practical = sum(budget.line_ids.mapped('practical_amount'))
            budget.total_committed = sum(budget.line_ids.mapped('committed_amount'))
            budget.available_balance = budget.total_planned - budget.total_practical - budget.total_committed

    def action_confirm(self):
        self.write({'state': 'confirmed'})

    def action_done(self):
        self.write({'state': 'done'})

    def action_cancel(self):
        self.write({'state': 'cancelled'})

    def action_draft(self):
        self.write({'state': 'draft'})

    @api.model
    def check_budget_availability(self, account_id, ops_branch_id, ops_business_unit_id, amount):
        """Check if sufficient budget is available for a planned expense.
        
        Args:
            account_id: The expense account to check
            ops_branch_id: The branch requesting the expense
            ops_business_unit_id: The business unit requesting the expense
            amount: The amount to check
            
        Returns:
            bool: True if sufficient budget exists, False otherwise
        """
        domain = [
            ('state', '=', 'confirmed'),
            ('ops_branch_id', '=', ops_branch_id),
            ('ops_business_unit_id', '=', ops_business_unit_id),
            ('date_from', '<=', fields.Date.today()),
            ('date_to', '>=', fields.Date.today())
        ]
        
        active_budget = self.search(domain, limit=1)
        if not active_budget:
            return False
            
        budget_line = active_budget.line_ids.filtered(
            lambda l: l.general_account_id.id == account_id
        )
        if not budget_line:
            return False
            
        available = budget_line.planned_amount - budget_line.practical_amount - budget_line.committed_amount
        return available >= amount


class OpsBudgetLine(models.Model):
    _name = 'ops.budget.line'
    _description = 'Matrix Budget Line'
    _order = 'general_account_id'

    budget_id = fields.Many2one('ops.budget', string='Budget', required=True, ondelete='cascade')
    general_account_id = fields.Many2one(
        'account.account',
        string='Expense Account',
        required=True,
        domain=[('account_type', '=', 'expense')]
    )
    
    planned_amount = fields.Monetary(string='Planned Amount', required=True)
    practical_amount = fields.Monetary(string='Actual Amount', compute='_compute_practical_amount', store=True)
    committed_amount = fields.Monetary(string='Committed Amount', compute='_compute_committed_amount', store=True)
    available_amount = fields.Monetary(string='Available Amount', compute='_compute_available_amount', store=True)
    
    currency_id = fields.Many2one(related='budget_id.currency_id')
    company_id = fields.Many2one(related='budget_id.ops_branch_id.company_id')

    _unique_account_per_budget = models.Constraint(
        'unique(budget_id, general_account_id)',
        'You can only have one budget line per account!'
    )

    @api.depends('planned_amount', 'practical_amount', 'committed_amount')
    def _compute_available_amount(self):
        for line in self:
            line.available_amount = line.planned_amount - line.practical_amount - line.committed_amount

    def _compute_practical_amount(self):
        """Compute actual spend from account moves."""
        for line in self:
            domain = [
                ('account_id', '=', line.general_account_id.id),
                ('ops_branch_id', '=', line.budget_id.ops_branch_id.id),
                ('ops_business_unit_id', '=', line.budget_id.ops_business_unit_id.id),
                ('date', '>=', line.budget_id.date_from),
                ('date', '<=', line.budget_id.date_to),
                ('move_id.state', '=', 'posted'),
                ('move_id.move_type', 'in', ['in_invoice', 'in_refund'])
            ]
            
            amount = sum(self.env['account.move.line'].search(domain).mapped('debit'))
            line.practical_amount = amount

    def _compute_committed_amount(self):
        """Compute committed amount from purchase orders."""
        for line in self:
            domain = [
                ('account_id', '=', line.general_account_id.id),
                ('order_id.ops_branch_id', '=', line.budget_id.ops_branch_id.id),
                ('order_id.ops_business_unit_id', '=', line.budget_id.ops_business_unit_id.id),
                ('order_id.date_order', '>=', line.budget_id.date_from),
                ('order_id.date_order', '<=', line.budget_id.date_to),
                ('order_id.state', 'in', ['purchase', 'done']),
                ('invoice_status', '!=', 'invoiced')
            ]
            
            amount = sum(self.env['purchase.order.line'].search(domain).mapped('price_total'))
            line.committed_amount = amount

=== FILE: addons/ops_matrix_accounting/models/ops_product_category_defaults.py ===

from odoo import models, fields, api

class OpsProductCategory(models.Model):
    _inherit = 'product.category'

    # Override inventory valuation fields to enforce defaults
    property_cost_method = fields.Selection(
        default='fifo',
        readonly=True,
        help="FIFO costing method enforced by Matrix Operations"
    )
    
    property_valuation = fields.Selection(
        default='real_time',
        readonly=True,
        help="Real-time valuation enforced by Matrix Operations"
    )

    @api.constrains('property_cost_method', 'property_valuation')
    def _check_accounting_fields_not_empty(self):
        """Ensure costing and valuation methods are always set."""
        for record in self:
            if not record.property_cost_method:
                record.property_cost_method = 'fifo'
            if not record.property_valuation:
                record.property_valuation = 'real_time'

    @api.model
    def default_get(self, fields_list):
        """Override to auto-populate accounting fields with smart defaults."""
        defaults = super().default_get(fields_list)
        
        try:
            company = self.env.company
            account_obj = self.env['account.account']

            # Helper function to find accounts - simplified for Odoo 19 compatibility
            def find_account(fallback_type=None):
                if fallback_type:
                    try:
                        account = account_obj.search([
                            ('account_type', '=', fallback_type)
                        ], limit=1)
                        return account.id if account else False
                    except Exception:
                        pass
                return False

            # 1. Income Account (Sales)
            if 'property_account_income_categ_id' in fields_list:
                income_account = find_account(fallback_type='income')
                defaults['property_account_income_categ_id'] = income_account

            # 2. Expense Account (COGS)
            if 'property_account_expense_categ_id' in fields_list:
                expense_account = find_account(fallback_type='expense')
                defaults['property_account_expense_categ_id'] = expense_account

            # 3. Stock Valuation Account
            if 'property_stock_valuation_account_id' in fields_list:
                valuation_account = find_account(fallback_type='asset_current')
                defaults['property_stock_valuation_account_id'] = valuation_account

            # 4. Stock Input Account
            if 'property_stock_account_input_categ_id' in fields_list:
                input_account = find_account(fallback_type='asset_current')
                defaults['property_stock_account_input_categ_id'] = input_account

            # 5. Stock Output Account
            if 'property_stock_account_output_categ_id' in fields_list:
                output_account = find_account(fallback_type='asset_current')
                defaults['property_stock_account_output_categ_id'] = output_account

        except Exception:
            # Gracefully fall back if account lookup fails
            pass

        return defaults


class OpsProductTemplate(models.Model):
    _inherit = 'product.template'

    @api.model
    def default_get(self, fields_list):
        """Ensure products inherit category defaults properly."""
        defaults = super().default_get(fields_list)
        
        # If no category specified, find or create the default category
        if not defaults.get('categ_id'):
            default_category = self.env['product.category'].search([
                ('name', '=', 'All'),
                ('parent_id', '=', False)
            ], limit=1)
            
            if not default_category:
                default_category = self.env['product.category'].create({
                    'name': 'All'
                })
            
            defaults['categ_id'] = default_category.id
        
        return defaults

    @api.onchange('categ_id')
    def _onchange_categ_id(self):
        """Ensure accounting fields are properly inherited from category."""
        if self.categ_id:
            self.property_account_income_id = False  # Force inherit from category
            self.property_account_expense_id = False  # Force inherit from category

=== FILE: addons/ops_matrix_accounting/models/ops_pdc.py ===

from odoo import models, fields, api
from odoo.exceptions import ValidationError

class OpsPostDatedCheck(models.Model):
    _name = 'ops.pdc'
    _description = 'Post-Dated Check'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'maturity_date desc, id desc'

    name = fields.Char(string='Reference', required=True, readonly=True, default='New')
    partner_id = fields.Many2one('res.partner', string='Partner', required=True)
    date = fields.Date(string='Issue Date', required=True, tracking=True)
    maturity_date = fields.Date(string='Maturity Date', required=True, tracking=True)
    amount = fields.Monetary(string='Amount', required=True)
    currency_id = fields.Many2one('res.currency', string='Currency', required=True, default=lambda self: self.env.company.currency_id)
    
    payment_type = fields.Selection([
        ('inbound', 'Customer'),
        ('outbound', 'Vendor')
    ], string='Payment Type', required=True)
    
    bank_id = fields.Many2one('res.bank', string='Bank', required=True)
    check_number = fields.Char(string='Check Number', required=True)
    
    state = fields.Selection([
        ('draft', 'Draft'),
        ('registered', 'Registered'),
        ('deposited', 'Deposited'),
        ('cleared', 'Cleared'),
        ('bounced', 'Bounced'),
        ('cancelled', 'Cancelled')
    ], string='Status', default='draft', tracking=True)

    # Matrix Dimensions
    ops_branch_id = fields.Many2one('res.company', string='Branch', required=True)
    ops_business_unit_id = fields.Many2one('ops.business.unit', string='Business Unit', required=True)
    
    # Accounting Fields
    journal_id = fields.Many2one('account.journal', string='PDC Journal', required=True, domain=[('type', '=', 'bank')])
    holding_account_id = fields.Many2one('account.account', string='PDC Holding Account', required=True)
    move_id = fields.Many2one('account.move', string='Registration Entry', readonly=True)
    deposit_move_id = fields.Many2one('account.move', string='Deposit Entry', readonly=True)

    @api.model_create_multi
    def create(self, vals_list):
        for vals in vals_list:
            if vals.get('name', 'New') == 'New':
                vals['name'] = self.env['ir.sequence'].next_by_code('ops.pdc') or 'PDC/0001'
        return super().create(vals_list)

    @api.constrains('date', 'maturity_date')
    def _check_dates(self):
        for pdc in self:
            if pdc.maturity_date < pdc.date:
                raise ValidationError('Maturity Date cannot be earlier than Issue Date.')

    def _prepare_move_line_vals(self, account_id, debit, credit, name_suffix=''):
        """Helper to prepare consistent move line values with matrix dimensions."""
        return {
            'account_id': account_id,
            'partner_id': self.partner_id.id,
            'name': f'{name_suffix} - {self.check_number}',
            'debit': debit,
            'credit': credit,
            'ops_branch_id': self.ops_branch_id.id,
            'ops_business_unit_id': self.ops_business_unit_id.id,
        }

    def action_register(self):
        """Register the PDC and create initial journal entry."""
        self.ensure_one()
        if self.state != 'draft':
            raise ValidationError('Only draft PDCs can be registered.')

        # Determine accounts based on payment type
        if self.payment_type == 'inbound':
            partner_account = self.partner_id.property_account_receivable_id
            debit_account = self.holding_account_id
            credit_account = partner_account
        else:  # outbound
            partner_account = self.partner_id.property_account_payable_id
            debit_account = partner_account
            credit_account = self.holding_account_id

        move_vals = {
            'journal_id': self.journal_id.id,
            'date': self.date,
            'ref': f'PDC Registration - {self.name}',
            'ops_branch_id': self.ops_branch_id.id,
            'ops_business_unit_id': self.ops_business_unit_id.id,
            'line_ids': [
                (0, 0, self._prepare_move_line_vals(
                    debit_account.id, self.amount, 0.0, 'PDC Holding'
                )),
                (0, 0, self._prepare_move_line_vals(
                    credit_account.id, 0.0, self.amount, 'PDC Registration'
                ))
            ]
        }
        
        move = self.env['account.move'].create(move_vals)
        move.action_post()
        
        self.write({
            'state': 'registered',
            'move_id': move.id
        })

    def action_deposit(self):
        """Deposit the PDC and create bank entry."""
        self.ensure_one()
        if self.state != 'registered':
            raise ValidationError('Only registered PDCs can be deposited.')

        # Get bank account from journal
        if not self.journal_id.default_account_id:
            raise ValidationError('Bank journal must have a default account configured.')

        # Determine accounts based on payment type
        if self.payment_type == 'inbound':
            debit_account = self.journal_id.default_account_id
            credit_account = self.holding_account_id
        else:  # outbound
            debit_account = self.holding_account_id
            credit_account = self.journal_id.default_account_id

        move_vals = {
            'journal_id': self.journal_id.id,
            'date': fields.Date.today(),
            'ref': f'PDC Deposit - {self.name}',
            'ops_branch_id': self.ops_branch_id.id,
            'ops_business_unit_id': self.ops_business_unit_id.id,
            'line_ids': [
                (0, 0, self._prepare_move_line_vals(
                    debit_account.id, self.amount, 0.0, 'PDC Bank Deposit'
                )),
                (0, 0, self._prepare_move_line_vals(
                    credit_account.id, 0.0, self.amount, 'PDC Holding Clearance'
                ))
            ]
        }
        
        move = self.env['account.move'].create(move_vals)
        move.action_post()
        
        self.write({
            'state': 'deposited',
            'deposit_move_id': move.id
        })

=== FILE: addons/ops_matrix_accounting/models/ops_matrix_standard_extensions.py ===

from odoo import models, fields, api

class SaleOrder(models.Model):
    _inherit = 'sale.order'

    ops_branch_id = fields.Many2one(
        'res.company',
        string='Branch',
        required=False,
        default=lambda self: self._get_default_branch(),
        help="Branch responsible for this sale"
    )
    ops_business_unit_id = fields.Many2one(
        'ops.business.unit',
        string='Business Unit',
        required=False,
        default=lambda self: self._get_default_business_unit(),
        help="Business unit this sale belongs to"
    )
    
    def _get_default_branch(self):
        """Get default branch from user or first available"""
        if hasattr(self.env.user, 'branch_id') and self.env.user.branch_id:
            return self.env.user.branch_id
        return self.env['res.company'].search([], limit=1)
    
    def _get_default_business_unit(self):
        """Get default business unit or first available"""
        return self.env['ops.business.unit'].search([], limit=1)

    def _prepare_invoice(self):
        """Propagate matrix dimensions to created invoice."""
        invoice_vals = super()._prepare_invoice()
        invoice_vals.update({
            'ops_branch_id': self.ops_branch_id.id,
            'ops_business_unit_id': self.ops_business_unit_id.id,
        })
        return invoice_vals


class PurchaseOrder(models.Model):
    _inherit = 'purchase.order'

    ops_branch_id = fields.Many2one(
        'res.company',
        string='Branch',
        required=False,
        default=lambda self: self._get_default_branch(),
        help="Branch responsible for this purchase"
    )
    ops_business_unit_id = fields.Many2one(
        'ops.business.unit',
        string='Business Unit',
        required=False,
        default=lambda self: self._get_default_business_unit(),
        help="Business unit this purchase belongs to"
    )
    
    def _get_default_branch(self):
        """Get default branch from user or first available"""
        if hasattr(self.env.user, 'branch_id') and self.env.user.branch_id:
            return self.env.user.branch_id
        return self.env['res.company'].search([], limit=1)
    
    def _get_default_business_unit(self):
        """Get default business unit or first available"""
        return self.env['ops.business.unit'].search([], limit=1)

    def _prepare_invoice(self):
        """Propagate matrix dimensions to created bill."""
        invoice_vals = super()._prepare_invoice()
        invoice_vals.update({
            'ops_branch_id': self.ops_branch_id.id,
            'ops_business_unit_id': self.ops_business_unit_id.id,
        })
        return invoice_vals


class StockPicking(models.Model):
    _inherit = 'stock.picking'

    ops_branch_id = fields.Many2one(
        'res.company',
        string='Branch',
        required=False,
        default=lambda self: self._get_default_branch(),
        help="Branch responsible for this transfer"
    )
    ops_business_unit_id = fields.Many2one(
        'ops.business.unit',
        string='Business Unit',
        required=False,
        default=lambda self: self._get_default_business_unit(),
        help="Business unit this transfer belongs to"
    )
    
    def _get_default_branch(self):
        """Get default branch from user or first available"""
        if hasattr(self.env.user, 'branch_id') and self.env.user.branch_id:
            return self.env.user.branch_id
        return self.env['res.company'].search([], limit=1)
    
    def _get_default_business_unit(self):
        """Get default business unit or first available"""
        return self.env['ops.business.unit'].search([], limit=1)

    @api.model_create_multi
    def create(self, vals_list):
        """Inherit matrix dimensions from source document."""
        for vals in vals_list:
            if vals.get('origin'):
                # Try to find source document
                sale_order = self.env['sale.order'].search([('name', '=', vals['origin'])], limit=1)
                if sale_order:
                    vals.update({
                        'ops_branch_id': sale_order.ops_branch_id.id,
                        'ops_business_unit_id': sale_order.ops_business_unit_id.id,
                    })
                    continue

                purchase_order = self.env['purchase.order'].search([('name', '=', vals['origin'])], limit=1)
                if purchase_order:
                    vals.update({
                        'ops_branch_id': purchase_order.ops_branch_id.id,
                        'ops_business_unit_id': purchase_order.ops_business_unit_id.id,
                    })
        
        return super().create(vals_list)


class AccountMove(models.Model):
    _inherit = 'account.move'

    ops_branch_id = fields.Many2one(
        'res.company',
        string='Branch',
        required=False,
        default=lambda self: self._get_default_branch(),
        help="Branch responsible for this entry"
    )
    ops_business_unit_id = fields.Many2one(
        'ops.business.unit',
        string='Business Unit',
        required=False,
        default=lambda self: self._get_default_business_unit(),
        help="Business unit this entry belongs to"
    )
    
    def _get_default_branch(self):
        """Get default branch from user or first available"""
        if hasattr(self.env.user, 'branch_id') and self.env.user.branch_id:
            return self.env.user.branch_id
        return self.env['res.company'].search([], limit=1)
    
    def _get_default_business_unit(self):
        """Get default business unit or first available"""
        return self.env['ops.business.unit'].search([], limit=1)

    @api.model_create_multi
    def create(self, vals_list):
        """Ensure matrix dimensions are properly set."""
        moves = super().create(vals_list)
        for move in moves:
            # Propagate dimensions to lines if not already set
            for line in move.line_ids:
                if not line.ops_branch_id:
                    line.ops_branch_id = move.ops_branch_id
                if not line.ops_business_unit_id:
                    line.ops_business_unit_id = move.ops_business_unit_id
        return moves


class AccountMoveLine(models.Model):
    _inherit = 'account.move.line'

    ops_branch_id = fields.Many2one(
        'res.company',
        string='Branch',
        required=False,
        default=lambda self: self._get_default_branch(),
        help="Branch for this journal item"
    )
    ops_business_unit_id = fields.Many2one(
        'ops.business.unit',
        string='Business Unit',
        required=False,
        default=lambda self: self._get_default_business_unit(),
        help="Business unit for this journal item"
    )
    
    def _get_default_branch(self):
        """Get default branch from move or user or first available"""
        if self.move_id and self.move_id.ops_branch_id:
            return self.move_id.ops_branch_id
        if hasattr(self.env.user, 'branch_id') and self.env.user.branch_id:
            return self.env.user.branch_id
        return self.env['res.company'].search([], limit=1)
    
    def _get_default_business_unit(self):
        """Get default business unit from move or first available"""
        if self.move_id and self.move_id.ops_business_unit_id:
            return self.move_id.ops_business_unit_id
        return self.env['ops.business.unit'].search([], limit=1)

    @api.model_create_multi
    def create(self, vals_list):
        """Ensure matrix dimensions are inherited from parent move."""
        for vals in vals_list:
            if vals.get('move_id'):
                move = self.env['account.move'].browse(vals['move_id'])
                if not vals.get('ops_branch_id'):
                    vals['ops_branch_id'] = move.ops_branch_id.id
                if not vals.get('ops_business_unit_id'):
                    vals['ops_business_unit_id'] = move.ops_business_unit_id.id
        
        return super().create(vals_list)

=== FILE: addons/ops_matrix_accounting/__manifest__.py ===

# -*- coding: utf-8 -*-
{
    'name': "OPS Matrix Accounting",
    'summary': "Advanced Financial Management & Reporting for Matrix Operations",
    'description': """
        Version 1.0 - Accounting Extension
        
        Transforms the standard Invoicing app into a full Accounting suite:
        1. PDC (Post-Dated Checks) Management
        2. Budget Control & Analytic Enforcement
        3. Professional Financial Reports (GL, TB, PL, BS)
        4. Excel Export Engine
        
        Requires: ops_matrix_core
    """,
    'author': "Gemini-3.0-Pro",
    'website': "http://www.yourcompany.com",
    'category': 'Accounting/Accounting',
    'version': '19.0.1.0.0',
    'depends': ['ops_matrix_core', 'account'],
    'external_dependencies': {
        'python': ['xlsxwriter'],
    },
    'data': [
        'security/ir.model.access.csv',
        'views/ops_accounting_menus.xml',
        'views/ops_pdc_views.xml',
        'views/ops_budget_views.xml',
        'views/ops_general_ledger_wizard_views.xml',
        'views/ops_general_ledger_wizard_enhanced_views.xml',
        'views/ops_financial_report_wizard_views.xml',
        'views/ops_reporting_views.xml',
        'reports/ops_general_ledger_template.xml',
        'reports/ops_financial_report_template.xml',
        'reports/ops_consolidated_report_templates.xml',
        
        # Template Data Files
        'data/templates/ops_budget_templates.xml',
    ],
    'post_init_hook': 'post_init_hook',
    'installable': True,
    'application': True,
    'license': 'LGPL-3',
}

=== FILE: addons/ops_matrix_accounting/__init__.py ===

from . import models
from . import wizard
from . import reports
from .hooks import post_init_hook

=== FILE: addons/ops_matrix_accounting/views/ops_general_ledger_wizard_views.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_ops_general_ledger_wizard_form" model="ir.ui.view">
        <field name="name">ops.general.ledger.wizard.form</field>
        <field name="model">ops.general.ledger.wizard</field>
        <field name="arch" type="xml">
            <form string="General Ledger Report">
                <group>
                    <group>
                        <field name="date_from"/>
                        <field name="date_to"/>
                        <field name="target_move"/>
                    </group>
                    <group>
                        <field name="company_id" invisible="1"/>
                        <field name="account_ids" widget="many2many_tags"/>
                    </group>
                </group>
                <footer>
                    <button string="Print PDF" name="action_print_pdf" type="object" class="btn-primary"/>
                    <button string="Export Excel" name="action_export_xlsx" type="object" class="btn-secondary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_ops_general_ledger_wizard" model="ir.actions.act_window">
        <field name="name">General Ledger</field>
        <field name="res_model">ops.general.ledger.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="binding_view_types">form</field>
    </record>

    <menuitem id="menu_ops_general_ledger_report" 
              name="General Ledger" 
              parent="menu_ops_accounting_reports" 
              action="action_ops_general_ledger_wizard" 
              sequence="10"/>
</odoo>

=== FILE: addons/ops_matrix_accounting/views/ops_budget_views.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- List View -->
    <record id="view_ops_budget_tree" model="ir.ui.view">
        <field name="name">ops.budget.list</field>
        <field name="model">ops.budget</field>
        <field name="arch" type="xml">
            <list string="Budgets" decoration-info="state == 'draft'" decoration-success="state == 'confirmed'" decoration-muted="state == 'done'">
                <field name="name"/>
                <field name="ops_branch_id"/>
                <field name="ops_business_unit_id"/>
                <field name="date_from"/>
                <field name="date_to"/>
                <field name="total_planned"/>
                <field name="total_practical"/>
                <field name="total_committed"/>
                <field name="available_balance"/>
                <field name="currency_id" invisible="1"/>
                <field name="state"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_ops_budget_form" model="ir.ui.view">
        <field name="name">ops.budget.form</field>
        <field name="model">ops.budget</field>
        <field name="arch" type="xml">
            <form string="Budget">
                <header>
                    <button name="action_confirm"
                            string="Confirm"
                            type="object"
                            class="oe_highlight"/>
                    <button name="action_done"
                            string="Close"
                            type="object"/>
                    <button name="action_draft"
                            string="Reset to Draft"
                            type="object"/>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="e.g. 2024 Q1 Marketing Budget"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="ops_branch_id"/>
                            <field name="ops_business_unit_id"/>
                            <field name="currency_id" groups="base.group_multi_currency"/>
                        </group>
                        <group>
                            <field name="date_from"/>
                            <field name="date_to"/>
                            <field name="active" invisible="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Budget Lines" name="budget_lines">
                            <field name="line_ids" widget="section_and_note_one2many">
                                <list editable="bottom">
                                    <field name="general_account_id"/>
                                    <field name="planned_amount"/>
                                    <field name="practical_amount"/>
                                    <field name="committed_amount"/>
                                    <field name="available_amount"/>
                                    <field name="currency_id" invisible="1"/>
                                </list>
                            </field>
                            <group class="oe_subtotal_footer oe_right" colspan="2">
                                <field name="total_planned" widget="monetary"/>
                                <field name="total_practical" widget="monetary"/>
                                <field name="total_committed" widget="monetary"/>
                                <field name="available_balance" class="oe_subtotal_footer_separator" widget="monetary"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_ops_budget_search" model="ir.ui.view">
        <field name="name">ops.budget.search</field>
        <field name="model">ops.budget</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="ops_branch_id"/>
                <field name="ops_business_unit_id"/>
                <separator/>
                <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Confirmed" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
                <filter string="Done" name="done" domain="[('state', '=', 'done')]"/>
                <separator/>
                <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                <filter string="Branch" name="group_by_branch" context="{'group_by': 'ops_branch_id'}"/>
                <filter string="Business Unit" name="group_by_bu" context="{'group_by': 'ops_business_unit_id'}"/>
                <filter string="Status" name="group_by_state" context="{'group_by': 'state'}"/>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_ops_budget" model="ir.actions.act_window">
        <field name="name">Budget Control</field>
        <field name="res_model">ops.budget</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_ops_budget_search"/>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first budget!
            </p>
            <p>
                A budget helps you control expenses by setting planned amounts
                for each expense account within a specific branch and business unit.
            </p>
        </field>
    </record>

    <!-- Menu Item -->
    <menuitem id="menu_ops_budget"
              name="Budget Control"
              parent="account.menu_finance_reports"
              action="action_ops_budget"
              sequence="15"/>
</odoo>

=== FILE: addons/ops_matrix_accounting/views/ops_general_ledger_wizard_enhanced_views.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Enhanced General Ledger Wizard Form View -->
    <record id="view_ops_general_ledger_wizard_enhanced_form" model="ir.ui.view">
        <field name="name">ops.general.ledger.wizard.enhanced.form</field>
        <field name="model">ops.general.ledger.wizard.enhanced</field>
        <field name="arch" type="xml">
            <form string="General Ledger Report with Matrix Filters">
                <sheet>
                    <div class="oe_title">
                        <h1>General Ledger Report</h1>
                        <h3 class="text-muted">Matrix-Enhanced Financial Reporting</h3>
                        <div class="text-muted mt-2">
                            <field name="filter_summary" widget="text" readonly="1"/>
                        </div>
                    </div>
                    
                    <!-- Quick Stats Alert -->
                    <div class="alert alert-info" role="alert" invisible="record_count == 0">
                        <div class="row">
                            <div class="col-8">
                                <strong>Estimated records:</strong> 
                                <field name="record_count" readonly="1"/> transactions
                            </div>
                            <div class="col-4 text-right">
                                <span invisible="record_count &lt;= 10000" class="badge badge-success">
                                    Good size
                                </span>
                                <span invisible="record_count &lt;= 10000 or record_count &gt; 50000" class="badge badge-warning">
                                    Large dataset
                                </span>
                                <span invisible="record_count &lt;= 50000" class="badge badge-danger">
                                    Very large - use filters
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabbed Interface for Filters -->
                    <notebook>
                        <!-- Tab 1: Period & Company -->
                        <page string="Period &amp; Company" name="page_period">
                            <group>
                                <group string="Reporting Period">
                                    <field name="date_from"/>
                                    <field name="date_to"/>
                                    <field name="include_initial_balance"/>
                                </group>
                                
                                <group string="Company &amp; Journals">
                                    <field name="company_id" options="{'no_create': True}"/>
                                    <field name="journal_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                </group>
                            </group>
                            
                            <group>
                                <group string="Transaction Filters">
                                    <field name="target_move" widget="radio"/>
                                    <field name="reconciled" widget="radio"/>
                                </group>
                            </group>
                        </page>
                        
                        <!-- Tab 2: Matrix Dimensions (PRIMARY FEATURE) -->
                        <page string="Matrix Dimensions" name="page_matrix">
                            <div class="alert alert-primary" role="alert">
                                <h4><i class="fa fa-filter"/> Matrix Filtering</h4>
                                <p>Filter transactions by Branch and/or Business Unit dimensions for precise organizational reporting.</p>
                            </div>
                            
                            <group>
                                <group string="Branch Selection">
                                    <field name="branch_ids" widget="many2many_tags" options="{'no_create': True, 'color_field': 'color'}"/>
                                    <div class="text-muted" invisible="not branch_ids">
                                        <span invisible="not branch_ids">
                                            <t t-esc="len(branch_ids)"/> branch(es) selected
                                        </span>
                                    </div>
                                </group>
                                
                                <group string="Business Unit Selection">
                                    <field name="business_unit_ids" widget="many2many_tags" options="{'no_create': True, 'color_field': 'color'}"/>
                                    <div class="text-muted" invisible="not business_unit_ids">
                                        <span invisible="not business_unit_ids">
                                            <t t-esc="len(business_unit_ids)"/> business unit(s) selected
                                        </span>
                                    </div>
                                </group>
                            </group>
                            
                            <separator string="Matrix Filter Mode"/>
                            <group>
                                <field name="matrix_filter_mode" widget="radio" class="oe_inline"/>
                            </group>
                            
                            <div class="alert alert-info mt-3" role="alert">
                                <h5>Filter Mode Explanation:</h5>
                                <ul class="mb-0">
                                    <li invisible="matrix_filter_mode != 'any'">
                                        <strong>Any Dimension:</strong> Shows transactions matching ANY selected branch OR business unit (inclusive)
                                    </li>
                                    <li invisible="matrix_filter_mode != 'both'">
                                        <strong>Both Dimensions:</strong> Shows transactions matching BOTH selected branch AND business unit (restrictive)
                                    </li>
                                    <li invisible="matrix_filter_mode != 'exact'">
                                        <strong>Exact Combination:</strong> Shows only transactions with exact branch-BU combinations (e.g., Branch A + BU X only)
                                    </li>
                                </ul>
                            </div>
                        </page>
                        
                        <!-- Tab 3: Accounts -->
                        <page string="Accounts" name="page_accounts">
                            <group>
                                <group string="Account Selection">
                                    <field name="account_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                    <field name="account_type_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                </group>
                                
                                <group string="Display Options">
                                    <field name="display_account" widget="radio"/>
                                </group>
                            </group>
                            
                            <div class="alert alert-secondary mt-3" role="alert">
                                <p class="mb-0">
                                    <strong>Tip:</strong> Leave account fields empty to include all accounts, or select specific accounts/types for focused analysis.
                                </p>
                            </div>
                        </page>
                        
                        <!-- Tab 4: Partners -->
                        <page string="Partners" name="page_partners">
                            <group>
                                <group string="Partner Filter">
                                    <field name="partner_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                </group>
                            </group>
                            
                            <div class="alert alert-secondary mt-3" role="alert">
                                <p class="mb-0">
                                    <strong>Optional:</strong> Filter by specific partners to analyze supplier/customer transactions.
                                </p>
                            </div>
                        </page>
                        
                        <!-- Tab 5: Report Options -->
                        <page string="Report Options" name="page_options">
                            <group>
                                <group string="Report Format">
                                    <field name="report_format" widget="radio"/>
                                    <field name="sort_by"/>
                                </group>
                                
                                <group string="Grouping &amp; Consolidation">
                                    <field name="group_by_date"/>
                                    <separator string="Consolidate By:"/>
                                    <field name="consolidate_by_branch"/>
                                    <field name="consolidate_by_bu"/>
                                    <field name="consolidate_by_partner"/>
                                </group>
                            </group>
                            
                            <div class="alert alert-info mt-3" role="alert">
                                <h5>Format Guide:</h5>
                                <ul class="mb-0">
                                    <li><strong>Detailed:</strong> Line-by-line transaction listing (best for &lt;10k records)</li>
                                    <li><strong>Summary:</strong> Aggregated by account and selected dimensions (efficient for large datasets)</li>
                                    <li><strong>Both:</strong> Combined detailed and summary views</li>
                                </ul>
                            </div>
                        </page>
                    </notebook>
                    
                    <!-- Action Buttons -->
                    <footer>
                        <button name="action_generate_report" 
                                string="Generate Report" 
                                type="object" 
                                class="btn-primary"
                                invisible="not date_from or not date_to"/>
                        <button name="action_export_to_excel" 
                                string="Export to Excel" 
                                type="object" 
                                class="btn-secondary"
                                invisible="not date_from or not date_to"/>
                        <button name="action_view_transactions" 
                                string="View Transactions" 
                                type="object" 
                                class="btn-secondary"
                                invisible="not date_from or not date_to"/>
                        <button string="Cancel" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Action to Open Enhanced Wizard -->
    <record id="action_ops_general_ledger_wizard_enhanced" model="ir.actions.act_window">
        <field name="name">General Ledger (Matrix)</field>
        <field name="res_model">ops.general.ledger.wizard.enhanced</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Menu Item -->
    <menuitem id="menu_ops_general_ledger_enhanced"
              name="General Ledger (Matrix)"
              parent="account.menu_finance_reports"
              action="action_ops_general_ledger_wizard_enhanced"
              sequence="5"/>

</odoo>

=== FILE: addons/ops_matrix_accounting/views/ops_financial_report_wizard_views.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Financial Report Wizard Form View -->
    <record id="view_ops_financial_report_wizard_form" model="ir.ui.view">
        <field name="name">ops.financial.report.wizard.form</field>
        <field name="model">ops.financial.report.wizard</field>
        <field name="arch" type="xml">
            <form string="Financial Report">
                <sheet>
                    <group>
                        <group>
                            <field name="report_type" widget="radio"/>
                            <field name="date_from"/>
                            <field name="date_to"/>
                        </group>
                        <group>
                            <field name="branch_id"/>
                            <field name="target_move" widget="radio"/>
                            <field name="company_id" invisible="1"/>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button string=" View On-Screen Analysis" 
                            name="action_view_data" 
                            type="object" 
                            class="btn-primary"/>
                    <button string=" Print PDF" 
                            name="action_print_pdf" 
                            type="object" 
                            class="btn-secondary"/>
                    <button string=" Export Excel" 
                            name="action_export_xlsx" 
                            type="object" 
                            class="btn-secondary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Financial Report Wizard Action -->
    <record id="action_ops_financial_report_wizard" model="ir.actions.act_window">
        <field name="name">Financial Reports</field>
        <field name="res_model">ops.financial.report.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <!-- Menu Item -->
    <menuitem id="menu_ops_financial_report_wizard"
              name="Financial Reports"
              parent="menu_ops_accounting_reports"
              action="action_ops_financial_report_wizard"
              sequence="10"/>
</odoo>

=== FILE: addons/ops_matrix_accounting/views/ops_pdc_views.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- List View -->
    <record id="view_ops_pdc_tree" model="ir.ui.view">
        <field name="name">ops.pdc.list</field>
        <field name="model">ops.pdc</field>
        <field name="arch" type="xml">
            <list string="Post-Dated Checks" decoration-info="state == 'draft'" decoration-success="state == 'cleared'" decoration-danger="state == 'bounced'">
                <field name="name"/>
                <field name="date"/>
                <field name="maturity_date"/>
                <field name="partner_id"/>
                <field name="payment_type"/>
                <field name="amount"/>
                <field name="currency_id" invisible="1"/>
                <field name="ops_branch_id"/>
                <field name="ops_business_unit_id"/>
                <field name="state"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_ops_pdc_form" model="ir.ui.view">
        <field name="name">ops.pdc.form</field>
        <field name="model">ops.pdc</field>
        <field name="arch" type="xml">
            <form string="Post-Dated Check">
                <header>
                    <button name="action_register"
                            string="Register"
                            type="object"
                            class="oe_highlight"/>
                    <button name="action_deposit"
                            string="Deposit"
                            type="object"
                            class="oe_highlight"/>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Basic Information">
                            <field name="partner_id"/>
                            <field name="payment_type"/>
                            <field name="amount"/>
                            <field name="currency_id" groups="base.group_multi_currency"/>
                            <field name="check_number"/>
                            <field name="bank_id"/>
                        </group>
                        <group string="Dates">
                            <field name="date"/>
                            <field name="maturity_date"/>
                        </group>
                    </group>
                    <group>
                        <group string="Matrix Dimensions">
                            <field name="ops_branch_id"/>
                            <field name="ops_business_unit_id"/>
                        </group>
                        <group string="Accounting Information">
                            <field name="journal_id"/>
                            <field name="holding_account_id"/>
                            <field name="move_id" readonly="1"/>
                            <field name="deposit_move_id" readonly="1"/>
                        </group>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_ops_pdc_search" model="ir.ui.view">
        <field name="name">ops.pdc.search</field>
        <field name="model">ops.pdc</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="check_number"/>
                <field name="ops_branch_id"/>
                <field name="ops_business_unit_id"/>
                <separator/>
                <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Registered" name="registered" domain="[('state', '=', 'registered')]"/>
                <filter string="Deposited" name="deposited" domain="[('state', '=', 'deposited')]"/>
                <filter string="Cleared" name="cleared" domain="[('state', '=', 'cleared')]"/>
                <filter string="Bounced" name="bounced" domain="[('state', '=', 'bounced')]"/>
                <separator/>
                <filter string="Customer PDCs" name="inbound" domain="[('payment_type', '=', 'inbound')]"/>
                <filter string="Vendor PDCs" name="outbound" domain="[('payment_type', '=', 'outbound')]"/>
                <filter string="Status" name="group_by_state" context="{'group_by': 'state'}"/>
                <filter string="Partner" name="group_by_partner" context="{'group_by': 'partner_id'}"/>
                <filter string="Branch" name="group_by_branch" context="{'group_by': 'ops_branch_id'}"/>
                <filter string="Business Unit" name="group_by_bu" context="{'group_by': 'ops_business_unit_id'}"/>
            </search>
        </field>
    </record>

    <!-- Actions -->
    <record id="action_ops_pdc_receivable" model="ir.actions.act_window">
        <field name="name">Customer PDCs</field>
        <field name="res_model">ops.pdc</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'default_payment_type': 'inbound', 'search_default_inbound': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first post-dated check from a customer!
            </p>
        </field>
    </record>

    <record id="action_ops_pdc_payable" model="ir.actions.act_window">
        <field name="name">Vendor PDCs</field>
        <field name="res_model">ops.pdc</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'default_payment_type': 'outbound', 'search_default_outbound': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first post-dated check to a vendor!
            </p>
        </field>
    </record>

    <!-- Menu Items -->
    <menuitem id="menu_ops_pdc_receivable"
              name="PDC Receivables"
              parent="account.menu_finance_receivables"
              action="action_ops_pdc_receivable"
              sequence="20"/>

    <menuitem id="menu_ops_pdc_payable"
              name="PDC Payables"
              parent="account.menu_finance_payables"
              action="action_ops_pdc_payable"
              sequence="20"/>
</odoo>

=== FILE: addons/ops_matrix_accounting/views/ops_accounting_menus.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Rename the standard Invoicing menu to "Accounting" -->
    <record id="account.menu_finance" model="ir.ui.menu">
        <field name="name">Accounting</field>
    </record>

    <!-- Create OPS Accounting submenu structure -->
    <menuitem id="menu_ops_accounting_root" name="OPS Accounting" parent="account.menu_finance" sequence="100"/>
    <menuitem id="menu_ops_accounting_reports" name="Financial Reports" parent="menu_ops_accounting_root" sequence="10"/>
</odoo>

=== FILE: addons/ops_matrix_accounting/views/ops_reporting_views.xml ===

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Company Consolidation Wizard View -->
    <record id="view_ops_company_consolidation_wizard" model="ir.ui.view">
        <field name="name">ops.company.consolidation.wizard</field>
        <field name="model">ops.company.consolidation</field>
        <field name="arch" type="xml">
            <form string="Company Consolidation Report">
                <sheet>
                    <div class="oe_title">
                        <h1>Company Consolidated P&amp;L Report</h1>
                    </div>
                    
                    <group>
                        <group string="Filters">
                            <field name="company_id" options="{'no_create': True}"/>
                            <field name="date_from"/>
                            <field name="date_to"/>
                            <field name="compare_with_previous"/>
                        </group>
                        
                        <group string="Options">
                            <field name="branch_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="report_detail_level"/>
                        </group>
                    </group>
                    
                    <group string="Report Preview" invisible="not report_data">
                        <group>
                            <label for="report_data" string="Report Summary"/>
                            <div>
                                <strong>Report generated for period:</strong>
                                <field name="date_from" readonly="1" nolabel="1"/> to 
                                <field name="date_to" readonly="1" nolabel="1"/>
                            </div>
                        </group>
                    </group>
                    
                    <footer>
                        <button name="action_generate_pdf" 
                                string="Generate PDF" 
                                type="object" 
                                class="btn-primary"/>
                        <button name="action_generate_xlsx" 
                                string="Export to Excel" 
                                type="object" 
                                class="btn-secondary"/>
                        <button string="Cancel" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Company Consolidation Action -->
    <record id="action_ops_company_consolidation" model="ir.actions.act_window">
        <field name="name">Company Consolidation</field>
        <field name="res_model">ops.company.consolidation</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Branch Report Wizard View -->
    <record id="view_ops_branch_report_wizard" model="ir.ui.view">
        <field name="name">ops.branch.report.wizard</field>
        <field name="model">ops.branch.report</field>
        <field name="arch" type="xml">
            <form string="Branch P&amp;L Report">
                <sheet>
                    <div class="oe_title">
                        <h1>Branch Profit &amp; Loss Report</h1>
                    </div>
                    
                    <group>
                        <group string="Selection">
                            <field name="branch_id" options="{'no_create': True}"/>
                            <field name="business_unit_ids" widget="many2many_tags" options="{'no_create': True}"/>
                        </group>
                        
                        <group string="Period">
                            <field name="date_from"/>
                            <field name="date_to"/>
                        </group>
                    </group>
                    
                    <group string="Report Preview" invisible="not report_data">
                        <group>
                            <label for="report_data" string="Branch Summary"/>
                            <div>
                                <strong>Report generated for:</strong>
                                <field name="branch_id" readonly="1" nolabel="1"/>
                            </div>
                        </group>
                    </group>
                    
                    <footer>
                        <button name="action_generate_pdf" 
                                string="Generate PDF" 
                                type="object" 
                                class="btn-primary"/>
                        <button string="Cancel" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Branch Report Action -->
    <record id="action_ops_branch_report" model="ir.actions.act_window">
        <field name="name">Branch P&amp;L Report</field>
        <field name="res_model">ops.branch.report</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Business Unit Report Wizard View -->
    <record id="view_ops_business_unit_report_wizard" model="ir.ui.view">
        <field name="name">ops.business.unit.report.wizard</field>
        <field name="model">ops.business.unit.report</field>
        <field name="arch" type="xml">
            <form string="Business Unit Report">
                <sheet>
                    <div class="oe_title">
                        <h1>Business Unit Profitability Report</h1>
                    </div>
                    
                    <group>
                        <group string="Selection">
                            <field name="business_unit_id" options="{'no_create': True}"/>
                            <field name="business_unit_branch_ids" invisible="1"/>
                            <field name="branch_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="consolidate_by_branch"/>
                        </group>
                        
                        <group string="Period">
                            <field name="date_from"/>
                            <field name="date_to"/>
                        </group>
                    </group>
                    
                    <group string="Report Preview" invisible="not report_data">
                        <group>
                            <label for="report_data" string="Business Unit Summary"/>
                            <div>
                                <strong>Report generated for:</strong>
                                <field name="business_unit_id" readonly="1" nolabel="1"/>
                            </div>
                        </group>
                    </group>
                    
                    <footer>
                        <button name="action_generate_pdf" 
                                string="Generate PDF" 
                                type="object" 
                                class="btn-primary"/>
                        <button string="Cancel" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Business Unit Report Action -->
    <record id="action_ops_business_unit_report" model="ir.actions.act_window">
        <field name="name">Business Unit Report</field>
        <field name="res_model">ops.business.unit.report</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Consolidated Balance Sheet Wizard View -->
    <record id="view_ops_consolidated_balance_sheet_wizard" model="ir.ui.view">
        <field name="name">ops.consolidated.balance.sheet.wizard</field>
        <field name="model">ops.consolidated.balance.sheet</field>
        <field name="arch" type="xml">
            <form string="Consolidated Balance Sheet">
                <sheet>
                    <div class="oe_title">
                        <h1>Consolidated Balance Sheet</h1>
                    </div>
                    
                    <group>
                        <group string="Companies">
                            <field name="company_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="date"/>
                        </group>
                        
                        <group string="Consolidation Options">
                            <field name="include_intercompany"/>
                            <field name="currency_id" options="{'no_create': True}"/>
                        </group>
                    </group>
                    
                    <group string="Report Preview" invisible="not report_data">
                        <group>
                            <label for="report_data" string="Balance Sheet Summary"/>
                            <div>
                                <strong>Consolidation as of:</strong>
                                <field name="date" readonly="1" nolabel="1"/>
                            </div>
                        </group>
                    </group>
                    
                    <footer>
                        <button name="action_generate_pdf" 
                                string="Generate PDF" 
                                type="object" 
                                class="btn-primary"/>
                        <button string="Cancel" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Consolidated Balance Sheet Action -->
    <record id="action_ops_consolidated_balance_sheet" model="ir.actions.act_window">
        <field name="name">Consolidated Balance Sheet</field>
        <field name="res_model">ops.consolidated.balance.sheet</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Matrix Profitability Analysis Wizard View -->
    <record id="view_ops_matrix_profitability_analysis_wizard" model="ir.ui.view">
        <field name="name">ops.matrix.profitability.analysis.wizard</field>
        <field name="model">ops.matrix.profitability.analysis</field>
        <field name="arch" type="xml">
            <form string="Matrix Profitability Analysis">
                <sheet>
                    <div class="oe_title">
                        <h1>Matrix Profitability Analysis</h1>
                        <h3>Branch x Business Unit Performance Matrix</h3>
                    </div>
                    
                    <group>
                        <group string="Filters">
                            <field name="company_id" options="{'no_create': True}"/>
                        </group>
                        
                        <group string="Period">
                            <field name="date_from"/>
                            <field name="date_to"/>
                        </group>
                    </group>
                    
                    <group string="Report Preview" invisible="not matrix_data">
                        <group>
                            <label for="matrix_data" string="Matrix Summary"/>
                            <div>
                                <strong>Analysis for:</strong>
                                <field name="company_id" readonly="1" nolabel="1"/>
                            </div>
                        </group>
                    </group>
                    
                    <footer>
                        <button name="action_generate_heatmap" 
                                string="Generate Heatmap" 
                                type="object" 
                                class="btn-primary"/>
                        <button string="Cancel" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Matrix Profitability Analysis Action -->
    <record id="action_ops_matrix_profitability" model="ir.actions.act_window">
        <field name="name">Matrix Profitability Analysis</field>
        <field name="res_model">ops.matrix.profitability.analysis</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Menu Structure -->
    <menuitem id="menu_ops_reporting" 
              name="Matrix Reports" 
              parent="account.menu_finance_reports"
              sequence="10"/>
    
    <menuitem id="menu_ops_company_consolidation"
              name="Company Consolidation"
              parent="menu_ops_reporting"
              action="action_ops_company_consolidation"
              sequence="10"/>
    
    <menuitem id="menu_ops_branch_report"
              name="Branch P&amp;L"
              parent="menu_ops_reporting"
              action="action_ops_branch_report"
              sequence="20"/>
    
    <menuitem id="menu_ops_business_unit_report"
              name="Business Unit Report"
              parent="menu_ops_reporting"
              action="action_ops_business_unit_report"
              sequence="30"/>
    
    <menuitem id="menu_ops_consolidated_balance_sheet"
              name="Consolidated Balance Sheet"
              parent="menu_ops_reporting"
              action="action_ops_consolidated_balance_sheet"
              sequence="40"/>
    
    <menuitem id="menu_ops_matrix_profitability"
              name="Matrix Profitability Analysis"
              parent="menu_ops_reporting"
              action="action_ops_matrix_profitability"
              sequence="50"/>

</odoo>
