<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS PAYMENT RECEIPT
         Inherits native account.report_payment_receipt_document.

         NOTE: The native template sets `values` via
         o._get_payment_receipt_report_values() BEFORE the page div.
         This `values` dict is available in our scope.
         ================================================================ -->

    <!-- Re-enable and style native payment report action -->
    <record id="account.action_report_payment_receipt" model="ir.actions.report">
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
        <field name="binding_model_id" ref="account.model_account_payment"/>
        <field name="binding_type">report</field>
    </record>

    <template id="report_payment_receipt_document_ops"
              name="OPS Payment Receipt"
              inherit_id="account.report_payment_receipt_document"
              priority="99">

        <xpath expr="//div[@class='page']" position="replace">
            <div class="page ops-report-page">
                <!-- Alias o -> doc -->
                <t t-set="doc" t-value="o"/>
                <t t-set="company" t-value="doc.company_id"/>
                <t t-set="_ops" t-value="company.get_ops_report_settings()"/>
                <t t-set="is_inbound" t-value="doc.payment_type == 'inbound'"/>

                <!-- CSS -->
                <t t-call="ops_theme.ops_report_css"/>

                <!-- Title Bar -->
                <t t-set="doc_title" t-value="'Payment Receipt'"/>
                <t t-set="doc_ref" t-value="doc.name"/>
                <t t-call="ops_theme.ops_title_bar"/>

                <!-- Partner Address -->
                <t t-if="doc.partner_id">
                    <t t-call="ops_theme.ops_address_block">
                        <t t-set="partner" t-value="doc.partner_id"/>
                        <t t-set="addr_label" t-value="'Received From' if is_inbound else 'Paid To'"/>
                    </t>
                </t>

                <!-- Payment Card -->
                <div t-attf-style="border:1px solid #e2e8f0; border-radius:6px; margin-bottom:16px; overflow:hidden;">
                    <!-- Amount Block -->
                    <div t-attf-style="padding:14px; text-align:center; background:#{_ops['primary']}; color:#{_ops['text_on_primary']};">
                        <div style="font-size:7pt; text-transform:uppercase; letter-spacing:0.5px; opacity:0.8; margin-bottom:2px;">
                            <t t-if="is_inbound">Amount Received</t>
                            <t t-else="">Amount Paid</t>
                        </div>
                        <div style="font-size:20pt; font-weight:700; font-variant-numeric:tabular-nums;">
                            <t t-esc="doc.amount" t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                        </div>
                    </div>

                    <!-- Info Grid -->
                    <table style="width:100%; border-collapse:collapse;">
                        <tr>
                            <td t-if="doc.date" style="padding:8px 12px; border-right:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0;">
                                <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#94a3b8; margin-bottom:1px;">Payment Date</div>
                                <div style="font-size:8.5pt; font-weight:600; color:#1e293b;">
                                    <t t-esc="doc.date" t-options="{'widget': 'date'}"/>
                                </div>
                            </td>
                            <td t-if="doc.journal_id" style="padding:8px 12px; border-right:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0;">
                                <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#94a3b8; margin-bottom:1px;">Payment Method</div>
                                <div style="font-size:8.5pt; font-weight:600; color:#1e293b;"><t t-esc="doc.journal_id.name"/></div>
                            </td>
                            <td t-if="doc.memo" style="padding:8px 12px; border-bottom:1px solid #e2e8f0;">
                                <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#94a3b8; margin-bottom:1px;">Memo</div>
                                <div style="font-size:8.5pt; font-weight:600; color:#1e293b;"><t t-esc="doc.memo"/></div>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Reconciled Invoices (inbound payments) -->
                <t t-if="is_inbound and doc.reconciled_invoice_ids">
                    <div style="margin-bottom:14px;">
                        <div t-attf-style="font-size:7.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.4px; color:#{_ops['primary']}; margin-bottom:6px;">Reconciled Invoices</div>
                        <table style="width:100%; border-collapse:collapse; font-size:7.5pt;">
                            <thead>
                                <tr style="background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                                    <th style="padding:5px 8px; text-align:left; font-weight:600; font-size:6.5pt; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Invoice</th>
                                    <th style="padding:5px 8px; text-align:left; font-weight:600; font-size:6.5pt; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Date</th>
                                    <th style="padding:5px 8px; text-align:right; font-weight:600; font-size:6.5pt; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="doc.reconciled_invoice_ids" t-as="inv">
                                    <tr style="border-bottom:1px solid #f1f5f9;">
                                        <td style="padding:5px 8px;"><t t-esc="inv.name"/></td>
                                        <td style="padding:5px 8px;"><t t-esc="inv.invoice_date" t-options="{'widget': 'date'}"/></td>
                                        <td style="padding:5px 8px; text-align:right; font-variant-numeric:tabular-nums;">
                                            <t t-esc="inv.amount_total" t-options="{'widget':'monetary','display_currency':inv.currency_id}"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- Reconciled Bills (outbound payments) -->
                <t t-if="not is_inbound and doc.reconciled_bill_ids">
                    <div style="margin-bottom:14px;">
                        <div t-attf-style="font-size:7.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.4px; color:#{_ops['primary']}; margin-bottom:6px;">Reconciled Bills</div>
                        <table style="width:100%; border-collapse:collapse; font-size:7.5pt;">
                            <thead>
                                <tr style="background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                                    <th style="padding:5px 8px; text-align:left; font-weight:600; font-size:6.5pt; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Bill</th>
                                    <th style="padding:5px 8px; text-align:left; font-weight:600; font-size:6.5pt; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Date</th>
                                    <th style="padding:5px 8px; text-align:right; font-weight:600; font-size:6.5pt; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="doc.reconciled_bill_ids" t-as="bill">
                                    <tr style="border-bottom:1px solid #f1f5f9;">
                                        <td style="padding:5px 8px;"><t t-esc="bill.name"/></td>
                                        <td style="padding:5px 8px;"><t t-esc="bill.invoice_date" t-options="{'widget': 'date'}"/></td>
                                        <td style="padding:5px 8px; text-align:right; font-variant-numeric:tabular-nums;">
                                            <t t-esc="bill.amount_total" t-options="{'widget':'monetary','display_currency':bill.currency_id}"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- Amount in Words -->
                <t t-set="amount_for_words" t-value="doc.amount"/>
                <t t-set="currency_for_words" t-value="doc.currency_id"/>
                <t t-call="ops_theme.ops_amount_words_block"/>

                <!-- Signatures -->
                <t t-call="ops_theme.ops_signature_block"/>

            </div>
        </xpath>

    </template>

</odoo>
