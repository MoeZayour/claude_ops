<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
    ================================================================
    BALANCE SHEET V2 - Uses ops_internal_layout_v2

    Data Flow:
        1. docs = wizard recordset (ops.general.ledger.wizard.enhanced)
        2. doc = single wizard record (iterated via t-foreach)
        3. doc._get_report_data() returns dict with 'hierarchy', 'summary', 'sections'
        4. hierarchy has: asset_hierarchy, liability_hierarchy, equity_hierarchy
        5. summary has: total_assets, total_liabilities, total_equity

    Replaces: report_balance_sheet_corporate (inline-heavy version)
    ================================================================
    -->

    <!-- Report Action -->
    <record id="action_report_balance_sheet_v2" model="ir.actions.report">
        <field name="name">Balance Sheet (V2)</field>
        <field name="model">ops.general.ledger.wizard.enhanced</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_balance_sheet_v2</field>
        <field name="report_file">ops_matrix_accounting.report_balance_sheet_v2</field>
        <field name="print_report_name">'Balance_Sheet_%s' % (object.as_of_date or object.date_to)</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
    </record>

    <template id="report_balance_sheet_v2">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <!-- Extract data from wizard -->
                <t t-set="report_data" t-value="doc._get_report_data()"/>
                <t t-set="company" t-value="doc.company_id or env.company"/>
                <t t-set="summary" t-value="report_data.get('summary', {})"/>
                <t t-set="hierarchy" t-value="report_data.get('hierarchy', {})"/>

                <!-- Calculate totals -->
                <t t-set="total_assets" t-value="summary.get('total_assets', hierarchy.get('asset_total', 0))"/>
                <t t-set="total_liabilities" t-value="summary.get('total_liabilities', hierarchy.get('liability_total', 0))"/>
                <t t-set="total_equity" t-value="summary.get('total_equity', hierarchy.get('equity_total', 0))"/>
                <t t-set="check_diff" t-value="abs(total_assets - (total_liabilities + total_equity))"/>

                <t t-call="ops_matrix_accounting.ops_internal_layout_v2">
                    <t t-set="report_title" t-value="'Balance Sheet'"/>
                    <t t-set="report_subtitle" t-value="'As of ' + ((doc.as_of_date or doc.date_to).strftime('%B %d, %Y') if (doc.as_of_date or doc.date_to) else '')"/>
                    <t t-set="filter_items" t-value="[
                        ('Company', company.name),
                        ('Currency', company.currency_id.name or ''),
                        ('Entries', doc.target_move == 'posted' and 'Posted Only' or 'All Entries'),
                    ]"/>

                    <!-- Balance Check Badge -->
                    <t t-call="ops_matrix_accounting.ops_balance_badge_v2">
                        <t t-set="check_diff" t-value="check_diff"/>
                    </t>

                    <!-- ==================== KPI SUMMARY ==================== -->
                    <table class="ops-kpi-table-v2" style="width: 100%; border-collapse: separate; border-spacing: 10px 0; margin-bottom: 20px;">
                        <tr>
                            <td class="ops-kpi-cell-v2 success" style="background-color: #f0fdf4; border-left: 4px solid #10b981; padding: 12px 15px; text-align: center; border-radius: 6px;">
                                <div style="font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; margin-bottom: 4px;">Total Assets</div>
                                <div style="font-size: 14pt; font-weight: 700; color: #16a34a; font-family: Consolas, Monaco, monospace;">
                                    <t t-esc="'{:,.2f}'.format(total_assets)"/>
                                </div>
                            </td>
                            <td class="ops-kpi-cell-v2 warning" style="background-color: #fff7ed; border-left: 4px solid #f59e0b; padding: 12px 15px; text-align: center; border-radius: 6px;">
                                <div style="font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; margin-bottom: 4px;">Total Liabilities</div>
                                <div style="font-size: 14pt; font-weight: 700; color: #f59e0b; font-family: Consolas, Monaco, monospace;">
                                    <t t-esc="'{:,.2f}'.format(total_liabilities)"/>
                                </div>
                            </td>
                            <td class="ops-kpi-cell-v2 info" style="background-color: #faf5ff; border-left: 4px solid #8b5cf6; padding: 12px 15px; text-align: center; border-radius: 6px;">
                                <div style="font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; margin-bottom: 4px;">Shareholders' Equity</div>
                                <div style="font-size: 14pt; font-weight: 700; color: #8b5cf6; font-family: Consolas, Monaco, monospace;">
                                    <t t-esc="'{:,.2f}'.format(total_equity)"/>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <!-- ==================== ASSETS SECTION ==================== -->
                    <t t-call="ops_matrix_accounting.ops_section_header_v2">
                        <t t-set="title" t-value="'ASSETS'"/>
                        <t t-set="section_type" t-value="'asset'"/>
                    </t>

                    <table class="ops-table-v2" width="100%" style="border-collapse: collapse; font-size: 9px; margin-bottom: 20px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #1e293b; background-color: #f8fafc;">
                                <th style="text-align: left; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 15%;">Code</th>
                                <th style="text-align: left; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 55%;">Account</th>
                                <th style="text-align: right; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 30%;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Hierarchical asset lines -->
                            <t t-foreach="hierarchy.get('asset_hierarchy', [])" t-as="line">
                                <t t-set="bal" t-value="line.get('balance', 0)"/>
                                <tr t-att-style="
                                    (line.get('is_subtotal') and 'border-top: 1px solid #e2e8f0; background-color: #f8fafc;' or '')
                                    + (line.get('type') == 'group' and 'background-color: #fafafa;' or '')
                                ">
                                    <td t-att-style="'padding: 6px 10px; padding-left: ' + str(10 + line.get('indent', 0) * 12) + 'px; color: #64748b; font-family: Consolas, Monaco, monospace; font-size: 8pt;'">
                                        <t t-esc="line.get('code', '')"/>
                                    </td>
                                    <td t-att-style="'padding: 6px 10px; padding-left: ' + str(10 + line.get('indent', 0) * 12) + 'px; color: #475569;'
                                        + (line.get('type') in ('group', 'subtotal') and ' font-weight: 600;' or '')
                                    ">
                                        <t t-esc="line.get('name', '')"/>
                                    </td>
                                    <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace;"
                                        t-att-style="(line.get('type') in ('group', 'subtotal') and 'font-weight: 600;' or '')">
                                        <t t-if="bal == 0"><span style="color: #94a3b8;">-</span></t>
                                        <t t-elif="bal &lt; 0"><span style="color: #dc2626;">(<t t-esc="'{:,.2f}'.format(abs(bal))"/>)</span></t>
                                        <t t-else=""><t t-esc="'{:,.2f}'.format(bal)"/></t>
                                    </td>
                                </tr>
                            </t>
                            <!-- Fallback: Flat section data if hierarchy is empty -->
                            <t t-if="not hierarchy.get('asset_hierarchy')">
                                <t t-foreach="report_data.get('sections', [])" t-as="section">
                                    <t t-if="section.get('type', '').startswith('asset_')">
                                        <tr style="background-color: #fafafa;">
                                            <td colspan="2" style="padding: 6px 10px; font-weight: 600; color: #475569; font-size: 9px;">
                                                <t t-esc="section.get('label', '')"/>
                                            </td>
                                            <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace; font-weight: 600;">
                                                <t t-esc="'{:,.2f}'.format(section.get('total_balance', 0))"/>
                                            </td>
                                        </tr>
                                        <t t-foreach="section.get('accounts', [])" t-as="acct">
                                            <t t-set="bal" t-value="acct.get('balance', 0)"/>
                                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                                <td style="padding: 6px 10px; padding-left: 22px; color: #64748b; font-family: Consolas, Monaco, monospace; font-size: 8pt;">
                                                    <t t-esc="acct.get('account_code', '')"/>
                                                </td>
                                                <td style="padding: 6px 10px; padding-left: 22px; color: #475569;">
                                                    <t t-esc="acct.get('account_name', '')"/>
                                                </td>
                                                <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace;">
                                                    <t t-if="bal == 0"><span style="color: #94a3b8;">-</span></t>
                                                    <t t-elif="bal &lt; 0"><span style="color: #dc2626;">(<t t-esc="'{:,.2f}'.format(abs(bal))"/>)</span></t>
                                                    <t t-else=""><t t-esc="'{:,.2f}'.format(bal)"/></t>
                                                </td>
                                            </tr>
                                        </t>
                                    </t>
                                </t>
                            </t>
                        </tbody>
                        <tfoot>
                            <tr class="subtotal-row" style="border-top: 2px solid #1e293b; border-bottom: 3px double #1e293b; background-color: #f1f5f9;">
                                <td colspan="2" style="padding: 10px 10px; font-weight: 700; font-size: 10px; text-transform: uppercase;">TOTAL ASSETS</td>
                                <td style="text-align: right; padding: 10px 10px; font-family: Consolas, Monaco, monospace; font-weight: 700; font-size: 10px; color: #16a34a;">
                                    <t t-esc="'{:,.2f}'.format(total_assets)"/>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- ==================== LIABILITIES SECTION ==================== -->
                    <t t-call="ops_matrix_accounting.ops_section_header_v2">
                        <t t-set="title" t-value="'LIABILITIES'"/>
                        <t t-set="section_type" t-value="'liability'"/>
                    </t>

                    <table class="ops-table-v2" width="100%" style="border-collapse: collapse; font-size: 9px; margin-bottom: 20px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #1e293b; background-color: #f8fafc;">
                                <th style="text-align: left; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 15%;">Code</th>
                                <th style="text-align: left; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 55%;">Account</th>
                                <th style="text-align: right; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 30%;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Hierarchical liability lines -->
                            <t t-foreach="hierarchy.get('liability_hierarchy', [])" t-as="line">
                                <t t-set="bal" t-value="abs(line.get('balance', 0))"/>
                                <tr t-att-style="
                                    (line.get('is_subtotal') and 'border-top: 1px solid #e2e8f0; background-color: #f8fafc;' or '')
                                    + (line.get('type') == 'group' and 'background-color: #fafafa;' or '')
                                ">
                                    <td t-att-style="'padding: 6px 10px; padding-left: ' + str(10 + line.get('indent', 0) * 12) + 'px; color: #64748b; font-family: Consolas, Monaco, monospace; font-size: 8pt;'">
                                        <t t-esc="line.get('code', '')"/>
                                    </td>
                                    <td t-att-style="'padding: 6px 10px; padding-left: ' + str(10 + line.get('indent', 0) * 12) + 'px; color: #475569;'
                                        + (line.get('type') in ('group', 'subtotal') and ' font-weight: 600;' or '')
                                    ">
                                        <t t-esc="line.get('name', '')"/>
                                    </td>
                                    <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace;"
                                        t-att-style="(line.get('type') in ('group', 'subtotal') and 'font-weight: 600;' or '')">
                                        <t t-if="bal == 0"><span style="color: #94a3b8;">-</span></t>
                                        <t t-else=""><t t-esc="'{:,.2f}'.format(bal)"/></t>
                                    </td>
                                </tr>
                            </t>
                            <!-- Fallback: Flat section data -->
                            <t t-if="not hierarchy.get('liability_hierarchy')">
                                <t t-foreach="report_data.get('sections', [])" t-as="section">
                                    <t t-if="section.get('type', '').startswith('liability_')">
                                        <tr style="background-color: #fafafa;">
                                            <td colspan="2" style="padding: 6px 10px; font-weight: 600; color: #475569; font-size: 9px;">
                                                <t t-esc="section.get('label', '')"/>
                                            </td>
                                            <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace; font-weight: 600;">
                                                <t t-esc="'{:,.2f}'.format(abs(section.get('total_balance', 0)))"/>
                                            </td>
                                        </tr>
                                        <t t-foreach="section.get('accounts', [])" t-as="acct">
                                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                                <td style="padding: 6px 10px; padding-left: 22px; color: #64748b; font-family: Consolas, Monaco, monospace; font-size: 8pt;">
                                                    <t t-esc="acct.get('account_code', '')"/>
                                                </td>
                                                <td style="padding: 6px 10px; padding-left: 22px; color: #475569;">
                                                    <t t-esc="acct.get('account_name', '')"/>
                                                </td>
                                                <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace;">
                                                    <t t-esc="'{:,.2f}'.format(abs(acct.get('balance', 0)))"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </t>
                                </t>
                            </t>
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid #1e293b; background-color: #f1f5f9;">
                                <td colspan="2" style="padding: 8px 10px; font-weight: 700; text-transform: uppercase; font-size: 10px;">TOTAL LIABILITIES</td>
                                <td style="text-align: right; padding: 8px 10px; font-family: Consolas, Monaco, monospace; font-weight: 700; font-size: 10px; color: #f59e0b;">
                                    <t t-esc="'{:,.2f}'.format(total_liabilities)"/>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- ==================== EQUITY SECTION ==================== -->
                    <t t-call="ops_matrix_accounting.ops_section_header_v2">
                        <t t-set="title" t-value="'SHAREHOLDERS&#39; EQUITY'"/>
                        <t t-set="section_type" t-value="'equity'"/>
                    </t>

                    <table class="ops-table-v2" width="100%" style="border-collapse: collapse; font-size: 9px; margin-bottom: 20px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #1e293b; background-color: #f8fafc;">
                                <th style="text-align: left; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 15%;">Code</th>
                                <th style="text-align: left; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 55%;">Account</th>
                                <th style="text-align: right; padding: 8px 10px; font-weight: 600; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b; width: 30%;">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Hierarchical equity lines -->
                            <t t-foreach="hierarchy.get('equity_hierarchy', [])" t-as="line">
                                <t t-set="bal" t-value="abs(line.get('balance', 0))"/>
                                <tr t-att-style="
                                    (line.get('is_subtotal') and 'border-top: 1px solid #e2e8f0; background-color: #f8fafc;' or '')
                                    + (line.get('type') == 'group' and 'background-color: #fafafa;' or '')
                                ">
                                    <td t-att-style="'padding: 6px 10px; padding-left: ' + str(10 + line.get('indent', 0) * 12) + 'px; color: #64748b; font-family: Consolas, Monaco, monospace; font-size: 8pt;'">
                                        <t t-esc="line.get('code', '')"/>
                                    </td>
                                    <td t-att-style="'padding: 6px 10px; padding-left: ' + str(10 + line.get('indent', 0) * 12) + 'px; color: #475569;'
                                        + (line.get('type') in ('group', 'subtotal') and ' font-weight: 600;' or '')
                                    ">
                                        <t t-esc="line.get('name', '')"/>
                                    </td>
                                    <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace;"
                                        t-att-style="(line.get('type') in ('group', 'subtotal') and 'font-weight: 600;' or '')">
                                        <t t-if="bal == 0"><span style="color: #94a3b8;">-</span></t>
                                        <t t-else=""><t t-esc="'{:,.2f}'.format(bal)"/></t>
                                    </td>
                                </tr>
                            </t>
                            <!-- Fallback: Flat section data -->
                            <t t-if="not hierarchy.get('equity_hierarchy')">
                                <t t-foreach="report_data.get('sections', [])" t-as="section">
                                    <t t-if="section.get('type', '').startswith('equity')">
                                        <tr style="background-color: #fafafa;">
                                            <td colspan="2" style="padding: 6px 10px; font-weight: 600; color: #475569; font-size: 9px;">
                                                <t t-esc="section.get('label', '')"/>
                                            </td>
                                            <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace; font-weight: 600;">
                                                <t t-esc="'{:,.2f}'.format(abs(section.get('total_balance', 0)))"/>
                                            </td>
                                        </tr>
                                        <t t-foreach="section.get('accounts', [])" t-as="acct">
                                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                                <td style="padding: 6px 10px; padding-left: 22px; color: #64748b; font-family: Consolas, Monaco, monospace; font-size: 8pt;">
                                                    <t t-esc="acct.get('account_code', '')"/>
                                                </td>
                                                <td style="padding: 6px 10px; padding-left: 22px; color: #475569;">
                                                    <t t-esc="acct.get('account_name', '')"/>
                                                </td>
                                                <td style="text-align: right; padding: 6px 10px; font-family: Consolas, Monaco, monospace;">
                                                    <t t-esc="'{:,.2f}'.format(abs(acct.get('balance', 0)))"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </t>
                                </t>
                            </t>
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid #1e293b; background-color: #f1f5f9;">
                                <td colspan="2" style="padding: 8px 10px; font-weight: 700; text-transform: uppercase; font-size: 10px;">TOTAL EQUITY</td>
                                <td style="text-align: right; padding: 8px 10px; font-family: Consolas, Monaco, monospace; font-weight: 700; font-size: 10px; color: #8b5cf6;">
                                    <t t-esc="'{:,.2f}'.format(total_equity)"/>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- ==================== GRAND TOTAL: LIABILITIES + EQUITY ==================== -->
                    <t t-call="ops_matrix_accounting.ops_grand_total_v2">
                        <t t-set="label" t-value="'TOTAL LIABILITIES + EQUITY'"/>
                        <t t-set="subtitle" t-value="'Must equal Total Assets (A = L + E)'"/>
                        <t t-set="amount" t-value="total_liabilities + total_equity"/>
                    </t>

                    <!-- Notes -->
                    <t t-call="ops_matrix_accounting.ops_notes_section_v2">
                        <t t-set="notes_items" t-value="[
                            'Balance Sheet shows the company position at a specific point in time',
                            'Fundamental equation: Assets = Liabilities + Shareholders\' Equity',
                            'Liabilities and equity balances displayed as absolute values',
                            'Negative asset values shown in red with parentheses',
                            'All figures exclude unposted entries unless All Entries filter is selected',
                        ]"/>
                    </t>

                </t>
            </t>
        </t>
    </template>

</odoo>
