<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS INVOICE / CREDIT NOTE
         Inherits native account.report_invoice_document via XPath.

         NOTE: The native template's page div has class="page mb-4"
         and is wrapped in <div class="clearfix invoice_main">.
         ================================================================ -->

    <!-- Re-enable and style native invoice report actions -->
    <record id="account.account_invoices" model="ir.actions.report">
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
    </record>
    <record id="account.account_invoices_without_payment" model="ir.actions.report">
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
    </record>

    <template id="report_invoice_document_ops"
              name="OPS Invoice Document"
              inherit_id="account.report_invoice_document"
              priority="99">

        <xpath expr="//div[@class='page mb-4']" position="replace">
            <div class="page mb-4 ops-report-page">
                <!-- Alias o -> doc -->
                <t t-set="doc" t-value="o"/>
                <t t-set="company" t-value="doc.company_id"/>
                <t t-set="_ops" t-value="company.get_ops_report_settings()"/>
                <t t-set="is_credit_note" t-value="doc.move_type == 'out_refund'"/>
                <t t-set="is_vendor" t-value="doc.move_type in ('in_invoice', 'in_refund')"/>

                <!-- CSS -->
                <t t-call="ops_theme.ops_report_css"/>

                <!-- Title Bar -->
                <t t-set="doc_title" t-value="
                    'Credit Note' if doc.move_type == 'out_refund' else
                    'Tax Invoice' if doc.move_type == 'out_invoice' else
                    'Vendor Bill' if doc.move_type == 'in_invoice' else
                    'Vendor Credit Note' if doc.move_type == 'in_refund' else 'Document'
                "/>
                <t t-set="doc_ref" t-value="doc.name"/>
                <t t-set="title_bg" t-value="'#dc2626' if is_credit_note else False"/>
                <t t-set="doc_status" t-value="'PAID' if doc.payment_state == 'paid' else ('PARTIAL' if doc.payment_state == 'partial' else False)"/>
                <t t-call="ops_theme.ops_title_bar"/>

                <!-- Credit Note Reference -->
                <t t-if="is_credit_note and doc.reversed_entry_id">
                    <div style="margin-bottom:10px; padding:6px 10px; background:#fef2f2; border-left:3px solid #dc2626; border-radius:3px; font-size:8pt; color:#991b1b;">
                        Credit Note for Invoice: <strong><t t-esc="doc.reversed_entry_id.name"/></strong>
                    </div>
                </t>

                <!-- Partial Payment Notice -->
                <t t-if="not is_credit_note and doc.payment_state == 'partial'">
                    <div style="margin-bottom:10px; padding:6px 10px; background:#fef3c7; border-left:3px solid #d97706; border-radius:3px; font-size:8pt; color:#92400e;">
                        Partial payment received â€” Balance due:
                        <strong><t t-esc="doc.amount_residual" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/></strong>
                    </div>
                </t>

                <!-- Addresses -->
                <table style="width:100%; border-collapse:collapse; margin-bottom:14px;">
                    <tr>
                        <td style="width:50%; vertical-align:top; padding-right:10px;">
                            <t t-call="ops_theme.ops_address_block">
                                <t t-set="partner" t-value="doc.partner_id"/>
                                <t t-set="addr_label" t-value="'Vendor' if is_vendor else 'Bill To'"/>
                            </t>
                        </td>
                        <td style="width:50%; vertical-align:top; padding-left:10px;">
                            <t t-if="not is_vendor and doc.partner_shipping_id and doc.partner_shipping_id != doc.partner_id">
                                <t t-call="ops_theme.ops_address_block">
                                    <t t-set="partner" t-value="doc.partner_shipping_id"/>
                                    <t t-set="addr_label" t-value="'Ship To'"/>
                                </t>
                            </t>
                        </td>
                    </tr>
                </table>

                <!-- Info Bar -->
                <table t-attf-style="width:100%; border-collapse:collapse; margin-bottom:14px; border:1px solid rgba(#{_ops['rgb']},0.12); border-radius:3px;">
                    <tr t-attf-style="background:rgba(#{_ops['rgb']},0.04);">
                        <td t-if="doc.invoice_date" style="padding:6px 10px; text-align:center; border-right:1px solid #e2e8f0;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">
                                <t t-if="is_vendor">Bill Date</t><t t-else="">Invoice Date</t>
                            </div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;">
                                <t t-esc="doc.invoice_date" t-options="{'widget': 'date'}"/>
                            </div>
                        </td>
                        <td t-if="doc.invoice_date_due" style="padding:6px 10px; text-align:center; border-right:1px solid #e2e8f0;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Due Date</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;">
                                <t t-esc="doc.invoice_date_due" t-options="{'widget': 'date'}"/>
                            </div>
                        </td>
                        <td t-if="doc.ref" style="padding:6px 10px; text-align:center; border-right:1px solid #e2e8f0;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Reference</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.ref"/></div>
                        </td>
                        <td t-if="doc.invoice_origin" style="padding:6px 10px; text-align:center; border-right:1px solid #e2e8f0;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Source Document</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.invoice_origin"/></div>
                        </td>
                        <td t-if="doc.invoice_payment_term_id" style="padding:6px 10px; text-align:center;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Payment Terms</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.invoice_payment_term_id.name"/></div>
                        </td>
                    </tr>
                </table>

                <!-- Line Items -->
                <t t-set="inv_lines" t-value="doc.invoice_line_ids.sorted(key=lambda l: (l.sequence, l.id))"/>
                <t t-set="has_discount" t-value="any(l.discount for l in inv_lines if not l.display_type)"/>
                <t t-set="has_tax" t-value="any(l.tax_ids for l in inv_lines if not l.display_type)"/>

                <table class="ops-items-table">
                    <thead>
                        <tr t-attf-style="background:#{title_bg or _ops['primary']}; color:#{_ops['text_on_primary']};">
                            <th style="width:4%;" class="ctr">#</th>
                            <th>Description</th>
                            <th style="width:7%;" class="ctr">Account</th>
                            <th style="width:8%;" class="num">Qty</th>
                            <th style="width:12%;" class="num">Unit Price</th>
                            <th t-if="has_discount" style="width:7%;" class="num">Disc.%</th>
                            <th t-if="has_tax" style="width:10%;" class="ctr">Tax</th>
                            <th style="width:14%;" class="num">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="line_num" t-value="0"/>
                        <t t-foreach="inv_lines" t-as="line">
                            <t t-if="line.display_type == 'line_section'">
                                <tr><td colspan="99" t-attf-style="padding:8px 8px 4px; font-weight:600; font-size:9pt; border-bottom:1px solid rgba(#{_ops['rgb']},0.25); color:#{_ops['primary']};"><t t-esc="line.name"/></td></tr>
                            </t>
                            <t t-if="line.display_type == 'line_note'">
                                <tr><td colspan="99" style="padding:2px 8px 2px 18px; font-style:italic; font-size:8pt; color:#64748b;"><t t-esc="line.name"/></td></tr>
                            </t>
                            <t t-if="not line.display_type">
                                <t t-set="line_num" t-value="line_num + 1"/>
                                <tr>
                                    <td class="ctr" style="color:#94a3b8; font-size:8pt;"><t t-esc="line_num"/></td>
                                    <td>
                                        <t t-if="_ops.get('show_code') and line.product_id and line.product_id.default_code">
                                            <span class="ops-product-code">[<t t-esc="line.product_id.default_code"/>]</span><br/>
                                        </t>
                                        <span t-esc="line.name"/>
                                    </td>
                                    <td class="ctr" style="font-size:7pt; color:#94a3b8;">
                                        <t t-if="line.account_id" t-esc="line.account_id.code"/>
                                    </td>
                                    <td class="num"><t t-esc="line.quantity" t-options="{'widget':'float','precision':2}"/></td>
                                    <td class="num"><t t-esc="line.price_unit" t-options="{'widget':'monetary','display_currency':doc.currency_id}"/></td>
                                    <td t-if="has_discount" class="num">
                                        <t t-if="line.discount"><t t-esc="line.discount" t-options="{'widget':'float','precision':1}"/>%</t>
                                    </td>
                                    <td t-if="has_tax" class="ctr" style="font-size:7.5pt; color:#64748b;">
                                        <t t-if="line.tax_ids" t-esc="', '.join(line.tax_ids.mapped('name'))"/>
                                    </td>
                                    <td class="num" style="font-weight:500;">
                                        <t t-esc="line.price_subtotal" t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>

                <!-- Totals -->
                <t t-set="amount_untaxed" t-value="doc.amount_untaxed"/>
                <t t-set="amount_tax" t-value="doc.amount_tax"/>
                <t t-set="amount_total" t-value="doc.amount_total"/>
                <t t-set="currency" t-value="doc.currency_id"/>
                <t t-set="total_label" t-value="'Credit Total' if is_credit_note else 'Total Due'"/>
                <t t-set="total_bg" t-value="'#dc2626' if is_credit_note else False"/>
                <t t-set="amount_paid" t-value="doc.amount_total - doc.amount_residual if not is_credit_note and doc.payment_state == 'partial' else False"/>
                <t t-set="amount_residual" t-value="doc.amount_residual if not is_credit_note and doc.payment_state == 'partial' else False"/>
                <t t-call="ops_theme.ops_totals_block"/>

                <!-- Bottom section -->
                <t t-set="amount_for_words" t-value="doc.amount_total"/>
                <t t-set="currency_for_words" t-value="doc.currency_id"/>
                <t t-set="doc_note" t-value="doc.narration"/>
                <t t-call="ops_theme.ops_bottom_section"/>

                <!-- XPath anchors for account.report_invoice_document_preview
                     (primary inherit that expects these elements in the base) -->
                <div class="mb-3" t-if="o.move_type in ('out_invoice', 'in_refund') and o.payment_reference" style="display:none;">
                    <p name="payment_communication">
                        <t t-if="o.partner_bank_id"/>
                    </p>
                </div>
                <div id="qrcode" style="display:none;"/>

            </div>
        </xpath>

    </template>

</odoo>
