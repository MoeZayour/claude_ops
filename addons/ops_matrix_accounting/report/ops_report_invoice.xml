<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- OPS Invoice / Credit Note Report Action -->
    <record id="action_report_ops_invoice" model="ir.actions.report">
        <field name="name">Invoice / Credit Note (OPS)</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_ops_invoice</field>
        <field name="report_file">ops_matrix_accounting.report_ops_invoice</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="print_report_name">(object.move_type == 'out_refund' and 'Credit Note - %s' or 'Invoice - %s') % object.name</field>
    </record>

    <!-- Main Invoice Template -->
    <template id="report_ops_invoice">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-if="doc.move_type in ('out_invoice', 'out_refund')">
                    <t t-call="ops_matrix_accounting.report_ops_invoice_document"/>
                </t>
            </t>
        </t>
    </template>

    <!-- Invoice Document Template -->
    <template id="report_ops_invoice_document">
        <t t-set="company" t-value="doc.company_id or env.company"/>
        <t t-set="primary_color" t-value="company.ops_primary_color or '#1e293b'"/>
        <t t-set="show_badge" t-value="company.ops_show_external_badge"/>
        <t t-set="amount_lang" t-value="company.ops_amount_words_lang or 'en'"/>
        <t t-set="is_credit_note" t-value="doc.move_type == 'out_refund'"/>
        <t t-set="doc_title" t-value="'Credit Note' if is_credit_note else 'Tax Invoice'"/>

        <div class="article ops-external-doc" t-attf-style="--ops-primary: #{primary_color};">

            <!-- LETTERHEAD -->
            <div class="ops-letterhead">
                <div class="ops-company-block">
                    <img t-if="company.logo" class="ops-company-logo"
                         t-att-src="image_data_uri(company.logo)"/>
                    <div t-else="" class="ops-company-logo-placeholder">
                        <t t-esc="(company.name or 'CO')[:2].upper()"/>
                    </div>
                    <div>
                        <div class="ops-company-name"><t t-esc="company.name"/></div>
                        <div class="ops-company-details">
                            <t t-if="company.street"><t t-esc="company.street"/><br/></t>
                            <t t-if="company.street2"><t t-esc="company.street2"/><br/></t>
                            <t t-if="company.city"><t t-esc="company.city"/></t>
                            <t t-if="company.country_id">, <t t-esc="company.country_id.name"/></t><br/>
                            <t t-if="company.phone">Tel: <t t-esc="company.phone"/></t>
                            <t t-if="company.email"> | <t t-esc="company.email"/></t><br/>
                            <t t-if="company.company_registry">CR: <t t-esc="company.company_registry"/></t>
                            <t t-if="company.vat"> | VAT: <t t-esc="company.vat"/></t>
                        </div>
                    </div>
                </div>
                <div class="ops-doc-meta">
                    <div class="ops-doc-ref"><t t-esc="doc.name"/></div>
                    Invoice Date: <t t-esc="doc.invoice_date" t-options='{"widget": "date"}'/><br/>
                    <t t-if="doc.invoice_date_due">Due Date: <t t-esc="doc.invoice_date_due" t-options='{"widget": "date"}'/><br/></t>
                    <t t-if="doc.invoice_user_id">Salesperson: <t t-esc="doc.invoice_user_id.name"/><br/></t>
                    <t t-if="doc.ops_branch_id">Branch: <t t-esc="doc.ops_branch_id.name"/></t>
                </div>
            </div>

            <!-- TITLE BAR -->
            <div t-attf-class="ops-title-bar #{'credit-note' if is_credit_note else ''}">
                <h2><t t-esc="doc_title"/></h2>
                <span class="ops-doc-status">
                    <t t-if="doc.payment_state == 'paid'">PAID</t>
                    <t t-elif="doc.payment_state == 'partial'">PARTIAL</t>
                    <t t-elif="doc.state == 'posted'">POSTED</t>
                    <t t-else=""><t t-esc="doc.state"/></t>
                </span>
            </div>

            <!-- PAYMENT STATUS -->
            <t t-if="not is_credit_note and doc.state == 'posted'">
                <div t-if="doc.payment_state == 'paid'" class="ops-payment-status paid">
                    This invoice has been paid in full
                </div>
                <div t-elif="doc.payment_state == 'partial'" class="ops-payment-status partial">
                    Partial payment received â€” Balance due: <t t-esc="'{:,.2f}'.format(doc.amount_residual)"/> <t t-esc="doc.currency_id.name"/>
                </div>
            </t>

            <!-- CREDIT NOTE REFERENCE -->
            <t t-if="is_credit_note and doc.reversed_entry_id">
                <div class="ops-payment-status unpaid">
                    Credit Note for Invoice: <t t-esc="doc.reversed_entry_id.name"/>
                </div>
            </t>

            <!-- ADDRESS BLOCKS -->
            <div class="ops-address-row">
                <div class="ops-address-block">
                    <div class="ops-address-label">Bill To</div>
                    <div class="ops-address-name"><t t-esc="doc.partner_id.name"/></div>
                    <div class="ops-address-details">
                        <t t-if="doc.partner_id.street"><t t-esc="doc.partner_id.street"/><br/></t>
                        <t t-if="doc.partner_id.street2"><t t-esc="doc.partner_id.street2"/><br/></t>
                        <t t-if="doc.partner_id.city"><t t-esc="doc.partner_id.city"/></t>
                        <t t-if="doc.partner_id.country_id">, <t t-esc="doc.partner_id.country_id.name"/></t><br/>
                        <t t-if="doc.partner_id.vat">VAT: <t t-esc="doc.partner_id.vat"/></t>
                    </div>
                </div>
                <div class="ops-address-block" t-if="doc.partner_shipping_id and doc.partner_shipping_id != doc.partner_id">
                    <div class="ops-address-label">Ship To</div>
                    <div class="ops-address-name"><t t-esc="doc.partner_shipping_id.name"/></div>
                    <div class="ops-address-details">
                        <t t-if="doc.partner_shipping_id.street"><t t-esc="doc.partner_shipping_id.street"/><br/></t>
                        <t t-if="doc.partner_shipping_id.city"><t t-esc="doc.partner_shipping_id.city"/></t>
                        <t t-if="doc.partner_shipping_id.country_id">, <t t-esc="doc.partner_shipping_id.country_id.name"/></t>
                    </div>
                </div>
            </div>

            <!-- INFO BAR -->
            <div class="ops-info-bar">
                <div class="ops-info-cell" t-if="doc.ref">
                    <div class="ops-info-label">Reference</div>
                    <div class="ops-info-value"><t t-esc="doc.ref"/></div>
                </div>
                <div class="ops-info-cell" t-if="doc.invoice_origin">
                    <div class="ops-info-label">Source Document</div>
                    <div class="ops-info-value"><t t-esc="doc.invoice_origin"/></div>
                </div>
                <div class="ops-info-cell" t-if="doc.invoice_payment_term_id">
                    <div class="ops-info-label">Payment Terms</div>
                    <div class="ops-info-value"><t t-esc="doc.invoice_payment_term_id.name"/></div>
                </div>
                <div class="ops-info-cell">
                    <div class="ops-info-label">Currency</div>
                    <div class="ops-info-value"><t t-esc="doc.currency_id.name"/></div>
                </div>
            </div>

            <!-- LINE ITEMS TABLE -->
            <table class="ops-items-table">
                <thead>
                    <tr>
                        <th style="width: 25px;">#</th>
                        <th style="width: 70px;">Code</th>
                        <th>Description</th>
                        <th style="width: 60px;">Account</th>
                        <th style="width: 45px;" class="num">Qty</th>
                        <th style="width: 70px;" class="num">Unit Price</th>
                        <th style="width: 45px;" class="num">Disc%</th>
                        <th style="width: 50px;" class="num">Tax</th>
                        <th style="width: 80px;" class="num">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-set="line_num" t-value="0"/>
                    <t t-foreach="doc.invoice_line_ids.sorted(key=lambda l: (l.sequence, l.id))" t-as="line">
                        <t t-if="not line.display_type">
                            <t t-set="line_num" t-value="line_num + 1"/>
                            <tr>
                                <td><t t-esc="line_num"/></td>
                                <td><t t-esc="line.product_id.default_code or '-'"/></td>
                                <td>
                                    <strong><t t-esc="line.product_id.name or line.name"/></strong>
                                    <t t-if="line.name and line.product_id and line.name != line.product_id.name">
                                        <span class="ops-item-code"><t t-esc="line.name[:80]"/></span>
                                    </t>
                                </td>
                                <td style="font-size: 7pt; color: #94a3b8;">
                                    <t t-esc="line.account_id.code or ''"/>
                                </td>
                                <td class="num"><t t-esc="'{:,.2f}'.format(line.quantity)"/></td>
                                <td class="num"><t t-esc="'{:,.2f}'.format(line.price_unit)"/></td>
                                <td class="num">
                                    <t t-if="line.discount"><t t-esc="'{:.1f}'.format(line.discount)"/>%</t>
                                </td>
                                <td class="num">
                                    <t t-if="line.tax_ids">
                                        <t t-esc="', '.join(line.tax_ids.mapped('name'))"/>
                                    </t>
                                </td>
                                <td class="num" style="font-weight: 600;">
                                    <t t-esc="'{:,.2f}'.format(line.price_subtotal)"/>
                                </td>
                            </tr>
                        </t>
                        <t t-if="line.display_type == 'line_section'">
                            <tr>
                                <td colspan="9" style="font-weight: 700; background: #f1f5f9; padding-top: 10px;">
                                    <t t-esc="line.name"/>
                                </td>
                            </tr>
                        </t>
                        <t t-if="line.display_type == 'line_note'">
                            <tr>
                                <td colspan="9" style="font-style: italic; color: #64748b;">
                                    <t t-esc="line.name"/>
                                </td>
                            </tr>
                        </t>
                    </t>
                </tbody>
            </table>

            <!-- TOTALS -->
            <div class="ops-totals-wrapper">
                <div class="ops-totals-block">
                    <div class="ops-totals-line">
                        <span class="t-label">Subtotal</span>
                        <span class="t-value"><t t-esc="'{:,.2f}'.format(doc.amount_untaxed)"/></span>
                    </div>
                    <t t-if="doc.tax_totals and doc.tax_totals.get('has_tax_groups')">
                        <t t-foreach="doc.tax_totals.get('subtotals', [])" t-as="subtotal">
                            <t t-foreach="subtotal.get('tax_groups', [])" t-as="tax_group">
                                <div class="ops-totals-line">
                                    <span class="t-label"><t t-esc="tax_group.get('group_name', 'Tax')"/></span>
                                    <span class="t-value"><t t-esc="'{:,.2f}'.format(tax_group.get('tax_amount_currency', 0))"/></span>
                                </div>
                            </t>
                        </t>
                    </t>
                    <t t-else="">
                        <div class="ops-totals-line">
                            <span class="t-label">Tax</span>
                            <span class="t-value"><t t-esc="'{:,.2f}'.format(doc.amount_tax)"/></span>
                        </div>
                    </t>
                    <div t-attf-class="ops-totals-line grand-total #{'credit-note' if is_credit_note else ''}">
                        <span class="t-label"><t t-if="is_credit_note">Credit Total</t><t t-else="">Total Due</t></span>
                        <span class="t-value">
                            <t t-esc="'{:,.2f}'.format(doc.amount_total)"/>
                            <span style="font-size: 8pt; font-weight: 500; opacity: 0.8; margin-left: 4px;">
                                <t t-esc="doc.currency_id.name"/>
                            </span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- AMOUNT PAID / BALANCE DUE (for invoices) -->
            <t t-if="not is_credit_note and doc.payment_state == 'partial'">
                <div class="ops-totals-wrapper" style="margin-top: -8px;">
                    <div class="ops-totals-block" style="border-top: 1px solid #e2e8f0;">
                        <div class="ops-totals-line">
                            <span class="t-label">Amount Paid</span>
                            <span class="t-value" style="color: #16a34a;">
                                <t t-esc="'{:,.2f}'.format(doc.amount_total - doc.amount_residual)"/>
                            </span>
                        </div>
                        <div class="ops-totals-line" style="background: #fef3c7; border-radius: 0 0 4px 4px;">
                            <span class="t-label" style="font-weight: 600; color: #92400e;">Balance Due</span>
                            <span class="t-value" style="font-weight: 700; color: #92400e; font-size: 11pt;">
                                <t t-esc="'{:,.2f}'.format(doc.amount_residual)"/>
                            </span>
                        </div>
                    </div>
                </div>
            </t>

            <!-- AMOUNT IN WORDS -->
            <t t-set="amount_words" t-value="env['ops.report.helpers'].amount_to_words(doc.amount_total, doc.currency_id, amount_lang)"/>
            <div class="ops-amount-words" t-if="amount_words">
                <div class="aw-label">Amount in Words</div>
                <div class="aw-text" t-if="amount_words.get('en')"><t t-esc="amount_words.get('en')"/></div>
                <div class="aw-text aw-arabic" t-if="amount_words.get('ar')"><t t-esc="amount_words.get('ar')"/></div>
            </div>

            <!-- BANK DETAILS (for unpaid invoices) -->
            <div class="ops-bank-details" t-if="not is_credit_note and doc.payment_state != 'paid' and company.bank_ids">
                <h4>Bank Details for Payment</h4>
                <t t-set="bank" t-value="company.bank_ids[0]"/>
                <div class="ops-bank-grid">
                    <div class="ops-bank-item">
                        <span class="b-label">Bank:</span>
                        <span class="b-value"><t t-esc="bank.bank_id.name or bank.bank_name or '-'"/></span>
                    </div>
                    <div class="ops-bank-item" t-if="bank.bank_id.bic">
                        <span class="b-label">SWIFT:</span>
                        <span class="b-value"><t t-esc="bank.bank_id.bic"/></span>
                    </div>
                    <div class="ops-bank-item">
                        <span class="b-label">Account:</span>
                        <span class="b-value"><t t-esc="bank.acc_number or '-'"/></span>
                    </div>
                    <div class="ops-bank-item" t-if="bank.acc_holder_name">
                        <span class="b-label">Holder:</span>
                        <span class="b-value"><t t-esc="bank.acc_holder_name"/></span>
                    </div>
                </div>
            </div>

            <!-- TERMS -->
            <div class="ops-terms" t-if="doc.narration">
                <h4>Terms &amp; Conditions</h4>
                <p><t t-esc="doc.narration"/></p>
            </div>

            <!-- FOOTER -->
            <div class="ops-footer">
                <div class="ops-footer-company">
                    <strong><t t-esc="company.name"/></strong>
                    <t t-if="company.company_registry"> | CR: <t t-esc="company.company_registry"/></t>
                    <t t-if="company.vat"> | VAT: <t t-esc="company.vat"/></t>
                    <t t-if="company.website"> | <t t-esc="company.website"/></t>
                </div>
                <div class="ops-footer-right">
                    <div t-if="show_badge" class="ops-external-badge">
                        <span class="powered-by">Powered by</span>
                        <span class="badge">OPS Framework</span>
                    </div>
                    <span class="ops-page-number">Page <span class="page"/> of <span class="topage"/></span>
                </div>
            </div>

        </div>
    </template>

</odoo>
