<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS INVOICE / CREDIT NOTE

         Uses: ops_theme.external_layout_ops via web.external_layout
         Models: account.move, account.move.line
         Fields verified against Odoo 19 field inventory 2026-02-08
         ================================================================ -->

    <!-- ======================== REPORT ACTION ======================== -->
    <record id="action_report_ops_invoice" model="ir.actions.report">
        <field name="name">Invoice / Credit Note (OPS)</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_ops_invoice</field>
        <field name="report_file">ops_matrix_accounting.report_ops_invoice</field>
        <field name="print_report_name">
            (object.move_type == 'out_invoice' and 'Invoice' or
             object.move_type == 'out_refund' and 'Credit Note' or
             object.move_type == 'in_invoice' and 'Vendor Bill' or
             object.move_type == 'in_refund' and 'Vendor Credit Note' or
             'Document') + ' - ' + (object.name or '')
        </field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
    </record>

    <!-- Deactivate Odoo native invoice report bindings -->
    <record id="account.account_invoices_without_payment" model="ir.actions.report">
        <field name="binding_model_id" eval="False"/>
    </record>
    <record id="account.account_invoices" model="ir.actions.report">
        <field name="binding_model_id" eval="False"/>
    </record>

    <!-- ======================== MAIN WRAPPER ========================= -->
    <template id="report_ops_invoice">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="ops_matrix_accounting.report_ops_invoice_document"/>
            </t>
        </t>
    </template>

    <!-- ======================== DOCUMENT BODY ======================== -->
    <template id="report_ops_invoice_document">
        <t t-set="company" t-value="doc.company_id"/>
        <t t-set="ops_primary" t-value="company.ops_report_primary_color or '#3d58a3'"/>
        <t t-set="ops_text_on_primary" t-value="company.ops_report_text_on_primary or '#FFFFFF'"/>
        <t t-set="ops_rgb" t-value="'%s,%s,%s' % (int(ops_primary[1:3], 16), int(ops_primary[3:5], 16), int(ops_primary[5:7], 16)) if ops_primary.startswith('#') and len(ops_primary) == 7 else '61,88,163'"/>
        <!-- Standard color aliases for shared components -->
        <t t-set="pc" t-value="ops_primary"/>
        <t t-set="tc" t-value="ops_text_on_primary"/>
        <t t-set="pl" t-value="company.get_report_primary_light()"/>
        <t t-set="pd" t-value="company.get_report_primary_dark()"/>
        <t t-set="body_text_color" t-value="company.ops_report_body_text_color or '#1a1a1a'"/>
        <t t-set="is_credit_note" t-value="doc.move_type == 'out_refund'"/>
        <t t-set="is_vendor" t-value="doc.move_type in ('in_invoice', 'in_refund')"/>

        <t t-call="web.external_layout">
            <div class="page" style="font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 9pt;">

                <!-- ========== TITLE BAR ========== -->
                <t t-set="title_bg" t-value="'#dc2626' if is_credit_note else ops_primary"/>
                <t t-set="doc_title" t-value="
                    'Credit Note' if doc.move_type == 'out_refund' else
                    'Tax Invoice' if doc.move_type == 'out_invoice' else
                    'Vendor Bill' if doc.move_type == 'in_invoice' else
                    'Vendor Credit Note' if doc.move_type == 'in_refund' else 'Document'
                "/>
                <div t-attf-style="background: #{title_bg}; color: #{ops_text_on_primary}; padding: 10px 14px; border-radius: 3px; margin-bottom: 14px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="font-size: 14pt; font-weight: 700;">
                                <t t-esc="doc_title"/>
                            </td>
                            <td style="text-align: right;">
                                <div style="font-size: 12pt; font-weight: 600;">
                                    <t t-esc="doc.name"/>
                                </div>
                                <!-- Payment status badge -->
                                <t t-if="doc.payment_state == 'paid'">
                                    <span style="background: #16a34a; color: white; padding: 2px 8px; border-radius: 2px; font-size: 7pt; font-weight: 600; text-transform: uppercase;">PAID</span>
                                </t>
                                <t t-elif="doc.payment_state == 'partial'">
                                    <span style="background: #d97706; color: white; padding: 2px 8px; border-radius: 2px; font-size: 7pt; font-weight: 600; text-transform: uppercase;">PARTIAL</span>
                                </t>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- ========== CREDIT NOTE REFERENCE ========== -->
                <t t-if="is_credit_note and doc.reversed_entry_id">
                    <div style="margin-bottom: 10px; padding: 6px 10px; background: #fef2f2; border-left: 3px solid #dc2626; border-radius: 3px; font-size: 8pt; color: #991b1b;">
                        Credit Note for Invoice: <strong><t t-esc="doc.reversed_entry_id.name"/></strong>
                    </div>
                </t>

                <!-- ========== PARTIAL PAYMENT NOTICE ========== -->
                <t t-if="not is_credit_note and doc.payment_state == 'partial'">
                    <div style="margin-bottom: 10px; padding: 6px 10px; background: #fef3c7; border-left: 3px solid #d97706; border-radius: 3px; font-size: 8pt; color: #92400e;">
                        Partial payment received -- Balance due:
                        <strong><t t-esc="doc.amount_residual" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/></strong>
                    </div>
                </t>

                <!-- ========== ADDRESS BLOCKS ========== -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 14px;">
                    <tr>
                        <td style="width: 50%; vertical-align: top; padding-right: 15px;">
                            <t t-call="ops_theme.ops_address_block">
                                <t t-set="partner" t-value="doc.partner_id"/>
                                <t t-set="addr_label" t-value="'Vendor' if is_vendor else 'Bill To'"/>
                            </t>
                        </td>
                        <td style="width: 50%; vertical-align: top; padding-left: 15px;">
                            <t t-if="not is_vendor and doc.partner_shipping_id and doc.partner_shipping_id != doc.partner_id">
                                <t t-call="ops_theme.ops_address_block">
                                    <t t-set="partner" t-value="doc.partner_shipping_id"/>
                                    <t t-set="addr_label" t-value="'Ship To'"/>
                                </t>
                            </t>
                        </td>
                    </tr>
                </table>

                <!-- ========== INFO BAR ========== -->
                <table t-attf-style="width: 100%; border-collapse: collapse; margin-bottom: 14px; border: 1px solid rgba(#{ops_rgb}, 0.12); border-radius: 3px;">
                    <tr t-attf-style="background: rgba(#{ops_rgb}, 0.04);">
                        <td t-if="doc.invoice_date" style="padding: 6px 10px; text-align: center; border-right: 1px solid #e2e8f0;">
                            <div style="font-size: 6.5pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b;">
                                <t t-if="is_vendor">Bill Date</t><t t-else="">Invoice Date</t>
                            </div>
                            <div style="font-size: 8.5pt; font-weight: 500; margin-top: 2px; color: #1e293b;">
                                <t t-esc="doc.invoice_date" t-options="{'widget': 'date'}"/>
                            </div>
                        </td>
                        <td t-if="doc.invoice_date_due" style="padding: 6px 10px; text-align: center; border-right: 1px solid #e2e8f0;">
                            <div style="font-size: 6.5pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b;">Due Date</div>
                            <div style="font-size: 8.5pt; font-weight: 500; margin-top: 2px; color: #1e293b;">
                                <t t-esc="doc.invoice_date_due" t-options="{'widget': 'date'}"/>
                            </div>
                        </td>
                        <td t-if="doc.ref" style="padding: 6px 10px; text-align: center; border-right: 1px solid #e2e8f0;">
                            <div style="font-size: 6.5pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b;">Reference</div>
                            <div style="font-size: 8.5pt; font-weight: 500; margin-top: 2px; color: #1e293b;">
                                <t t-esc="doc.ref"/>
                            </div>
                        </td>
                        <td t-if="doc.invoice_origin" style="padding: 6px 10px; text-align: center; border-right: 1px solid #e2e8f0;">
                            <div style="font-size: 6.5pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b;">Source Document</div>
                            <div style="font-size: 8.5pt; font-weight: 500; margin-top: 2px; color: #1e293b;">
                                <t t-esc="doc.invoice_origin"/>
                            </div>
                        </td>
                        <td t-if="doc.invoice_payment_term_id" style="padding: 6px 10px; text-align: center;">
                            <div style="font-size: 6.5pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #64748b;">Payment Terms</div>
                            <div style="font-size: 8.5pt; font-weight: 500; margin-top: 2px; color: #1e293b;">
                                <t t-esc="doc.invoice_payment_term_id.name"/>
                            </div>
                        </td>
                    </tr>
                </table>

                <!-- ========== LINE ITEMS TABLE ========== -->
                <t t-set="inv_lines" t-value="doc.invoice_line_ids.sorted(key=lambda l: (l.sequence, l.id))"/>
                <t t-set="has_discount" t-value="any(l.discount for l in inv_lines if l.display_type not in ('line_section', 'line_note'))"/>
                <t t-set="has_tax" t-value="any(l.tax_ids for l in inv_lines if l.display_type not in ('line_section', 'line_note'))"/>
                <t t-set="col_count" t-value="6 + (1 if has_discount else 0) + (1 if has_tax else 0)"/>

                <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px;">
                    <thead>
                        <tr t-attf-style="background: #{title_bg}; color: #{ops_text_on_primary};">
                            <th style="padding: 6px 8px; text-align: left; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; width: 4%;">#</th>
                            <th style="padding: 6px 8px; text-align: left; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">Description</th>
                            <th style="padding: 6px 8px; text-align: center; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; width: 7%;">Account</th>
                            <th style="padding: 6px 8px; text-align: right; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; width: 8%;">Qty</th>
                            <th style="padding: 6px 8px; text-align: right; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; width: 12%;">Unit Price</th>
                            <th t-if="has_discount" style="padding: 6px 8px; text-align: right; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; width: 7%;">Disc.%</th>
                            <th t-if="has_tax" style="padding: 6px 8px; text-align: center; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; width: 10%;">Tax</th>
                            <th style="padding: 6px 8px; text-align: right; font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; width: 14%;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="line_num" t-value="0"/>
                        <t t-foreach="inv_lines" t-as="line">

                            <!-- Section header -->
                            <t t-if="line.display_type == 'line_section'">
                                <tr>
                                    <td t-att-colspan="col_count"
                                        t-attf-style="padding: 8px 8px 4px 8px; font-weight: 600; font-size: 9pt; border-bottom: 1px solid rgba(#{ops_rgb}, 0.25); color: #{ops_primary};">
                                        <t t-esc="line.name"/>
                                    </td>
                                </tr>
                            </t>

                            <!-- Note -->
                            <t t-if="line.display_type == 'line_note'">
                                <tr>
                                    <td t-att-colspan="col_count"
                                        style="padding: 2px 8px 2px 16px; font-style: italic; font-size: 8pt; color: #64748b;">
                                        <t t-esc="line.name"/>
                                    </td>
                                </tr>
                            </t>

                            <!-- Product / service line -->
                            <t t-if="not line.display_type">
                                <t t-set="line_num" t-value="line_num + 1"/>
                                <tr t-attf-style="border-bottom: 1px solid #f1f5f9; #{('background: #f8fafc;' if line_num % 2 == 0 else '')}">
                                    <td style="padding: 5px 8px; text-align: center; color: #94a3b8; font-size: 8pt;">
                                        <t t-esc="line_num"/>
                                    </td>
                                    <td style="padding: 5px 8px;">
                                        <t t-if="line.product_id and line.product_id.default_code">
                                            <span style="font-weight: 600; font-size: 7pt; color: #64748b;">[<t t-esc="line.product_id.default_code"/>]</span>
                                            <br/>
                                        </t>
                                        <span t-esc="line.name"/>
                                    </td>
                                    <td style="padding: 5px 8px; text-align: center; font-size: 7pt; color: #94a3b8;">
                                        <t t-if="line.account_id" t-esc="line.account_id.code"/>
                                    </td>
                                    <td style="padding: 5px 8px; text-align: right; font-variant-numeric: tabular-nums;">
                                        <t t-esc="line.quantity" t-options="{'widget': 'float', 'precision': 2}"/>
                                    </td>
                                    <td style="padding: 5px 8px; text-align: right; font-variant-numeric: tabular-nums;">
                                        <t t-esc="line.price_unit" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/>
                                    </td>
                                    <td t-if="has_discount" style="padding: 5px 8px; text-align: right; font-variant-numeric: tabular-nums;">
                                        <t t-if="line.discount">
                                            <t t-esc="line.discount" t-options="{'widget': 'float', 'precision': 1}"/>%
                                        </t>
                                    </td>
                                    <td t-if="has_tax" style="padding: 5px 8px; text-align: center; font-size: 7.5pt; color: #64748b;">
                                        <t t-esc="', '.join(line.tax_ids.mapped('name'))"/>
                                    </td>
                                    <td style="padding: 5px 8px; text-align: right; font-weight: 500; font-variant-numeric: tabular-nums;">
                                        <t t-esc="line.price_subtotal" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/>
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>

                <!-- ========== TOTALS ========== -->
                <table style="width: 40%; margin-left: auto; border-collapse: collapse; margin-top: 4px;">
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 5px 10px; font-size: 8pt; color: #64748b;">Untaxed Amount</td>
                        <td style="padding: 5px 10px; text-align: right; font-variant-numeric: tabular-nums; font-size: 9pt;">
                            <t t-esc="doc.amount_untaxed" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/>
                        </td>
                    </tr>
                    <t t-if="doc.amount_tax">
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 5px 10px; font-size: 8pt; color: #64748b;">Taxes</td>
                            <td style="padding: 5px 10px; text-align: right; font-variant-numeric: tabular-nums; font-size: 9pt;">
                                <t t-esc="doc.amount_tax" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/>
                            </td>
                        </tr>
                    </t>
                    <tr t-attf-style="background: #{title_bg}; color: #{ops_text_on_primary};">
                        <td style="padding: 8px 10px; font-size: 9pt; font-weight: 700;">
                            <t t-if="is_credit_note">Credit Total</t>
                            <t t-else="">Total Due</t>
                        </td>
                        <td style="padding: 8px 10px; text-align: right; font-size: 11pt; font-weight: 700; font-variant-numeric: tabular-nums;">
                            <t t-esc="doc.amount_total" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/>
                        </td>
                    </tr>
                </table>

                <!-- ========== AMOUNT PAID / BALANCE DUE ========== -->
                <t t-if="not is_credit_note and doc.payment_state == 'partial'">
                    <table style="width: 40%; margin-left: auto; border-collapse: collapse; margin-top: -1px;">
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 5px 10px; font-size: 8pt; color: #16a34a;">Amount Paid</td>
                            <td style="padding: 5px 10px; text-align: right; font-variant-numeric: tabular-nums; font-size: 9pt; color: #16a34a;">
                                <t t-esc="doc.amount_total - doc.amount_residual" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/>
                            </td>
                        </tr>
                        <tr style="background: #fef3c7;">
                            <td style="padding: 8px 10px; font-size: 9pt; font-weight: 700; color: #92400e;">Balance Due</td>
                            <td style="padding: 8px 10px; text-align: right; font-size: 11pt; font-weight: 700; font-variant-numeric: tabular-nums; color: #92400e;">
                                <t t-esc="doc.amount_residual" t-options="{'widget': 'monetary', 'display_currency': doc.currency_id}"/>
                            </td>
                        </tr>
                    </table>
                </t>

                <!-- ========== AMOUNT IN WORDS ========== -->
                <t t-if="company.ops_show_amount_words">
                    <t t-set="words_result" t-value="env['ops.report.helpers'].amount_to_words(doc.amount_total, doc.currency_id, company.ops_amount_words_lang or 'en')"/>
                    <t t-call="ops_theme.ops_amount_words_block">
                        <t t-set="amount_words_en" t-value="words_result.get('en', '') if words_result else ''"/>
                        <t t-set="amount_words_ar" t-value="words_result.get('ar', '') if words_result else ''"/>
                    </t>
                </t>

                <!-- ========== BANK DETAILS (for unpaid invoices) ========== -->
                <t t-if="not is_credit_note and doc.payment_state != 'paid' and company.ops_show_bank_details and company.bank_ids">
                    <t t-set="bank" t-value="company.bank_ids[0]"/>
                    <div style="margin-top: 14px; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 3px; font-size: 7.5pt; page-break-inside: avoid;">
                        <div t-attf-style="font-weight: 600; margin-bottom: 4px; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #{ops_primary};">Bank Details for Payment</div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <t t-if="bank.bank_id and bank.bank_id.name">
                                    <td style="padding: 2px 8px 2px 0;">
                                        <span style="font-weight: 600; color: #64748b;">Bank:</span>
                                        <t t-esc="bank.bank_id.name"/>
                                    </td>
                                </t>
                                <t t-if="bank.acc_number">
                                    <td style="padding: 2px 8px;">
                                        <span style="font-weight: 600; color: #64748b;">Account:</span>
                                        <t t-esc="bank.acc_number"/>
                                    </td>
                                </t>
                                <t t-if="bank.bank_id and bank.bank_id.bic">
                                    <td style="padding: 2px 8px;">
                                        <span style="font-weight: 600; color: #64748b;">SWIFT:</span>
                                        <t t-esc="bank.bank_id.bic"/>
                                    </td>
                                </t>
                                <t t-if="bank.acc_holder_name">
                                    <td style="padding: 2px 0 2px 8px;">
                                        <span style="font-weight: 600; color: #64748b;">Holder:</span>
                                        <t t-esc="bank.acc_holder_name"/>
                                    </td>
                                </t>
                            </tr>
                        </table>
                    </div>
                </t>

                <!-- ========== TERMS & CONDITIONS ========== -->
                <t t-call="ops_theme.ops_terms_block">
                    <t t-set="doc_note" t-value="doc.narration"/>
                </t>

                <!-- ========== SIGNATURES ========== -->
                <t t-call="ops_theme.ops_signature_block"/>

            </div>
        </t>
    </template>

</odoo>
