<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        ================================================================
        OPS CORPORATE GENERAL LEDGER REPORT — BS THEME
        ================================================================
        wkhtmltopdf-compatible: NO flexbox, NO font-variant-numeric,
        NO external CSS dependency for critical styles.
        All layouts use tables/inline-block for QtWebKit ~534.

        DESIGN: Balance Sheet corporate design system
        LAYOUT: Portrait A4, 8-column layout
        COLORS: Dynamic from company.ops_report_primary_color
    -->

    <!-- ================================================================
         GENERAL LEDGER REPORT TEMPLATE
         ================================================================ -->

    <template id="report_general_ledger_corporate">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-set="company" t-value="doc.company_id or env.company"/>

                <!-- Color variables from company settings (passed by Python parser) -->
                <t t-set="pc" t-value="primary_color"/>
                <t t-set="tc" t-value="text_on_primary"/>
                <t t-set="pl" t-value="primary_light"/>
                <t t-set="pd" t-value="primary_dark"/>

                <t t-call="ops_matrix_accounting.ops_corporate_pdf_layout">

                    <!-- Inline styles for wkhtmltopdf (QtWebKit ignores external CSS unreliably) -->
                    <style>
                        /* Badge colors — accounting convention (MUST be inline for wkhtmltopdf) */
                        .badge-asset { background: #dbeafe !important; color: #1e40af !important; }
                        .badge-liability { background: #fef3c7 !important; color: #92400e !important; }
                        .badge-income { background: #dcfce7 !important; color: #166534 !important; }
                        .badge-expense { background: #fee2e2 !important; color: #991b1b !important; }
                        .badge-equity { background: #f3e8ff !important; color: #6b21a8 !important; }

                        /* Print color-adjust for backgrounds */
                        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

                        /* Page setup — Portrait A4 */
                        @page { size: A4; margin: 15mm 12mm 25mm 12mm; }

                        /* Number cells — monospace for alignment */
                        .num { text-align: right; font-family: Consolas, Monaco, 'Courier New', monospace; }

                        /* Value colors — accounting convention */
                        .val-positive { color: #16a34a; }
                        .val-negative { color: #dc2626; }
                        .val-zero { color: #bbbbbb; }

                        /* Fixed footer — pinned to bottom of every page */
                        .page-footer-fixed {
                            position: fixed;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            padding: 6px 0 0 0;
                            border-top: 1px solid #e2e8f0;
                        }
                    </style>

                    <div class="page ops-report" t-attf-style="color: {{body_text_color}}; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, Helvetica, sans-serif; font-size: 8.5pt; line-height: 1.45;">

                        <!-- ================================================
                             HEADER
                             ================================================ -->
                        <table width="100%" style="border-collapse: collapse; margin-bottom: 15px;" t-attf-style="border-bottom: 2px solid {{pc}}; padding-bottom: 10px;">
                            <tr>
                                <td style="vertical-align: middle; width: 60%;">
                                    <table style="border-collapse: collapse;">
                                        <tr>
                                            <t t-if="company.logo">
                                                <td style="vertical-align: middle; padding-right: 12px;">
                                                    <img t-att-src="image_data_uri(company.logo)"
                                                         style="max-height: 45px; max-width: 100px; border-radius: 6px; object-fit: contain;"
                                                         alt="Company Logo"/>
                                                </td>
                                            </t>
                                            <t t-else="">
                                                <td style="vertical-align: middle; padding-right: 12px;">
                                                    <div t-attf-style="width: 45px; height: 45px; border-radius: 6px; background: {{pc}}; color: {{tc}}; font-weight: 700; font-size: 14pt; text-align: center; line-height: 45px;">
                                                        <t t-esc="(company.name or 'CO')[:2].upper()"/>
                                                    </div>
                                                </td>
                                            </t>
                                            <td style="vertical-align: middle;">
                                                <div style="font-size: 14pt; font-weight: 700; color: #1e293b; line-height: 1.2;">
                                                    <t t-esc="company.name"/>
                                                </div>
                                                <div style="font-size: 8.5pt; color: #666666; margin-top: 1px;">
                                                    <t t-if="company.city"><t t-esc="company.city"/></t>
                                                    <t t-if="company.city and company.country_id">, </t>
                                                    <t t-esc="company.country_id.name or ''"/>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="vertical-align: top; width: 40%; text-align: right;">
                                    <div style="font-size: 8pt; color: #666666; line-height: 1.6;">
                                        Printed: <t t-esc="context_timestamp(datetime.datetime.now()).strftime('%d %b %Y %H:%M')"/><br/>
                                        Generated by: <t t-esc="user.name"/>
                                    </div>
                                    <div style="font-family: 'Courier New', monospace; font-size: 7pt; color: #94a3b8; letter-spacing: 0.3px; margin-top: 2px;">
                                        Report ID: <t t-esc="report_run_id"/>
                                    </div>
                                </td>
                            </tr>
                        </table>

                        <!-- ================================================
                             TITLE BLOCK
                             ================================================ -->
                        <div style="margin: 20px 0 4px 0;">
                            <div style="font-size: 16pt; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
                                General Ledger
                            </div>
                            <div style="font-size: 8.5pt; color: #666666;">
                                <t t-esc="date_from"/> - <t t-esc="date_to"/>
                                <span style="color: #94a3b8;"> | </span>
                                <t t-esc="currency_name"/>
                                <span style="color: #94a3b8;"> | </span>
                                <t t-if="doc.target_move == 'posted'">Posted Entries</t>
                                <t t-else="">All Entries</t>
                                <t t-if="doc.branch_ids">
                                    <span style="color: #94a3b8;"> | </span>
                                    <t t-esc="', '.join(doc.branch_ids.mapped('name')[:3])"/>
                                    <t t-if="len(doc.branch_ids) &gt; 3"> (+<t t-esc="len(doc.branch_ids) - 3"/>)</t>
                                </t>
                            </div>
                        </div>

                        <!-- ================================================
                             SUMMARY ROW (table-based for wkhtmltopdf)
                             ================================================ -->
                        <table width="100%" style="border-collapse: collapse; margin: 12px 0 22px 0; border-radius: 4px;" t-attf-style="background: {{pl}};">
                            <tr>
                                <td style="padding: 12px 16px; vertical-align: top; width: 25%;">
                                    <div t-attf-style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; color: {{pd}}; margin-bottom: 2px;">Total Debit</div>
                                    <div style="font-size: 13pt; font-weight: 700; color: #1e293b; font-family: Consolas, Monaco, monospace;">
                                        <t t-esc="'{:,.2f}'.format(grand_total.get('debit', 0))"/>
                                    </div>
                                </td>
                                <td style="padding: 12px 16px; vertical-align: top; width: 25%;">
                                    <div t-attf-style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; color: {{pd}}; margin-bottom: 2px;">Total Credit</div>
                                    <div style="font-size: 13pt; font-weight: 700; color: #1e293b; font-family: Consolas, Monaco, monospace;">
                                        <t t-esc="'{:,.2f}'.format(grand_total.get('credit', 0))"/>
                                    </div>
                                </td>
                                <td style="padding: 12px 16px; vertical-align: top; width: 25%;">
                                    <div t-attf-style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; color: {{pd}}; margin-bottom: 2px;">Net Balance</div>
                                    <t t-set="net_bal" t-value="grand_total.get('balance', 0)"/>
                                    <t t-set="is_balanced" t-value="abs(grand_total.get('debit', 0) - grand_total.get('credit', 0)) &lt; 0.01"/>
                                    <div t-att-style="'font-size: 13pt; font-weight: 700; font-family: Consolas, Monaco, monospace;' + (' color: #16a34a;' if is_balanced else ' color: #1e293b;')">
                                        <t t-if="net_bal &lt; 0">(<t t-esc="'{:,.2f}'.format(abs(net_bal))"/>)</t>
                                        <t t-else=""><t t-esc="'{:,.2f}'.format(net_bal)"/></t>
                                    </div>
                                </td>
                                <td style="padding: 12px 16px; vertical-align: top; width: 25%;">
                                    <div t-attf-style="font-size: 8pt; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; color: {{pd}}; margin-bottom: 2px;">Accounts</div>
                                    <div style="font-size: 13pt; font-weight: 700; color: #1e293b;">
                                        <t t-esc="account_count"/>
                                    </div>
                                </td>
                            </tr>
                        </table>

                        <!-- ================================================
                             ACCOUNT SECTIONS
                             ================================================ -->
                        <t t-foreach="accounts" t-as="account">

                            <!-- Account Header (table-based for wkhtmltopdf) -->
                            <div style="page-break-after: avoid;">
                                <table width="100%" style="border-collapse: collapse;" t-attf-style="margin-top: 20px; margin-bottom: 0; background: {{pl}}; border-left: 3px solid {{pc}};">
                                    <tr>
                                        <td style="padding: 7px 12px; vertical-align: middle;">
                                            <span t-attf-style="font-weight: 600; font-size: 9pt; color: {{pd}};">
                                                <t t-esc="account.get('account_code', '')"/> - <t t-esc="account.get('account_name', '')"/>
                                            </span>
                                            <span t-att-class="'account-type-badge ' + account.get('type_badge_class', 'badge-asset')"
                                                  style="margin-left: 10px; display: inline-block; font-size: 6.5pt; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 6px; border-radius: 3px; font-weight: 600;">
                                                <t t-esc="account.get('type_label', 'Other')"/>
                                            </span>
                                        </td>
                                        <td style="padding: 7px 12px; text-align: right; vertical-align: middle; font-size: 7.5pt; color: #94a3b8;">
                                            <t t-esc="len(account.get('lines', []))"/> transactions
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Data Table -->
                            <table class="report-table" width="100%" style="border-collapse: collapse; font-size: 8pt; margin-bottom: 2px;">
                                <thead>
                                    <tr>
                                        <th style="width: 9%; padding: 7px 8px; text-align: left; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Date</th>
                                        <th style="width: 7%; padding: 7px 8px; text-align: left; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Journal</th>
                                        <th style="width: 13%; padding: 7px 8px; text-align: left; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Partner</th>
                                        <th style="width: 12%; padding: 7px 8px; text-align: left; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Reference</th>
                                        <th style="width: 24%; padding: 7px 8px; text-align: left; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Description</th>
                                        <th class="num" style="width: 12%; padding: 7px 8px; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Debit (<t t-esc="currency_name"/>)</th>
                                        <th class="num" style="width: 12%; padding: 7px 8px; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Credit (<t t-esc="currency_name"/>)</th>
                                        <th class="num" style="width: 11%; padding: 7px 8px; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #666666; border: none; border-bottom: 2px solid #1e293b; background: #f8fafc;">Balance (<t t-esc="currency_name"/>)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Opening Balance Row -->
                                    <t t-if="account.get('initial_balance', 0) != 0 or account.get('initial_debit', 0) != 0">
                                        <tr style="background: #fefce8 !important;">
                                            <td style="padding: 6px 8px; font-style: italic; color: #666666;"></td>
                                            <td style="padding: 6px 8px; font-style: italic; color: #666666;"></td>
                                            <td style="padding: 6px 8px; font-style: italic; color: #666666;"></td>
                                            <td style="padding: 6px 8px; font-style: italic; color: #666666;"></td>
                                            <td style="padding: 6px 8px; font-weight: 600; font-style: italic; color: #666666;">Opening Balance</td>
                                            <td class="num" style="padding: 6px 8px; font-style: italic;">
                                                <t t-if="account.get('initial_debit', 0) &gt; 0">
                                                    <t t-esc="'{:,.2f}'.format(account['initial_debit'])"/>
                                                </t>
                                                <t t-else="">
                                                    <span class="val-zero">-</span>
                                                </t>
                                            </td>
                                            <td class="num" style="padding: 6px 8px; font-style: italic;">
                                                <t t-if="account.get('initial_credit', 0) &gt; 0">
                                                    <t t-esc="'{:,.2f}'.format(account['initial_credit'])"/>
                                                </t>
                                                <t t-else="">
                                                    <span class="val-zero">-</span>
                                                </t>
                                            </td>
                                            <td class="num" style="padding: 6px 8px; font-weight: 600; font-style: italic;">
                                                <t t-if="account['initial_balance'] &lt; 0">
                                                    <span class="val-negative">(<t t-esc="'{:,.2f}'.format(abs(account['initial_balance']))"/>)</span>
                                                </t>
                                                <t t-elif="account['initial_balance'] == 0">
                                                    <span class="val-zero">0.00</span>
                                                </t>
                                                <t t-else="">
                                                    <t t-esc="'{:,.2f}'.format(account['initial_balance'])"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>

                                    <!-- Transaction Rows -->
                                    <t t-foreach="account.get('lines', [])" t-as="line">
                                        <tr t-att-style="'border-bottom: 1px solid #f1f5f9;' + (' background: #f8fafc;' if line_even else '')">
                                            <td style="padding: 5px 8px; white-space: nowrap;">
                                                <t t-esc="line.get('move_date', '')"/>
                                            </td>
                                            <td style="padding: 5px 8px;">
                                                <t t-esc="line.get('journal', '')"/>
                                            </td>
                                            <td style="padding: 5px 8px;">
                                                <t t-esc="line.get('partner', '') or ''"/>
                                            </td>
                                            <td style="padding: 5px 8px; font-size: 7.5pt; color: #64748b;">
                                                <t t-esc="line.get('reference', '') or ''"/>
                                            </td>
                                            <td style="padding: 5px 8px;">
                                                <t t-esc="line.get('label', '')"/>
                                            </td>
                                            <!-- Debit -->
                                            <td class="num" style="padding: 5px 8px;">
                                                <t t-if="line.get('debit', 0) &gt; 0">
                                                    <t t-esc="'{:,.2f}'.format(line['debit'])"/>
                                                </t>
                                                <t t-else="">
                                                    <span class="val-zero">-</span>
                                                </t>
                                            </td>
                                            <!-- Credit -->
                                            <td class="num" style="padding: 5px 8px;">
                                                <t t-if="line.get('credit', 0) &gt; 0">
                                                    <t t-esc="'{:,.2f}'.format(line['credit'])"/>
                                                </t>
                                                <t t-else="">
                                                    <span class="val-zero">-</span>
                                                </t>
                                            </td>
                                            <!-- Running Balance -->
                                            <td class="num" style="padding: 5px 8px; font-weight: 500;">
                                                <t t-if="line.get('balance', 0) &lt; 0">
                                                    <span class="val-negative">(<t t-esc="'{:,.2f}'.format(abs(line['balance']))"/>)</span>
                                                </t>
                                                <t t-elif="line.get('balance', 0) == 0">
                                                    <span class="val-zero">-</span>
                                                </t>
                                                <t t-else="">
                                                    <span class="val-positive"><t t-esc="'{:,.2f}'.format(line['balance'])"/></span>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>

                                    <!-- Empty State -->
                                    <t t-if="not account.get('lines')">
                                        <tr>
                                            <td colspan="8" style="text-align: center; padding: 15px; color: #94a3b8; font-style: italic;">
                                                No transactions in this period
                                            </td>
                                        </tr>
                                    </t>

                                    <!-- Account Total Row -->
                                    <tr t-attf-style="font-weight: 600; background: {{pl}}; page-break-before: avoid;">
                                        <td colspan="5" t-attf-style="padding: 7px 8px; font-size: 8pt; color: {{pd}};">
                                            Total <t t-esc="account.get('account_code', '')"/>
                                            <span style="font-size: 7pt; color: #94a3b8; font-weight: 400; margin-left: 8px;">
                                                <t t-esc="len(account.get('lines', []))"/> txn
                                            </span>
                                        </td>
                                        <td class="num" t-attf-style="padding: 7px 8px; font-size: 8pt; color: {{pd}};">
                                            <t t-esc="'{:,.2f}'.format(account.get('total_debit', 0))"/>
                                        </td>
                                        <td class="num" t-attf-style="padding: 7px 8px; font-size: 8pt; color: {{pd}};">
                                            <t t-esc="'{:,.2f}'.format(account.get('total_credit', 0))"/>
                                        </td>
                                        <td class="num" t-attf-style="padding: 7px 8px; font-size: 8pt; color: {{pd}};">
                                            <t t-set="tb" t-value="account.get('total_balance', 0)"/>
                                            <t t-if="tb &lt; 0">(<t t-esc="'{:,.2f}'.format(abs(tb))"/>)</t>
                                            <t t-else=""><t t-esc="'{:,.2f}'.format(tb)"/></t>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </t>

                        <!-- ================================================
                             GRAND TOTAL
                             ================================================ -->
                        <div t-attf-style="margin-top: 24px; border-radius: 4px; overflow: hidden; background: {{pc}}; color: {{tc}}; page-break-inside: avoid;">
                            <table width="100%" style="border-collapse: collapse;">
                                <tr>
                                    <td style="width: 56%; padding: 13px 8px 13px 14px; font-weight: 600; font-size: 9pt; text-transform: uppercase; letter-spacing: 0.3px; border: none;">
                                        GRAND TOTAL
                                    </td>
                                    <td class="num" style="width: 15%; padding: 13px 8px; font-weight: 700; font-size: 10pt; border: none;">
                                        <t t-esc="'{:,.2f}'.format(grand_total.get('debit', 0))"/>
                                    </td>
                                    <td class="num" style="width: 15%; padding: 13px 8px; font-weight: 700; font-size: 10pt; border: none;">
                                        <t t-esc="'{:,.2f}'.format(grand_total.get('credit', 0))"/>
                                    </td>
                                    <td class="num" style="width: 14%; padding: 13px 8px; font-weight: 700; font-size: 10pt; border: none;">
                                        <t t-set="gb" t-value="grand_total.get('balance', 0)"/>
                                        <t t-if="gb &lt; 0">(<t t-esc="'{:,.2f}'.format(abs(gb))"/>)</t>
                                        <t t-else=""><t t-esc="'{:,.2f}'.format(gb)"/></t>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- ================================================
                             SIGNATURE BLOCK
                             ================================================ -->
                        <div style="margin-top: 28px; page-break-inside: avoid;">
                            <table width="100%" style="border-collapse: collapse; border: none;">
                                <tr style="border: none;">
                                    <td style="border: none; width: 33%; padding: 0 16px 0 0;">
                                        <div style="font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #94a3b8; font-weight: 600; margin-bottom: 24px;">
                                            Prepared by
                                        </div>
                                        <div style="border-top: 1px solid #cbd5e1; padding-top: 4px; font-size: 7.5pt; color: #666666;">
                                            Name / Date
                                        </div>
                                    </td>
                                    <td style="border: none; width: 33%; padding: 0 16px; border-left: 1px solid #e2e8f0;">
                                        <div style="font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #94a3b8; font-weight: 600; margin-bottom: 24px;">
                                            Reviewed by
                                        </div>
                                        <div style="border-top: 1px solid #cbd5e1; padding-top: 4px; font-size: 7.5pt; color: #666666;">
                                            Name / Date
                                        </div>
                                    </td>
                                    <td style="border: none; width: 33%; padding: 0 0 0 16px; border-left: 1px solid #e2e8f0;">
                                        <div style="font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.3px; color: #94a3b8; font-weight: 600; margin-bottom: 24px;">
                                            Approved by
                                        </div>
                                        <div style="border-top: 1px solid #cbd5e1; padding-top: 4px; font-size: 7.5pt; color: #666666;">
                                            Name / Date
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- ================================================
                             FIXED FOOTER — renders at bottom of every page
                             Confidentiality + OPS badge pinned via position:fixed
                             ================================================ -->
                        <div class="page-footer-fixed" style="position: fixed; bottom: 0; left: 0; right: 0; padding: 6px 0 0 0; border-top: 1px solid #e2e8f0;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="width: 50%; text-align: left; vertical-align: middle; padding: 4px 0;">
                                        <span style="font-size: 8pt; color: #666666;">Powered by</span>
                                        <img src="/ops_matrix_accounting/static/src/img/ops_badge_footer.png"
                                             style="height: 16px; vertical-align: middle; margin-left: 4px;"
                                             alt="OPS Framework"/>
                                    </td>
                                    <td style="width: 50%; text-align: right; vertical-align: middle; padding: 4px 0;">
                                        <span style="font-size: 7pt; color: #94a3b8;">
                                            Page <span class="page"/> of <span class="topage"/>
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>

                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- ================================================================
         REPORT ACTIONS
         ================================================================ -->

    <record id="action_report_general_ledger_corporate" model="ir.actions.report">
        <field name="name">General Ledger (Corporate)</field>
        <field name="model">ops.general.ledger.wizard.enhanced</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_general_ledger_corporate</field>
        <field name="report_file">ops_matrix_accounting.report_general_ledger_corporate</field>
        <field name="binding_model_id" ref="model_ops_general_ledger_wizard_enhanced"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="paperformat_ops_corporate_a4"/>
    </record>

    <!-- Legacy report action for backward compatibility -->
    <record id="action_report_general_ledger" model="ir.actions.report">
        <field name="name">General Ledger</field>
        <field name="model">ops.general.ledger.wizard.enhanced</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_accounting.report_general_ledger_corporate</field>
        <field name="report_file">ops_matrix_accounting.report_general_ledger_corporate</field>
        <field name="binding_model_id" eval="False"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="paperformat_ops_corporate_a4"/>
    </record>

</odoo>
