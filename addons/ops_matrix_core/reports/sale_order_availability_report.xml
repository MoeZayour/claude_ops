<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Stock Availability Report - External Customer Document -->
    <record id="action_report_sale_order_availability" model="ir.actions.report">
        <field name="name">Stock Availability Report</field>
        <field name="model">sale.order</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ops_matrix_core.report_sale_order_availability</field>
        <field name="report_file">ops_matrix_core.report_sale_order_availability</field>
        <field name="binding_model_id" ref="sale.model_sale_order"/>
        <field name="binding_type">report</field>
    </record>

    <!-- Report Template -->
    <template id="report_sale_order_availability">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-set="company" t-value="doc.company_id or env.company"/>
                <t t-set="primary_color" t-value="company.ops_primary_color or '#1e293b'"/>
                <t t-set="show_badge" t-value="company.ops_show_external_badge"/>

                <div class="article ops-external-doc"
                     t-attf-style="--ops-primary: #{primary_color}; font-family: 'Inter', -apple-system, sans-serif;">

                    <!-- Inline styles for PDF rendering -->
                    <style>
                        .ops-letterhead { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 12px; border-bottom: 2.5px solid <t t-esc="primary_color"/>; margin-bottom: 20px; }
                        .ops-company-block { display: flex; align-items: flex-start; gap: 12px; }
                        .ops-company-logo { width: 60px; height: 60px; border-radius: 6px; object-fit: contain; }
                        .ops-company-logo-placeholder { width: 60px; height: 60px; background: <t t-esc="primary_color"/>; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; }
                        .ops-company-name { font-size: 16px; font-weight: 700; color: <t t-esc="primary_color"/>; margin-bottom: 2px; }
                        .ops-company-details { font-size: 8pt; color: #64748b; line-height: 1.6; }
                        .ops-doc-meta { text-align: right; font-size: 8pt; color: #64748b; }
                        .ops-doc-ref { font-size: 11pt; font-weight: 700; color: <t t-esc="primary_color"/>; margin-bottom: 4px; }
                        .ops-title-bar { background: <t t-esc="primary_color"/>; color: white; padding: 8px 16px; border-radius: 4px; margin-bottom: 16px; }
                        .ops-title-bar h2 { font-size: 12pt; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
                        .ops-info-row { display: flex; gap: 24px; margin-bottom: 16px; }
                        .ops-info-block { flex: 1; }
                        .ops-info-block strong { color: <t t-esc="primary_color"/>; font-size: 9pt; }
                        .ops-info-block span { font-size: 9pt; color: #1e293b; }
                        .ops-items-table { width: 100%; border-collapse: collapse; font-size: 8pt; }
                        .ops-items-table thead th { padding: 8px 10px; text-align: left; font-weight: 600; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: white; background: <t t-esc="primary_color"/>; }
                        .ops-items-table thead th:first-child { border-radius: 4px 0 0 0; }
                        .ops-items-table thead th:last-child { border-radius: 0 4px 0 0; }
                        .ops-items-table thead th.num { text-align: right; }
                        .ops-items-table tbody td { padding: 6px 10px; vertical-align: top; border-bottom: 1px solid #f1f5f9; }
                        .ops-items-table tbody tr:nth-child(even) { background: #f8fafc; }
                        .ops-items-table .num { text-align: right; font-variant-numeric: tabular-nums; }
                        .badge-success { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 3px; font-size: 7pt; font-weight: 600; }
                        .badge-warning { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 3px; font-size: 7pt; font-weight: 600; }
                        .badge-danger { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 3px; font-size: 7pt; font-weight: 600; }
                        .ops-summary { margin-top: 20px; padding: 10px 12px; background: #f8fafc; border-radius: 4px; border-left: 3px solid <t t-esc="primary_color"/>; }
                        .ops-footer { border-top: 1px solid #e2e8f0; padding-top: 8px; display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
                        .ops-footer-company { font-size: 7pt; color: #94a3b8; }
                        .ops-footer-company strong { color: #64748b; }
                        .ops-external-badge { display: flex; align-items: center; gap: 4px; }
                        .ops-external-badge .powered-by { font-size: 6.5pt; color: #94a3b8; }
                        .ops-external-badge .badge { background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 2px 6px; border-radius: 3px; font-weight: 600; font-size: 6pt; text-transform: uppercase; letter-spacing: 0.4px; }
                        .ops-page-number { font-size: 7pt; color: #94a3b8; margin-left: 10px; }
                    </style>

                    <!-- Letterhead -->
                    <div class="ops-letterhead">
                        <div class="ops-company-block">
                            <img t-if="company.logo" class="ops-company-logo"
                                 t-att-src="image_data_uri(company.logo)"/>
                            <div t-else="" class="ops-company-logo-placeholder">
                                <t t-esc="(company.name or 'CO')[:2].upper()"/>
                            </div>
                            <div>
                                <div class="ops-company-name"><t t-esc="company.name"/></div>
                                <div class="ops-company-details">
                                    <t t-if="company.street"><t t-esc="company.street"/><br/></t>
                                    <t t-if="company.city"><t t-esc="company.city"/></t>
                                    <t t-if="company.country_id">, <t t-esc="company.country_id.name"/></t>
                                    <br/>
                                    <t t-if="company.phone">Tel: <t t-esc="company.phone"/></t>
                                    <t t-if="company.email"> | <t t-esc="company.email"/></t>
                                    <br/>
                                    <t t-if="company.company_registry">CR: <t t-esc="company.company_registry"/></t>
                                    <t t-if="company.vat"> | VAT: <t t-esc="company.vat"/></t>
                                </div>
                            </div>
                        </div>
                        <div class="ops-doc-meta">
                            <div class="ops-doc-ref"><t t-esc="doc.name"/></div>
                            Date: <t t-esc="doc.date_order" t-options='{"widget": "date"}'/><br/>
                            Printed: <t t-esc="context_timestamp(datetime.datetime.now()).strftime('%b %d, %Y')"/>
                        </div>
                    </div>

                    <!-- Title Bar -->
                    <div class="ops-title-bar">
                        <h2>Stock Availability Report</h2>
                    </div>

                    <!-- Order Info -->
                    <div class="ops-info-row">
                        <div class="ops-info-block">
                            <strong>Customer:</strong><br/>
                            <span><t t-esc="doc.partner_id.name"/></span>
                        </div>
                        <div class="ops-info-block">
                            <strong>Warehouse:</strong><br/>
                            <span><t t-esc="doc.warehouse_id.name if doc.warehouse_id else 'Default'"/></span>
                        </div>
                        <div class="ops-info-block" t-if="doc.ops_branch_id">
                            <strong>Branch:</strong><br/>
                            <span><t t-esc="doc.ops_branch_id.name"/></span>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <table class="ops-items-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;">#</th>
                                <th>Product</th>
                                <th style="width: 100px;">Internal Ref</th>
                                <th class="num" style="width: 80px;">Ordered</th>
                                <th class="num" style="width: 80px;">Available</th>
                                <th class="num" style="width: 80px;">Shortfall</th>
                                <th style="width: 80px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="line_num" t-value="0"/>
                            <t t-set="total_in_stock" t-value="0"/>
                            <t t-set="total_partial" t-value="0"/>
                            <t t-set="total_out_of_stock" t-value="0"/>
                            <t t-foreach="doc.order_line.filtered(lambda l: l.product_id.type == 'product')" t-as="line">
                                <t t-set="line_num" t-value="line_num + 1"/>
                                <t t-set="available" t-value="line.product_id.qty_available"/>
                                <t t-set="ordered" t-value="line.product_uom_qty"/>
                                <t t-set="shortfall" t-value="max(0, ordered - available)"/>
                                <t t-if="available >= ordered">
                                    <t t-set="total_in_stock" t-value="total_in_stock + 1"/>
                                </t>
                                <t t-elif="available > 0">
                                    <t t-set="total_partial" t-value="total_partial + 1"/>
                                </t>
                                <t t-else="">
                                    <t t-set="total_out_of_stock" t-value="total_out_of_stock + 1"/>
                                </t>
                                <tr>
                                    <td><t t-esc="line_num"/></td>
                                    <td>
                                        <strong><t t-esc="line.product_id.name"/></strong>
                                    </td>
                                    <td><t t-esc="line.product_id.default_code or '-'"/></td>
                                    <td class="num">
                                        <t t-esc="'{:,.2f}'.format(ordered)"/>
                                        <t t-esc="line.product_uom_id.name"/>
                                    </td>
                                    <td class="num">
                                        <t t-esc="'{:,.2f}'.format(available)"/>
                                    </td>
                                    <td class="num" t-attf-style="color: #{shortfall > 0 and '#dc2626' or '#16a34a'};">
                                        <t t-if="shortfall > 0">
                                            (<t t-esc="'{:,.2f}'.format(shortfall)"/>)
                                        </t>
                                        <t t-else="">â€”</t>
                                    </td>
                                    <td>
                                        <t t-if="available >= ordered">
                                            <span class="badge-success">In Stock</span>
                                        </t>
                                        <t t-elif="available > 0">
                                            <span class="badge-warning">Partial</span>
                                        </t>
                                        <t t-else="">
                                            <span class="badge-danger">Out of Stock</span>
                                        </t>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <!-- Summary -->
                    <div class="ops-summary">
                        <div style="font-size: 8pt; color: #64748b;">
                            <strong style="color: #1e293b;">Summary:</strong>
                            <span style="margin-left: 16px;"><span class="badge-success">In Stock</span> <t t-esc="total_in_stock"/> items</span>
                            <span style="margin-left: 16px;"><span class="badge-warning">Partial</span> <t t-esc="total_partial"/> items</span>
                            <span style="margin-left: 16px;"><span class="badge-danger">Out of Stock</span> <t t-esc="total_out_of_stock"/> items</span>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="ops-footer">
                        <div class="ops-footer-company">
                            <strong><t t-esc="company.name"/></strong>
                            <t t-if="company.company_registry"> | CR: <t t-esc="company.company_registry"/></t>
                            <t t-if="company.vat"> | VAT: <t t-esc="company.vat"/></t>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div t-if="show_badge" class="ops-external-badge">
                                <span class="powered-by">Powered by</span>
                                <span class="badge">OPS Framework</span>
                            </div>
                            <span class="ops-page-number">Page <span class="page"/> of <span class="topage"/></span>
                        </div>
                    </div>

                </div>
            </t>
        </t>
    </template>

</odoo>
