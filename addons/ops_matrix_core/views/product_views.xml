<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_product_template_form_inherit" model="ir.ui.view">
        <field name="name">product.template.form.inherit.ops</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            <!-- The Cost Shield: Add computed fields for cost access control (invisible) -->
            <xpath expr="//field[@name='name']" position="before">
                <field name="can_user_access_cost_prices" invisible="1"/>
                <field name="can_user_modify_product_master" invisible="1"/>
            </xpath>

            <!-- OPS MATRIX HEADER: Business Unit + Branch at the VERY TOP of form -->
            <xpath expr="//div[@class='oe_title']" position="before">
                <div class="alert alert-primary mb-3" role="status">
                    <div class="row">
                        <div class="col-6">
                            <label for="business_unit_id" class="fw-bold"/>
                            <field name="business_unit_id"
                                   required="1"
                                   readonly="0"
                                   options="{'no_create': True, 'no_open': True}"
                                   placeholder="Select Business Unit (Required)"
                                   class="oe_inline"/>
                        </div>
                        <div class="col-6">
                            <label for="ops_branch_activation_ids" class="fw-bold"/>
                            <field name="ops_branch_activation_ids"
                                   widget="many2many_tags"
                                   required="1"
                                   readonly="0"
                                   options="{'no_create': True, 'color_field': 'color'}"
                                   placeholder="Select Branch(es) (Required)"
                                   class="oe_inline"/>
                        </div>
                    </div>
                </div>
            </xpath>

            <!-- OPS MATRIX: Additional controls in General Info tab -->
            <xpath expr="//page[@name='general_information']" position="inside">
                <group string="OPS Matrix - Product Governance" name="ops_product_governance">
                    <group>
                        <field name="ops_is_global_master"
                               help="Mark as Global Master to enforce branch activation workflow"/>
                    </group>
                    <group>
                        <field name="ops_business_unit_id" invisible="1"/>
                    </group>
                </group>
            </xpath>

            <!-- The Cost Shield: Hide cost price from unauthorized users -->
            <xpath expr="//field[@name='standard_price']" position="attributes">
                <attribute name="invisible">not can_user_access_cost_prices</attribute>
                <attribute name="readonly">not can_user_modify_product_master</attribute>
            </xpath>
        </field>
    </record>

    <!-- Tree View: Add Business Unit column -->
    <record id="view_product_template_tree_inherit" model="ir.ui.view">
        <field name="name">product.template.tree.inherit.ops</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_tree_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='categ_id']" position="after">
                <field name="business_unit_id" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- Search View: Add Business Unit and Global Master filters -->
    <record id="view_product_template_search_inherit" model="ir.ui.view">
        <field name="name">product.template.search.inherit.ops</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='filter_to_purchase']" position="after">
                <separator/>
                <filter string="Global Master Products" name="filter_global_master"
                        domain="[('ops_is_global_master', '=', True)]"/>
            </xpath>
            <xpath expr="//field[@name='categ_id']" position="after">
                <field name="business_unit_id"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="Business Unit" name="group_business_unit"
                        context="{'group_by': 'business_unit_id'}"/>
            </xpath>
        </field>
    </record>

    <!-- The Cost Shield: Apply same security to Purchase views (if module is installed) -->
    <record id="view_product_template_purchase_form_inherit" model="ir.ui.view">
        <field name="name">product.template.purchase.form.inherit.cost.shield</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="purchase.view_product_supplier_inherit"/>
        <field name="arch" type="xml">
            <!-- Hide supplier information from unauthorized users -->
            <xpath expr="//page[@name='purchase']" position="attributes">
                <attribute name="invisible">not can_user_modify_product_master</attribute>
            </xpath>
        </field>
    </record>
</odoo>
