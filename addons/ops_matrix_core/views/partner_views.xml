<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Add CR Number and Master Verified to main partner form (top area) -->
    <record id="view_res_partner_form_ops_master_data" model="ir.ui.view">
        <field name="name">res.partner.form.ops.master.data</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <!-- Add Master Data fields after VAT field (or after name) -->
            <xpath expr="//field[@name='vat']" position="after">
                <field name="ops_cr_number" placeholder="e.g., CR-123456"/>
            </xpath>

            <!-- Add Master Verified badge in header area -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <field name="ops_master_verified" widget="boolean_toggle"
                       class="oe_stat_button"
                       icon="fa-certificate"
                       groups="ops_matrix_core.group_ops_manager,base.group_system"/>
            </xpath>
        </field>
    </record>

    <!-- Inherit Partner Form View to Add Stewardship Tab -->
    <record id="view_res_partner_form_ops_stewardship" model="ir.ui.view">
        <field name="name">res.partner.form.ops.stewardship</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <!-- Add OPS Stewardship Tab -->
            <xpath expr="//notebook" position="inside">
                <page string="OPS Governance" name="ops_stewardship">
                    <!-- Master Data Verification Section -->
                    <group name="master_data_verification" string="Master Data Verification">
                        <group name="outer_group_2">
                            <field name="ops_cr_number" readonly="1"/>
                            <field name="ops_master_verified" widget="boolean_toggle"
                                   groups="ops_matrix_core.group_ops_manager,base.group_system"/>
                        </group>
                        <group name="outer_group_3">
                            <field name="ops_verification_date" readonly="1" />
                            <field name="ops_verified_by_id" readonly="1" />
                        </group>
                    </group>

                    <!-- Master Verification Actions -->
                    <div class="alert alert-info" role="alert"
                         invisible="ops_master_verified">
                        <strong><i class="fa fa-exclamation-triangle"/> Not Master Verified</strong><br/>
                        Credit transactions (orders with payment terms) will be BLOCKED until this customer is verified.
                        Cash/Immediate transactions are allowed.
                    </div>
                    <div class="alert alert-success" role="alert"
                         invisible="not ops_master_verified">
                        <strong><i class="fa fa-check-circle"/> Master Verified</strong><br/>
                        All transaction types (Cash and Credit) are allowed for this customer.
                    </div>

                    <div class="oe_button_box mb-3">
                        <button name="action_verify_master" type="object"
                                string="Verify Customer"
                                class="btn-success"
                                invisible="ops_master_verified"
                                groups="ops_matrix_core.group_ops_manager,base.group_system"/>
                        <button name="action_unverify_master" type="object"
                                string="âœ— Revoke Verification"
                                class="btn-warning"
                                invisible="not ops_master_verified"
                                groups="ops_matrix_core.group_ops_manager,base.group_system"/>
                    </div>

                    <separator string="Stewardship State"/>
                    <group name="outer_group_4">
                        <group name="outer_group_5">
                            <field name="ops_state" widget="radio" />
                            <field name="active" />
                        </group>
                    </group>

                    <separator string="Credit Management"/>
                    <group name="outer_group_6">
                        <group name="outer_group_7">
                            <field name="ops_credit_limit" />
                            <field name="ops_total_outstanding" readonly="1" />
                            <field name="company_currency_id" readonly="1" invisible="1"/>
                        </group>
                    </group>

                    <group name="outer_group_8" invisible="not ops_confirmation_restrictions">
                        <field name="ops_confirmation_restrictions" readonly="1" nolabel="1"
                               widget="text" class="text-danger"/>
                    </group>

                    <separator string="Approval Notes"/>
                    <group name="outer_group_9">
                        <field name="ops_approval_notes" nolabel="1" placeholder="Add notes about partner approval..." />
                    </group>

                    <div class="oe_button_box">
                        <button name="action_approve" type="object" string="Approve"
                                class="btn-primary"
                                invisible="ops_state == 'approved'"
                                groups="ops_matrix_core.group_ops_manager,base.group_system"/>
                        <button name="action_block" type="object" string="Block"
                                class="btn-danger"
                                invisible="ops_state == 'blocked'"
                                groups="ops_matrix_core.group_ops_manager,base.group_system"/>
                        <button name="action_unblock" type="object" string="Unblock"
                                invisible="ops_state != 'blocked'"
                                groups="ops_matrix_core.group_ops_manager,base.group_system"/>
                        <button name="action_reset_to_draft" type="object" string="Reset to Draft"
                                invisible="ops_state == 'draft'"
                                groups="ops_matrix_core.group_ops_manager,base.group_system"/>
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Partner List View - Add Stewardship State Column -->
    <record id="view_res_partner_tree_ops_stewardship" model="ir.ui.view">
        <field name="name">res.partner.tree.ops.stewardship</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list" position="inside">
                <field name="ops_cr_number" string="CR Number" optional="show" />
                <field name="ops_master_verified" string="Verified" widget="boolean"
                       decoration-success="ops_master_verified"
                       decoration-danger="not ops_master_verified"
                       optional="show" />
                <field name="ops_state" string="Stewardship" optional="show" />
                <field name="ops_total_outstanding" string="Outstanding" optional="hide" />
            </xpath>
        </field>
    </record>

    <!-- Partner Kanban View with Stewardship Status -->
    <record id="view_res_partner_kanban_ops_stewardship" model="ir.ui.view">
        <field name="name">res.partner.kanban.ops.stewardship</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.res_partner_kanban_view"/>
        <field name="arch" type="xml">
            <xpath expr="//kanban" position="inside">
                <field name="ops_state" />
                <field name="ops_total_outstanding" />
                <field name="ops_credit_limit" />
            </xpath>
            
            <xpath expr="//templates" position="inside">
                <t t-name="card">
                    <div class="oe_kanban_card">
                        <div class="oe_kanban_content">
                            <div class="oe_partner_heading">
                                <h4 class="oe_partner_name"><t t-esc="record.name.value"/></h4>
                                <span class="badge badge-secondary"><t t-esc="record.ops_state.value"/></span>
                            </div>
                            
                            <div t-if="record.ops_state.raw_value == 'draft'" class="alert alert-info">
                                <i class="fa fa-warning"/> Partner not yet approved
                            </div>
                            <div t-elif="record.ops_state.raw_value == 'blocked'" class="alert alert-danger">
                                <i class="fa fa-ban"/> Partner blocked
                            </div>
                            <div t-elif="record.ops_state.raw_value == 'approved'" class="alert alert-success">
                                <i class="fa fa-check"/> Partner approved
                            </div>
                            
                            <div t-if="record.ops_credit_limit.raw_value > 0" class="oe_partner_credit">
                                <small>Outstanding: <t t-esc="record.ops_total_outstanding.value"/> / <t t-esc="record.ops_credit_limit.value"/></small>
                            </div>
                        </div>
                    </div>
                </t>
            </xpath>
        </field>
    </record>

    <!-- Partner Search View with Stewardship Filters -->
    <record id="view_res_partner_search_ops_stewardship" model="ir.ui.view">
        <field name="name">res.partner.search.ops.stewardship</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <filter name="type_company" position="after">
                <separator />
                <filter name="master_verified" string="Master Verified"
                        domain="[('ops_master_verified', '=', True)]" />
                <filter name="not_master_verified" string="NOT Verified (Credit Blocked)"
                        domain="[('ops_master_verified', '=', False)]" />
                <separator />
                <filter name="has_cr_number" string="Has CR Number"
                        domain="[('ops_cr_number', '!=', False)]" />
                <filter name="no_cr_number" string="No CR Number (Leads)"
                        domain="[('ops_cr_number', '=', False)]" />
                <separator />
                <filter name="stewardship_draft" string="Draft (Not Approved)" domain="[('ops_state', '=', 'draft')]" />
                <filter name="stewardship_approved" string="Approved" domain="[('ops_state', '=', 'approved')]" />
                <filter name="stewardship_blocked" string="Blocked" domain="[('ops_state', '=', 'blocked')]" />
                <filter name="stewardship_archived" string="Archived" domain="[('ops_state', '=', 'archived')]" />
                <separator />
                <filter name="group_by_verified" string="Master Verified" context="{'group_by': 'ops_master_verified'}" />
                <filter name="group_by_state" string="Stewardship State" context="{'group_by': 'ops_state'}" />
            </filter>
            <!-- Add search field for CR Number -->
            <field name="name" position="after">
                <field name="ops_cr_number" string="CR Number" filter_domain="[('ops_cr_number', 'ilike', self)]"/>
            </field>
        </field>
    </record>
</odoo>
