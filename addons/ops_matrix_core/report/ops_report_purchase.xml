<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS REQUEST FOR QUOTATION / PURCHASE ORDER
         Inherits BOTH native purchase document templates via XPath.
         Uses shared sub-template to avoid content duplication.
         ================================================================ -->

    <!-- Re-enable and style native purchase report actions -->
    <record id="purchase.action_report_purchase_order" model="ir.actions.report">
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
        <field name="binding_model_id" ref="purchase.model_purchase_order"/>
        <field name="binding_type">report</field>
    </record>
    <record id="purchase.report_purchase_quotation" model="ir.actions.report">
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
        <field name="binding_model_id" ref="purchase.model_purchase_order"/>
        <field name="binding_type">report</field>
    </record>

    <!-- ==================== SHARED INNER CONTENT ==================== -->
    <template id="ops_purchase_page_content" name="OPS Purchase Page Content">
        <t t-set="company" t-value="doc.company_id"/>
        <t t-set="_ops" t-value="company.get_ops_report_settings()"/>
        <t t-set="is_rfq" t-value="doc.state in ('draft', 'sent')"/>

        <!-- CSS -->
        <t t-call="ops_theme.ops_report_css"/>

        <!-- Title Bar -->
        <t t-set="doc_title" t-value="'Request for Quotation' if is_rfq else 'Purchase Order'"/>
        <t t-set="doc_ref" t-value="doc.name"/>
        <t t-call="ops_theme.ops_title_bar"/>

        <!-- Addresses -->
        <table style="width:100%; border-collapse:collapse; margin-bottom:14px;">
            <tr>
                <td style="width:50%; vertical-align:top; padding-right:10px;">
                    <t t-call="ops_theme.ops_address_block">
                        <t t-set="partner" t-value="doc.partner_id"/>
                        <t t-set="addr_label" t-value="'Vendor'"/>
                    </t>
                </td>
                <td style="width:50%; vertical-align:top; padding-left:10px;">
                    <t t-call="ops_theme.ops_address_block">
                        <t t-set="partner" t-value="company.partner_id"/>
                        <t t-set="addr_label" t-value="'Ship To'"/>
                    </t>
                </td>
            </tr>
        </table>

        <!-- Info Bar -->
        <table class="ops-info-bar" t-attf-style="width:100%; border-collapse:collapse; margin-bottom:14px;">
            <tr t-attf-style="background:rgba(#{_ops['rgb']},0.04);">
                <td t-if="doc.date_order" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                    <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Order Date</div>
                    <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;">
                        <t t-esc="doc.date_order" t-options="{'widget': 'date'}"/>
                    </div>
                </td>
                <td t-if="doc.date_planned" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                    <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Required Date</div>
                    <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;">
                        <t t-esc="doc.date_planned" t-options="{'widget': 'date'}"/>
                    </div>
                </td>
                <td t-if="doc.partner_ref" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                    <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Vendor Ref</div>
                    <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.partner_ref"/></div>
                </td>
                <td t-if="doc.payment_term_id" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                    <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Payment Terms</div>
                    <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.payment_term_id.name"/></div>
                </td>
                <td t-if="doc.user_id" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                    <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Buyer</div>
                    <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.user_id.name"/></div>
                </td>
            </tr>
        </table>

        <!-- Line Items -->
        <t t-set="lines" t-value="doc.order_line"/>
        <t t-set="has_discount" t-value="any(l.discount for l in lines if not l.display_type)"/>
        <t t-set="has_tax" t-value="any(l.tax_ids for l in lines if not l.display_type)"/>

        <table class="ops-items-table">
            <thead>
                <tr t-attf-style="background:#{_ops['primary']}; color:#{_ops['text_on_primary']};">
                    <th style="width:4%;" class="ctr">#</th>
                    <th>Description</th>
                    <th style="width:8%;" class="num">Qty</th>
                    <th style="width:7%;" class="ctr">UoM</th>
                    <th style="width:12%;" class="num">Unit Price</th>
                    <th t-if="has_discount" style="width:7%;" class="num">Disc.%</th>
                    <th t-if="has_tax" style="width:10%;" class="ctr">Tax</th>
                    <th style="width:14%;" class="num">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                <t t-set="line_num" t-value="0"/>
                <t t-foreach="lines" t-as="line">
                    <t t-if="line.display_type == 'line_section'">
                        <tr><td class="ops-section-line" colspan="99" t-attf-style="padding:8px 8px 4px; font-weight:600; font-size:9pt; color:#{_ops['primary']};"><t t-esc="line.name"/></td></tr>
                    </t>
                    <t t-if="line.display_type == 'line_note'">
                        <tr><td colspan="99" style="padding:2px 8px 2px 18px; font-style:italic; font-size:8pt; color:#64748b;"><t t-esc="line.name"/></td></tr>
                    </t>
                    <t t-if="not line.display_type">
                        <t t-set="line_num" t-value="line_num + 1"/>
                        <tr>
                            <td class="ctr" style="color:#94a3b8; font-size:8pt;"><t t-esc="line_num"/></td>
                            <td>
                                <t t-if="_ops.get('show_code') and line.product_id and line.product_id.default_code">
                                    <span class="ops-product-code">[<t t-esc="line.product_id.default_code"/>]</span><br/>
                                </t>
                                <span t-esc="line.name"/>
                            </td>
                            <td class="num"><t t-esc="line.product_qty" t-options="{'widget':'float','precision':2}"/></td>
                            <td class="ctr" style="font-size:8pt; color:#64748b;">
                                <t t-if="line.product_uom_id" t-esc="line.product_uom_id.name"/>
                            </td>
                            <td class="num"><t t-esc="line.price_unit" t-options="{'widget':'monetary','display_currency':doc.currency_id}"/></td>
                            <td t-if="has_discount" class="num">
                                <t t-if="line.discount"><t t-esc="line.discount" t-options="{'widget':'float','precision':1}"/>%</t>
                            </td>
                            <td t-if="has_tax" class="ctr" style="font-size:7.5pt; color:#64748b;">
                                <t t-if="line.tax_ids" t-esc="', '.join(line.tax_ids.mapped('name'))"/>
                            </td>
                            <td class="num" style="font-weight:500;">
                                <t t-esc="line.price_subtotal" t-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                            </td>
                        </tr>
                    </t>
                </t>
            </tbody>
        </table>

        <!-- Totals -->
        <t t-set="amount_untaxed" t-value="doc.amount_untaxed"/>
        <t t-set="amount_tax" t-value="doc.amount_tax"/>
        <t t-set="amount_total" t-value="doc.amount_total"/>
        <t t-set="currency" t-value="doc.currency_id"/>
        <t t-call="ops_theme.ops_totals_block"/>

        <!-- Bottom section (no bank details on PO - we're buying, not selling) -->
        <t t-set="amount_for_words" t-value="doc.amount_total"/>
        <t t-set="currency_for_words" t-value="doc.currency_id"/>
        <t t-set="doc_note" t-value="doc.note"/>
        <t t-call="ops_theme.ops_amount_words_block"/>
        <t t-call="ops_theme.ops_terms_block"/>
        <t t-call="ops_theme.ops_signature_block"/>
    </template>

    <!-- ==================== PURCHASE ORDER ========================== -->
    <template id="report_purchaseorder_document_ops"
              name="OPS Purchase Order"
              inherit_id="purchase.report_purchaseorder_document"
              priority="99">

        <xpath expr="//div[@class='page']" position="replace">
            <div class="page ops-report-page">
                <!-- Alias o -> doc for OPS component compatibility -->
                <t t-set="doc" t-value="o"/>
                <t t-call="ops_matrix_core.ops_purchase_page_content"/>
            </div>
        </xpath>

    </template>

    <!-- ==================== RFQ (reuses shared content) ============= -->
    <template id="report_purchasequotation_document_ops"
              name="OPS Request for Quotation"
              inherit_id="purchase.report_purchasequotation_document"
              priority="99">

        <xpath expr="//div[@class='page']" position="replace">
            <div class="page ops-report-page">
                <!-- Alias o -> doc -->
                <t t-set="doc" t-value="o"/>
                <t t-call="ops_matrix_core.ops_purchase_page_content"/>
            </div>
        </xpath>

    </template>

</odoo>
