<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS DELIVERY NOTE / GOODS RECEIPT / TRANSFER NOTE
         Inherits native stock.report_delivery_document via XPath.
         ================================================================ -->

    <!-- Re-enable and style native stock report actions -->
    <record id="stock.action_report_delivery" model="ir.actions.report">
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
        <field name="binding_model_id" ref="stock.model_stock_picking"/>
        <field name="binding_type">report</field>
    </record>
    <record id="stock.action_report_picking" model="ir.actions.report">
        <field name="paperformat_id" ref="ops_theme.paperformat_ops_external"/>
        <field name="binding_model_id" ref="stock.model_stock_picking"/>
        <field name="binding_type">report</field>
    </record>

    <template id="report_delivery_document_ops"
              name="OPS Delivery Document"
              inherit_id="stock.report_delivery_document"
              priority="99">

        <xpath expr="//div[@class='page']" position="replace">
            <div class="page ops-report-page">
                <!-- Alias o -> doc -->
                <t t-set="doc" t-value="o"/>
                <t t-set="company" t-value="doc.company_id"/>
                <t t-set="_ops" t-value="company.get_ops_report_settings()"/>
                <t t-set="is_outgoing" t-value="doc.picking_type_code == 'outgoing'"/>
                <t t-set="is_incoming" t-value="doc.picking_type_code == 'incoming'"/>

                <!-- CSS -->
                <t t-call="ops_theme.ops_report_css"/>

                <!-- Title Bar -->
                <t t-set="doc_title" t-value="'Delivery Note' if is_outgoing else ('Goods Receipt' if is_incoming else 'Internal Transfer')"/>
                <t t-set="doc_ref" t-value="doc.name"/>
                <t t-call="ops_theme.ops_title_bar"/>

                <!-- Addresses -->
                <table style="width:100%; border-collapse:collapse; margin-bottom:14px;">
                    <tr>
                        <td style="width:50%; vertical-align:top; padding-right:10px;">
                            <t t-if="is_outgoing and doc.partner_id">
                                <t t-call="ops_theme.ops_address_block">
                                    <t t-set="partner" t-value="doc.partner_id"/>
                                    <t t-set="addr_label" t-value="'Deliver To'"/>
                                </t>
                            </t>
                            <t t-if="is_incoming and doc.partner_id">
                                <t t-call="ops_theme.ops_address_block">
                                    <t t-set="partner" t-value="doc.partner_id"/>
                                    <t t-set="addr_label" t-value="'From Vendor'"/>
                                </t>
                            </t>
                            <t t-if="not is_outgoing and not is_incoming">
                                <div style="font-size:8.5pt; margin-bottom:12px;">
                                    <div t-attf-style="font-size:7pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#{_ops['primary']}; margin-bottom:4px;">From</div>
                                    <div style="font-weight:600; font-size:9.5pt;"><t t-esc="doc.location_id.display_name"/></div>
                                </div>
                            </t>
                        </td>
                        <td style="width:50%; vertical-align:top; padding-left:10px;">
                            <t t-if="is_outgoing">
                                <div style="font-size:8.5pt; margin-bottom:12px;">
                                    <div t-attf-style="font-size:7pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#{_ops['primary']}; margin-bottom:4px;">Ship From</div>
                                    <div style="font-weight:600; font-size:9.5pt;"><t t-esc="doc.location_id.display_name"/></div>
                                </div>
                            </t>
                            <t t-if="is_incoming">
                                <div style="font-size:8.5pt; margin-bottom:12px;">
                                    <div t-attf-style="font-size:7pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#{_ops['primary']}; margin-bottom:4px;">Receive At</div>
                                    <div style="font-weight:600; font-size:9.5pt;"><t t-esc="doc.location_dest_id.display_name"/></div>
                                </div>
                            </t>
                            <t t-if="not is_outgoing and not is_incoming">
                                <div style="font-size:8.5pt; margin-bottom:12px;">
                                    <div t-attf-style="font-size:7pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#{_ops['primary']}; margin-bottom:4px;">To</div>
                                    <div style="font-weight:600; font-size:9.5pt;"><t t-esc="doc.location_dest_id.display_name"/></div>
                                </div>
                            </t>
                        </td>
                    </tr>
                </table>

                <!-- Info Bar -->
                <table class="ops-info-bar" t-attf-style="width:100%; border-collapse:collapse; margin-bottom:14px;">
                    <tr t-attf-style="background:rgba(#{_ops['rgb']},0.04);">
                        <td t-if="doc.scheduled_date" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Scheduled Date</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;">
                                <t t-esc="doc.scheduled_date" t-options="{'widget': 'date'}"/>
                            </div>
                        </td>
                        <td t-if="doc.date_done" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Completed Date</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;">
                                <t t-esc="doc.date_done" t-options="{'widget': 'date'}"/>
                            </div>
                        </td>
                        <td t-if="doc.origin" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Source Document</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.origin"/></div>
                        </td>
                        <td t-if="doc.picking_type_id" class="ops-info-cell" style="padding:6px 10px; text-align:center;">
                            <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:#64748b;">Operation Type</div>
                            <div style="font-size:8.5pt; font-weight:500; margin-top:2px; color:#1e293b;"><t t-esc="doc.picking_type_id.name"/></div>
                        </td>
                    </tr>
                </table>

                <!-- Line Items (no monetary values) -->
                <t t-set="moves" t-value="doc.move_ids"/>
                <t t-set="has_lot" t-value="any(m.move_line_ids and any(ml.lot_id or ml.lot_name for ml in m.move_line_ids) for m in moves)"/>

                <table class="ops-items-table">
                    <thead>
                        <tr t-attf-style="background:#{_ops['primary']}; color:#{_ops['text_on_primary']};">
                            <th style="width:4%;" class="ctr">#</th>
                            <th>Product</th>
                            <th style="width:10%;" class="num">Ordered</th>
                            <th style="width:10%;" class="num">Delivered</th>
                            <th style="width:8%;" class="ctr">UoM</th>
                            <th t-if="has_lot" style="width:15%;">Lot/Serial</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="line_num" t-value="0"/>
                        <t t-foreach="moves" t-as="move">
                            <t t-set="line_num" t-value="line_num + 1"/>
                            <tr>
                                <td class="ctr" style="color:#94a3b8; font-size:8pt;"><t t-esc="line_num"/></td>
                                <td>
                                    <t t-if="_ops.get('show_code') and move.product_id and move.product_id.default_code">
                                        <span class="ops-product-code">[<t t-esc="move.product_id.default_code"/>]</span><br/>
                                    </t>
                                    <span t-esc="move.description_picking or move.product_id.name"/>
                                </td>
                                <td class="num"><t t-esc="move.product_uom_qty" t-options="{'widget':'float','precision':2}"/></td>
                                <td class="num"><t t-esc="move.quantity" t-options="{'widget':'float','precision':2}"/></td>
                                <td class="ctr" style="font-size:8pt; color:#64748b;">
                                    <t t-if="move.product_uom" t-esc="move.product_uom.name"/>
                                </td>
                                <td t-if="has_lot" style="font-size:7.5pt; color:#64748b;">
                                    <t t-foreach="move.move_line_ids" t-as="ml">
                                        <t t-if="ml.lot_id"><t t-esc="ml.lot_id.name"/><t t-if="not ml_last">, </t></t>
                                        <t t-elif="ml.lot_name"><t t-esc="ml.lot_name"/><t t-if="not ml_last">, </t></t>
                                    </t>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <!-- Delivery Summary -->
                <div style="margin-top:14px; page-break-inside:avoid;">
                    <table class="ops-summary-bar" style="width:100%; border-collapse:collapse;">
                        <tr>
                            <td style="padding:8px 12px; text-align:center;">
                                <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.4px; color:#94a3b8; margin-bottom:2px;">Total Lines</div>
                                <div t-attf-style="font-size:14pt; font-weight:700; color:#{_ops['primary']};"><t t-esc="len(moves)"/></div>
                            </td>
                            <td style="padding:8px 12px; text-align:center;">
                                <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.4px; color:#94a3b8; margin-bottom:2px;">Total Quantity</div>
                                <div t-attf-style="font-size:14pt; font-weight:700; color:#{_ops['primary']};"><t t-esc="sum(m.quantity for m in moves)" t-options="{'widget':'float','precision':2}"/></div>
                            </td>
                            <td t-if="doc.shipping_weight" style="padding:8px 12px; text-align:center;">
                                <div style="font-size:6.5pt; font-weight:600; text-transform:uppercase; letter-spacing:0.4px; color:#94a3b8; margin-bottom:2px;">Total Weight</div>
                                <div t-attf-style="font-size:14pt; font-weight:700; color:#{_ops['primary']};"><t t-esc="doc.shipping_weight" t-options="{'widget':'float','precision':2}"/> kg</div>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Notes -->
                <t t-set="doc_note" t-value="doc.note"/>
                <t t-call="ops_theme.ops_terms_block"/>

                <!-- Signatures -->
                <t t-call="ops_theme.ops_signature_block"/>

            </div>
        </xpath>

    </template>

</odoo>
