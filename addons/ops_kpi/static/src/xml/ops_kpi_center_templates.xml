<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="ops_kpi.KPICenterAction">
        <div class="ops-dashboard ops-dashboard-v2">
            <div class="ops-dashboard-container">
                <!-- Header -->
                <div class="ops-dashboard-header">
                    <h1 class="dashboard-title">
                        <t t-if="state.dashboardData">
                            <t t-esc="state.dashboardData.dashboard_name"/>
                        </t>
                        <t t-else="">OPS Analytics</t>
                    </h1>

                    <div class="dashboard-controls">
                        <!-- Dashboard Selector -->
                        <t t-if="state.dashboards.length > 1">
                            <select class="form-select dashboard-selector"
                                    t-on-change="onDashboardChange"
                                    t-att-value="state.selectedDashboardId">
                                <t t-foreach="state.dashboards" t-as="dashboard" t-key="dashboard.id">
                                    <option t-att-value="dashboard.id"
                                            t-att-selected="dashboard.id === state.selectedDashboardId">
                                        <t t-esc="dashboard.name"/>
                                    </option>
                                </t>
                            </select>
                        </t>

                        <!-- Period Selector (Enhanced) -->
                        <PeriodSelector
                            value="state.period"
                            periods="periods"
                            onChange.bind="onPeriodChange"/>

                        <!-- View Mode Toggle -->
                        <button class="chart-action-btn"
                                t-att-class="{'active': state.viewMode === 'list'}"
                                t-on-click="toggleViewMode"
                                title="Toggle View">
                            <i t-attf-class="fa #{state.viewMode === 'grid' ? 'fa-list' : 'fa-th'}"/>
                        </button>

                        <!-- Refresh Button -->
                        <button class="refresh-button"
                                t-on-click="onRefresh"
                                t-att-disabled="state.refreshing">
                            <i t-attf-class="fa #{state.refreshing ? 'fa-spinner fa-spin' : 'fa-sync-alt'}"/>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>

                <!-- Filter Panel -->
                <t t-if="filterBranches.length > 0 or filterBusinessUnits.length > 0">
                    <FilterPanel
                        branches="filterBranches"
                        businessUnits="filterBusinessUnits"
                        filters="state.filters"
                        collapsed="true"
                        onChange.bind="onFilterChange"/>
                </t>

                <!-- Drilldown Breadcrumb -->
                <t t-if="isInDrilldown">
                    <DrilldownBreadcrumb
                        path="state.drilldownPath"
                        onNavigate.bind="onDrilldownNavigate"/>
                </t>

                <!-- Loading State -->
                <t t-if="state.loading">
                    <div class="ops-dashboard-loading">
                        <div class="loading-spinner"/>
                        <div class="loading-text">Loading dashboard...</div>
                    </div>
                </t>

                <!-- Error State -->
                <t t-elif="state.error">
                    <div class="ops-dashboard-empty">
                        <div class="empty-icon">
                            <i class="fa fa-exclamation-triangle"/>
                        </div>
                        <div class="empty-title">Error</div>
                        <div class="empty-message">
                            <t t-esc="state.error"/>
                        </div>
                    </div>
                </t>

                <!-- Empty State -->
                <t t-elif="!hasChartData">
                    <div class="ops-dashboard-empty">
                        <div class="empty-icon">
                            <i class="fa fa-chart-bar"/>
                        </div>
                        <div class="empty-title">No Dashboard Data</div>
                        <div class="empty-message">
                            <t t-if="state.dashboards.length === 0">
                                No dashboards are available for your user.
                            </t>
                            <t t-else="">
                                This dashboard has no widgets configured or you don't have access to view the data.
                            </t>
                        </div>
                    </div>
                </t>

                <!-- Drilldown View -->
                <t t-elif="isInDrilldown and state.drilldownData">
                    <div class="ops-dashboard-grid-12">
                        <!-- KPI Summary -->
                        <div class="col-span-12">
                            <div class="ops-kpi-card-enhanced" t-att-style="'--kpi-color: ' + (state.drilldownData.kpi.color || '#3b82f6')">
                                <div class="kpi-header">
                                    <span class="kpi-name"><t t-esc="state.drilldownData.kpi.name"/> - Detail View</span>
                                    <div class="kpi-icon" t-att-style="'background-color: ' + (state.drilldownData.kpi.color || '#3b82f6')">
                                        <i t-attf-class="fa #{state.drilldownData.kpi.icon || 'fa-chart-line'}"/>
                                    </div>
                                </div>
                                <div class="kpi-value">
                                    <t t-esc="formatValue(state.drilldownData.kpi)"/>
                                </div>
                            </div>
                        </div>

                        <!-- Trend Chart -->
                        <t t-if="state.drilldownData.timeSeries.length > 0">
                            <div class="col-span-8">
                                <AreaChart
                                    title="'Trend Over Time'"
                                    subtitle="'Daily values for selected period'"
                                    data="state.drilldownData.timeSeries"
                                    color="state.drilldownData.kpi.color"
                                    formatType="state.drilldownData.kpi.format_type"
                                    currencyInfo="currencyInfo"/>
                            </div>
                        </t>

                        <!-- Breakdown Chart -->
                        <t t-if="state.drilldownData.breakdown.length > 0">
                            <div class="col-span-4">
                                <HorizontalBarChart
                                    title="'By Branch'"
                                    data="state.drilldownData.breakdown"
                                    formatType="state.drilldownData.kpi.format_type"
                                    currencyInfo="currencyInfo"
                                    onClick.bind="onChartItemClick"/>
                            </div>
                        </t>
                    </div>
                </t>

                <!-- Main Dashboard View -->
                <t t-else="">
                    <!-- KPI Cards Row -->
                    <div t-attf-class="ops-dashboard-grid #{state.viewMode === 'list' ? 'list-view' : ''}">
                        <t t-foreach="kpiCards" t-as="widget" t-key="widget.widget_id || widget.kpi_id">
                            <div t-attf-class="ops-kpi-card #{getCardColorClass(widget)}"
                                 t-on-click="() => this.onKPIDrilldown(widget)"
                                 style="cursor: pointer;">

                                <!-- Card Header: Name + Icon -->
                                <div class="kpi-header">
                                    <span class="kpi-name"><t t-esc="widget.name"/></span>
                                    <div class="kpi-icon" t-attf-style="background-color: #{widget.color}">
                                        <i t-attf-class="fa #{widget.icon || 'fa-chart-bar'}"/>
                                    </div>
                                </div>

                                <!-- Main Value -->
                                <div class="kpi-value">
                                    <t t-esc="formatValue(widget)"/>
                                </div>

                                <!-- Trend Indicator -->
                                <t t-if="widget.trend_direction and widget.trend_direction !== 'flat'">
                                    <div t-attf-class="kpi-trend #{getTrendClass(widget)}">
                                        <i t-attf-class="trend-icon fa #{getTrendIcon(widget)}"/>
                                        <span class="trend-value">
                                            <t t-esc="Math.abs(widget.trend_percentage || 0).toFixed(1)"/>%
                                        </span>
                                        <span class="trend-label">vs previous</span>
                                    </div>
                                </t>

                                <!-- Subtitle -->
                                <t t-if="widget.subtitle">
                                    <div class="kpi-subtitle">
                                        <t t-esc="widget.subtitle"/>
                                    </div>
                                </t>
                            </div>
                        </t>
                    </div>

                    <!-- Charts Section -->
                    <t t-if="trendCharts.length > 0 or breakdownCharts.length > 0 or alerts.length > 0">
                        <div class="ops-charts-section">
                            <!-- Trend Charts: full width when no sidebar, 8/12 with sidebar -->
                            <t t-set="hasSidebar" t-value="alerts.length > 0 or breakdownCharts.length > 0"/>
                            <t t-if="hasSidebar">
                                <div class="ops-dashboard-grid-12">
                                    <t t-foreach="trendCharts" t-as="chart" t-key="chart.kpi_id">
                                        <div class="col-span-8">
                                            <AreaChart
                                                title="chart.title"
                                                subtitle="'Daily trend for selected period'"
                                                data="chart.data"
                                                color="chart.color"
                                                formatType="chart.format_type"
                                                currencyInfo="currencyInfo"/>
                                        </div>
                                    </t>

                                    <!-- Alerts Panel -->
                                    <t t-if="alerts.length > 0">
                                        <div class="col-span-4">
                                            <AlertList
                                                title="'Alerts &amp; Insights'"
                                                alerts="alerts"
                                                onClick.bind="onAlertClick"/>
                                        </div>
                                    </t>
                                </div>

                                <!-- Breakdown Charts in their own row -->
                                <t t-if="breakdownCharts.length > 0">
                                    <div class="ops-dashboard-grid-12">
                                        <t t-foreach="breakdownCharts" t-as="chart" t-key="chart.kpi_id + '_breakdown'">
                                            <div class="col-span-6">
                                                <HorizontalBarChart
                                                    title="chart.title"
                                                    data="chart.data"
                                                    formatType="chart.format_type"
                                                    currencyInfo="currencyInfo"
                                                    showRanking="true"
                                                    onClick.bind="onChartItemClick"/>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </t>

                            <!-- No sidebar: trend charts take full width in a simple stack -->
                            <t t-if="!hasSidebar">
                                <t t-foreach="trendCharts" t-as="chart" t-key="chart.kpi_id">
                                    <div class="ops-chart-card-full">
                                        <AreaChart
                                            title="chart.title"
                                            subtitle="'Daily trend for selected period'"
                                            data="chart.data"
                                            color="chart.color"
                                            formatType="chart.format_type"
                                            currencyInfo="currencyInfo"/>
                                    </div>
                                </t>
                            </t>
                        </div>
                    </t>

                    <!-- Auto-refresh indicator -->
                    <t t-if="hasAutoRefresh">
                        <div class="auto-refresh-indicator">
                            <div class="refresh-dot"/>
                            <span>Auto-refresh: <t t-esc="refreshIntervalText"/></span>
                        </div>
                    </t>
                </t>
            </div>
        </div>
    </t>
</templates>
