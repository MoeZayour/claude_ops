///
/// OPS Dark Mode — Core Layout + OPS Component Overrides
/// =====================================================
///
/// WHY THIS FILE EXISTS:
/// Odoo 19 CE compiles SCSS variables ($o-webclient-background-color,
/// $o-view-background-color) into hardcoded light-mode values in the CSS.
/// Even with $enable-dark-mode: true, these fixed values override
/// Bootstrap 5.3's dark CSS variables.
///
/// This file follows Odoo's own *.dark.scss pattern — runtime CSS overrides
/// under html[data-bs-theme="dark"] for elements that cannot be fixed at
/// SCSS compile time (the variables are used in mix()/color-contrast()
/// functions that need real color values).
///
/// IMPORTANT: Odoo 19 sets $variable-prefix: '' so CSS custom properties
/// are --body-bg (NOT --bs-body-bg), --body-color (NOT --bs-body-color), etc.
///

// =============================================================================
// 0. FIX BS5 DARK COLOR VARIABLES
// =============================================================================
// BS5 derives dark-mode --link-color from --primary (#1e293b → #787f89 muted gray).
// Our primary is dark navy which becomes invisible. Override with OPS branded blue.

html[data-bs-theme="dark"] {
    // Fix link colors — use OPS secondary (blue) instead of BS5 auto-derived gray
    --link-color: var(--ops-secondary, #3b82f6);
    --link-hover-color: #60a5fa;
    --link-color-rgb: 59, 130, 246;
    --link-hover-color-rgb: 96, 165, 250;

    // Fix primary text emphasis — BS5 auto-derives #0c1018 (nearly black)
    --primary-text-emphasis: #60a5fa;
    --primary-bg-subtle: #1a2744;
    --primary-border-subtle: #2d4a7a;
}

// =============================================================================
// 1. CORE LAYOUT — Fix hardcoded SCSS compile-time backgrounds
// =============================================================================
// The #1 blocker: .o_web_client compiles to { background-color: #f8f9fa; }
// from $o-webclient-background-color. Cannot replace the SCSS var with CSS
// var() because mail/im_livechat use it in mix() at compile time.

html[data-bs-theme="dark"] {

    // ---- Page wrapper (on <body>) ----
    .o_web_client {
        background-color: var(--body-bg, #212529) !important;
        color-scheme: dark;
        color: var(--body-color, #dee2e6);
    }

    // ---- Content areas ----
    .o_action_manager {
        background-color: var(--body-bg, #212529);
    }

    .o_content {
        background-color: var(--body-bg, #212529);
    }

    .o_view_controller {
        background-color: var(--body-bg, #212529);
    }

    // ---- Form view ----
    .o_form_sheet_bg {
        background-color: var(--body-bg, #212529) !important;
    }

    .o_form_sheet {
        background-color: var(--tertiary-bg, #2b3035) !important;
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);
    }

    // ---- Control panel (breadcrumb / search bar area) ----
    .o_control_panel,
    .o_control_panel_main {
        background-color: var(--body-bg, #212529);
        color: var(--body-color, #dee2e6);
    }

    .o_searchview {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        .o_searchview_input {
            color: var(--body-color, #dee2e6);
        }
    }

    // ---- List view ----
    .o_list_view {
        --ListRenderer-thead-bg-color: var(--tertiary-bg, #2b3035);

        .o_list_table {
            --table-bg: var(--body-bg, #212529);
            --table-color: var(--body-color, #dee2e6);
            --table-border-color: var(--border-color, #495057);
            --table-striped-bg: var(--tertiary-bg, #2b3035);
            --table-hover-bg: rgba(255, 255, 255, 0.05);
            color: var(--body-color, #dee2e6);

            th {
                color: var(--body-color, #dee2e6);
            }
        }
    }

    // ---- Kanban view ----
    .o_kanban_view {
        background-color: var(--body-bg, #212529);
    }

    .o_kanban_record {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);
    }

    .o_kanban_group_header {
        background-color: var(--body-bg, #212529);
    }

    // ---- Calendar view ----
    .o_calendar_renderer {
        background-color: var(--body-bg, #212529);
    }

    .fc {
        .fc-scrollgrid {
            border-color: var(--border-color, #495057);
        }

        .fc-col-header-cell,
        .fc-daygrid-day,
        .fc-timegrid-slot {
            background-color: var(--body-bg, #212529);
            border-color: var(--border-color, #495057);
        }

        .fc-day-today {
            background-color: rgba(var(--ops-secondary-rgb, 59, 130, 246), 0.1) !important;
        }
    }

    // ---- Pivot view ----
    .o_pivot {
        background-color: var(--body-bg, #212529);
        color: var(--body-color, #dee2e6);

        table {
            --table-bg: var(--body-bg, #212529);
            --table-color: var(--body-color, #dee2e6);
            --table-border-color: var(--border-color, #495057);
            color: var(--body-color, #dee2e6);
        }

        .o_pivot_header_cell_closed,
        .o_pivot_header_cell_opened {
            background-color: var(--tertiary-bg, #2b3035);
            color: var(--body-color, #dee2e6);
        }
    }

    // ---- Graph view ----
    .o_graph_renderer {
        background-color: var(--body-bg, #212529);
    }

    // ---- Cards (Odoo overrides $card-bg with $o-view-background-color) ----
    .card {
        --card-bg: var(--tertiary-bg, #2b3035);
        --card-border-color: var(--border-color, #495057);
        --card-color: var(--body-color, #dee2e6);
        --card-cap-bg: var(--secondary-bg, #343a40);
    }

    // ---- Modals (Odoo overrides $modal-content-bg) ----
    .modal-content {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);
    }

    .modal-header,
    .modal-footer {
        border-color: var(--border-color, #495057);
    }

    // ---- Form controls ----
    .form-control,
    .form-select {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        &:focus {
            background-color: var(--tertiary-bg, #2b3035);
            border-color: var(--ops-secondary, #3b82f6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        &:disabled,
        &[readonly] {
            background-color: var(--secondary-bg, #343a40);
        }
    }

    // ---- Notebook tabs (form view) ----
    .o_notebook .nav-link {
        color: var(--body-color, #dee2e6);

        &.active {
            background-color: var(--tertiary-bg, #2b3035);
            border-color: var(--border-color, #495057);
            border-bottom-color: var(--tertiary-bg, #2b3035);
        }
    }

    // ---- Dropdown menus (global) ----
    .dropdown-menu {
        --dropdown-bg: var(--tertiary-bg, #2b3035);
        --dropdown-color: var(--body-color, #dee2e6);
        --dropdown-border-color: var(--border-color, #495057);
        --dropdown-link-color: var(--body-color, #dee2e6);
        --dropdown-link-hover-bg: rgba(255, 255, 255, 0.08);
        --dropdown-link-hover-color: #fff;
        --dropdown-divider-bg: var(--border-color, #495057);
    }

    // ---- List group (Odoo overrides $list-group-bg) ----
    .list-group-item {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);
    }

    // ---- Settings page ----
    .o_base_settings {
        .o_setting_container,
        .o_settings_container {
            background-color: var(--body-bg, #212529);
        }

        .settings_tab {
            background-color: var(--body-bg, #212529);
            border-color: var(--border-color, #495057);

            .selected {
                background-color: var(--tertiary-bg, #2b3035);
            }
        }

        .app_settings_block {
            background-color: var(--body-bg, #212529);
            color: var(--body-color, #dee2e6);
        }

        .o_form_label,
        label {
            color: var(--body-color, #dee2e6);
        }
    }

    // ---- Chatter ----
    .o-mail-Form-chatter,
    .o-mail-Chatter {
        background-color: var(--body-bg, #212529);
    }

    .o-mail-Message {
        background-color: var(--body-bg, #212529);
        color: var(--body-color, #dee2e6);
    }

    // ---- Statusbar ----
    .o_statusbar_status .o_arrow_button {
        background-color: var(--secondary-bg, #343a40);
        color: var(--body-color, #dee2e6);
        border-color: var(--border-color, #495057);
    }

    // ---- Breadcrumb ----
    .o_breadcrumb .active {
        color: var(--body-color, #dee2e6);
    }

    // ---- Stat buttons (form view KPI blocks) ----
    .oe_stat_button {
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        .o_stat_value {
            color: var(--body-color, #dee2e6);
        }
    }

    // ---- Spreadsheet / Pivot cell ----
    .o_spreadsheet {
        background-color: var(--body-bg, #212529);
    }

    // ---- Home menu (app switcher grid) ----
    .o_home_menu {
        background-color: var(--body-bg, #212529);
    }

    .o_app {
        color: var(--body-color, #dee2e6);
    }

    // ---- Scrollbar theming ----
    * {
        scrollbar-color: var(--secondary-bg, #343a40) var(--body-bg, #212529);
    }
}

// =============================================================================
// 2. DARK MODE CSS VARIABLE ADAPTATIONS
// =============================================================================
// Ensure OPS CSS variables produce sensible values in dark context.

html[data-bs-theme="dark"] {
    // Soften box shadows for dark backgrounds
    --ops-card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
}

// =============================================================================
// 3. BRANDED NAVBAR — DROPDOWN MENUS IN DARK MODE
// =============================================================================
// The navbar stays branded (company color) in both modes.
// Dropdown menus opened from it need dark backgrounds, not white.

html[data-bs-theme="dark"] {
    // Navbar dropdown menus (app switcher, systray, user menu)
    .o_main_navbar {
        .dropdown-menu,
        .o-dropdown--menu {
            background-color: var(--body-bg, #212529);
            border-color: var(--border-color, #495057);
            color: var(--body-color, #dee2e6);

            .dropdown-item {
                color: var(--body-color, #dee2e6);

                &:hover,
                &:focus {
                    background-color: rgba(255, 255, 255, 0.08);
                    color: #ffffff;
                }

                &.active,
                &:active {
                    background-color: rgba(255, 255, 255, 0.12);
                }
            }

            .dropdown-divider {
                border-color: var(--border-color, #495057);
            }
        }

        // App switcher panel
        .o_navbar_apps_menu .dropdown-menu {
            background-color: var(--body-bg, #212529);
        }
    }

    // Sub-menu dropdowns under top menu items
    .o_menu_sections {
        .dropdown-menu,
        .o-dropdown--menu {
            background-color: var(--body-bg, #212529);
            border-color: var(--border-color, #495057);

            .dropdown-item,
            a,
            button {
                color: var(--body-color, #dee2e6);

                &:hover,
                &:focus {
                    background-color: rgba(255, 255, 255, 0.08);
                    color: #ffffff;
                }
            }
        }
    }
}

// =============================================================================
// 4. POPUPS / TOASTS / AUTOCOMPLETE IN DARK MODE
// =============================================================================

html[data-bs-theme="dark"] {
    // Notification toasts
    .o_notification {
        &.border-info,
        &.border-success,
        &.border-warning,
        &.border-danger {
            background-color: var(--body-bg, #212529);
            color: var(--body-color, #dee2e6);
        }
    }

    // Many2one dropdown autocomplete
    .o-autocomplete--dropdown-menu {
        background-color: var(--body-bg, #212529);
        border-color: var(--border-color, #495057);

        .o-autocomplete--dropdown-item {
            color: var(--body-color, #dee2e6);

            &:hover,
            &.focus {
                background-color: rgba(255, 255, 255, 0.08);
            }
        }
    }

    // Command palette (Ctrl+K)
    .o_command_palette {
        .o_command_palette_search input {
            background-color: var(--body-bg, #212529);
            color: var(--body-color, #dee2e6);
            border-color: var(--border-color, #495057);
        }

        .o_command {
            color: var(--body-color, #dee2e6);

            &:hover,
            &.focused {
                background-color: rgba(255, 255, 255, 0.08);
            }
        }
    }

    // Tooltips
    .o_popover,
    .popover {
        --popover-bg: var(--tertiary-bg, #2b3035);
        --popover-border-color: var(--border-color, #495057);
        --popover-body-color: var(--body-color, #dee2e6);
        --popover-header-bg: var(--secondary-bg, #343a40);
    }
}

// =============================================================================
// 5. LOGIN PAGE (OPS CUSTOM COMPONENT)
// =============================================================================

html[data-bs-theme="dark"] {
    .ops-login-container {
        background: linear-gradient(135deg, var(--body-bg, #212529) 0%, var(--ops-primary, #1e293b) 100%);
    }

    .ops-login-panel {
        background: var(--ops-primary, #1e293b);
        border-color: var(--border-color, #495057);
    }

    .ops-login-brand {
        color: var(--body-color, #dee2e6);
    }

    .ops-login-form-panel {
        background-color: var(--body-bg, #212529) !important;
        color: var(--body-color, #dee2e6);
    }

    .ops-login-header h2,
    .ops-login-header p {
        color: var(--body-color, #dee2e6);
    }

    .ops-login-form-panel input[type="text"],
    .ops-login-form-panel input[type="password"],
    .ops-login-form-panel input[type="email"] {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        &:focus {
            background-color: var(--tertiary-bg, #2b3035);
            border-color: var(--ops-secondary, #3b82f6);
        }
    }
}

// =============================================================================
// 6. BUTTONS & BADGES — Branded colors in dark mode
// =============================================================================
// BS5 dark mode auto-adjusts btn-primary but the result is muted.
// Override with OPS branded colors for visibility.

html[data-bs-theme="dark"] {
    .btn-primary {
        --btn-bg: var(--ops-secondary, #3b82f6);
        --btn-border-color: var(--ops-secondary, #3b82f6);
        --btn-hover-bg: #2563eb;
        --btn-hover-border-color: #2563eb;
        --btn-active-bg: #1d4ed8;
        --btn-active-border-color: #1d4ed8;
        --btn-color: #fff;
    }

    .btn-success {
        --btn-bg: var(--ops-success, #10b981);
        --btn-border-color: var(--ops-success, #10b981);
    }

    .btn-warning {
        --btn-bg: var(--ops-warning, #f59e0b);
        --btn-border-color: var(--ops-warning, #f59e0b);
    }

    .btn-danger {
        --btn-bg: var(--ops-danger, #ef4444);
        --btn-border-color: var(--ops-danger, #ef4444);
    }

    .badge.text-bg-primary,
    .badge.bg-primary {
        background-color: var(--ops-secondary, #3b82f6) !important;
        color: #fff !important;
    }
}

// =============================================================================
// 7. APP GRID (OPS CUSTOM — FUTURE)
// =============================================================================

html[data-bs-theme="dark"] {
    .ops-app-grid {
        background: var(--body-bg, #212529);
    }

    .ops-app-tile {
        background: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);

        &:hover {
            background: var(--secondary-bg, #343a40);
        }
    }
}
