///
/// OPS Dark Mode — Core Layout + OPS Component Overrides
/// =====================================================
///
/// BUNDLE: web.assets_web_dark (only loaded when dark mode active)
///
/// WHY THIS FILE EXISTS:
/// Odoo 19 CE compiles SCSS variables ($o-webclient-background-color,
/// $o-view-background-color) into hardcoded light-mode values in the CSS.
/// Even with $enable-dark-mode: true, these fixed values override
/// Bootstrap 5.3's dark CSS variables.
///
/// This file provides runtime CSS overrides under html[data-bs-theme="dark"]
/// for elements that cannot be fixed at SCSS compile time.
///
/// IMPORTANT: Odoo 19 sets $variable-prefix: '' so CSS custom properties
/// are --body-bg (NOT --bs-body-bg), --body-color (NOT --bs-body-color), etc.
///

// =============================================================================
// 0. FIX BS5 DARK COLOR VARIABLES
// =============================================================================
// BS5 derives dark-mode --link-color from --primary (#1e293b → #787f89 muted gray).
// Our primary is dark navy which becomes invisible. Override with OPS branded blue.

html[data-bs-theme="dark"] {
    // Fix link colors — use OPS secondary (blue) instead of BS5 auto-derived gray
    --link-color: var(--ops-secondary, #3b82f6);
    --link-hover-color: #60a5fa;
    --link-color-rgb: 59, 130, 246;
    --link-hover-color-rgb: 96, 165, 250;

    // Fix primary text emphasis — BS5 auto-derives #0c1018 (nearly black)
    --primary-text-emphasis: #60a5fa;
    --primary-bg-subtle: #1a2744;
    --primary-border-subtle: #2d4a7a;
}

// =============================================================================
// 1. CORE LAYOUT — Fix hardcoded SCSS compile-time backgrounds
// =============================================================================

html[data-bs-theme="dark"] {

    // ---- Page wrapper (on <body>) ----
    .o_web_client {
        background-color: var(--body-bg, #212529) !important;
        color-scheme: dark;
        color: var(--body-color, #dee2e6);
    }

    // ---- Content areas ----
    .o_action_manager {
        background-color: var(--body-bg, #212529);
    }

    .o_content {
        background-color: var(--body-bg, #212529);
    }

    .o_view_controller {
        background-color: var(--body-bg, #212529);
    }

    // ---- Form view ----
    .o_form_sheet_bg {
        background-color: var(--body-bg, #212529) !important;
    }

    .o_form_sheet {
        background-color: var(--tertiary-bg, #2b3035) !important;
        border-color: var(--border-color, #495057) !important;
        color: var(--body-color, #dee2e6);
    }

    // Form nosheet (no card wrapper, e.g. settings)
    .o_form_nosheet {
        background-color: var(--body-bg, #212529) !important;
    }

    // ---- Control panel (breadcrumb / search bar area) ----
    .o_control_panel,
    .o_control_panel_main {
        background-color: var(--body-bg, #212529);
        color: var(--body-color, #dee2e6);
    }

    .o_searchview {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        .o_searchview_input {
            color: var(--body-color, #dee2e6);
        }
    }

    // ---- List view ----
    .o_list_view {
        --ListRenderer-thead-bg-color: var(--tertiary-bg, #2b3035);
        --ListRenderer-tfoot-bg-color: var(--tertiary-bg, #2b3035);

        .o_list_table {
            --table-bg: var(--body-bg, #212529);
            --table-color: var(--body-color, #dee2e6);
            --table-border-color: var(--border-color, #495057);
            --table-striped-bg: var(--tertiary-bg, #2b3035);
            --table-hover-bg: rgba(255, 255, 255, 0.05);
            color: var(--body-color, #dee2e6);

            th {
                color: var(--body-color, #dee2e6);
            }
        }
    }

    // ---- Kanban view ----
    .o_kanban_view {
        background-color: var(--body-bg, #212529);
    }

    .o_kanban_record {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);
    }

    .o_kanban_group_header {
        background-color: var(--body-bg, #212529);
    }

    // ---- Calendar view ----
    .o_calendar_renderer {
        background-color: var(--body-bg, #212529);
    }

    .fc {
        .fc-scrollgrid {
            border-color: var(--border-color, #495057);
        }

        .fc-col-header-cell,
        .fc-daygrid-day,
        .fc-timegrid-slot {
            background-color: var(--body-bg, #212529);
            border-color: var(--border-color, #495057);
        }

        .fc-day-today {
            background-color: rgba(var(--ops-secondary-rgb, 59, 130, 246), 0.1) !important;
        }
    }

    // ---- Pivot view ----
    .o_pivot {
        background-color: var(--body-bg, #212529);
        color: var(--body-color, #dee2e6);

        table {
            --table-bg: var(--body-bg, #212529);
            --table-color: var(--body-color, #dee2e6);
            --table-border-color: var(--border-color, #495057);
            color: var(--body-color, #dee2e6);
        }

        .o_pivot_header_cell_closed,
        .o_pivot_header_cell_opened {
            background-color: var(--tertiary-bg, #2b3035);
            color: var(--body-color, #dee2e6);
        }
    }

    // ---- Graph view ----
    .o_graph_renderer {
        background-color: var(--body-bg, #212529);
    }

    // ---- Cards (Odoo overrides $card-bg with $o-view-background-color) ----
    .card {
        --card-bg: var(--tertiary-bg, #2b3035);
        --card-border-color: var(--border-color, #495057);
        --card-color: var(--body-color, #dee2e6);
        --card-cap-bg: var(--secondary-bg, #343a40);
    }

    // ---- Modals (Odoo overrides $modal-content-bg) ----
    .modal-content {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);
    }

    .modal-header,
    .modal-footer {
        border-color: var(--border-color, #495057);
    }

    // ---- Form controls ----
    .form-control,
    .form-select {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        &:focus {
            background-color: var(--tertiary-bg, #2b3035);
            border-color: var(--ops-secondary, #3b82f6);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        &:disabled,
        &[readonly] {
            background-color: var(--secondary-bg, #343a40);
        }
    }

    // ---- Notebook tabs (form view) ----
    .o_notebook .nav-link {
        color: var(--body-color, #dee2e6);

        &.active {
            background-color: var(--tertiary-bg, #2b3035);
            border-color: var(--border-color, #495057);
            border-bottom-color: var(--tertiary-bg, #2b3035);
        }
    }

    // ---- Dropdown menus (global) ----
    .dropdown-menu {
        --dropdown-bg: var(--tertiary-bg, #2b3035);
        --dropdown-color: var(--body-color, #dee2e6);
        --dropdown-border-color: var(--border-color, #495057);
        --dropdown-link-color: var(--body-color, #dee2e6);
        --dropdown-link-hover-bg: rgba(255, 255, 255, 0.08);
        --dropdown-link-hover-color: #fff;
        --dropdown-divider-bg: var(--border-color, #495057);
    }

    // ---- List group (Odoo overrides $list-group-bg) ----
    .list-group-item {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);
    }

    // ==========================================================================
    // FIX 1: SETTINGS PAGE — Correct selectors matching Odoo 19 DOM
    // ==========================================================================
    // Odoo selectors: .o_base_settings_view .o_form_renderer
    //   .o_setting_container > .settings_tab (sidebar)
    //   .o_setting_container > .settings (main content, bg: $o-view-background-color)
    //   .settings h2 (section headers, bg: --settings__title-bg)
    //   .settingSearchHeader (bg: grays-200)

    .o_base_settings_view .o_form_renderer {
        // Override the CSS custom properties for dark mode
        --settings__tab-bg: var(--tertiary-bg, #2b3035);
        --settings__tab-bg--active: rgba(255, 255, 255, 0.08);
        --settings__tab-color: var(--body-color, #dee2e6);
        --settings__title-bg: var(--secondary-bg, #343a40);
    }

    .o_setting_container {
        .settings_tab {
            background: var(--tertiary-bg, #2b3035) !important;
            border-color: var(--border-color, #495057);

            .tab {
                color: var(--body-color, #dee2e6);

                &:hover,
                &.selected {
                    color: #fff;
                }
            }

            .selected {
                background-color: rgba(255, 255, 255, 0.08) !important;
            }
        }

        .settings {
            background-color: var(--body-bg, #212529) !important;
            color: var(--body-color, #dee2e6);

            > .app_settings_block {
                h2 {
                    background-color: var(--secondary-bg, #343a40) !important;
                    color: var(--body-color, #dee2e6);
                }
            }

            .settingSearchHeader {
                background-color: var(--secondary-bg, #343a40) !important;
                color: var(--body-color, #dee2e6);
            }

            .o_form_label,
            label {
                color: var(--body-color, #dee2e6);
            }

            .highlighter {
                background: #854d0e;
                color: #fef3c7;
            }
        }
    }

    // ==========================================================================
    // FIX 2: DISCUSS / MESSAGING — Full page dark background
    // ==========================================================================
    // Odoo's mail .dark.scss files handle sidebar/content via CSS custom properties
    // but the surface color computation uses mix() with light $o-webclient-bg-color.
    // Override the CSS variable directly for proper dark surface.

    .o_web_client:where(:has(.o-mail-Discuss)) {
        --mail-Discuss-surface-dark: var(--tertiary-bg, #2b3035);
    }

    .o-mail-Discuss {
        background-color: var(--body-bg, #212529) !important;
        color: var(--body-color, #dee2e6);
    }

    .o-mail-DiscussSidebar {
        background-color: var(--tertiary-bg, #2b3035) !important;
        border-right-color: var(--border-color, #495057) !important;

        .o-mail-DiscussSidebarCategory-header {
            color: var(--body-color, #dee2e6);
        }
    }

    .o-mail-DiscussContent-header {
        background-color: var(--tertiary-bg, #2b3035) !important;
        border-bottom-color: var(--border-color, #495057) !important;
    }

    .o-mail-Thread {
        background-color: var(--body-bg, #212529);
    }

    // Chatter (right side panel on forms)
    .o-mail-Form-chatter,
    .o-mail-Chatter {
        background-color: var(--body-bg, #212529);
    }

    .o-mail-Message {
        background-color: var(--body-bg, #212529);
        color: var(--body-color, #dee2e6);
    }

    // Composer (message input area)
    .o-mail-Composer {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
    }

    // ==========================================================================
    // FIX 3: SPREADSHEET DASHBOARD — Override hardcoded white
    // ==========================================================================
    // Odoo's dashboard_action.scss has: background-color: white (hardcoded).
    // Odoo intentionally forces o-spreadsheet to light mode (no dark support yet).
    // We darken the dashboard wrapper; the spreadsheet canvas stays light.

    .o_spreadsheet_dashboard_action {
        background-color: var(--body-bg, #212529) !important;
    }

    // Dashboard sidebar (search panel)
    .o_spreadsheet_dashboard_search_panel {
        background-color: var(--tertiary-bg, #2b3035) !important;
        border-right-color: var(--border-color, #495057) !important;

        li:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }

        .active {
            background-color: rgba(255, 255, 255, 0.12);
        }
    }

    // The spreadsheet itself stays light (Odoo forces color-scheme: light)
    // but we ensure the control panel above it is dark
    .o_spreadsheet_dashboard_action .o_control_panel {
        background-color: var(--body-bg, #212529) !important;
    }

    // ---- Generic spreadsheet wrapper ----
    .o_spreadsheet:not(.o_spreadsheet_dashboard_action .o-spreadsheet) {
        background-color: var(--body-bg, #212529);
    }

    // ---- Statusbar ----
    .o_statusbar_status .o_arrow_button {
        background-color: var(--secondary-bg, #343a40);
        color: var(--body-color, #dee2e6);
        border-color: var(--border-color, #495057);
    }

    // ---- Breadcrumb ----
    .o_breadcrumb .active {
        color: var(--body-color, #dee2e6);
    }

    // ---- Stat buttons (form view KPI blocks) ----
    .oe_stat_button {
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        .o_stat_value {
            color: var(--body-color, #dee2e6);
        }
    }

    // ---- Home menu (app switcher grid) ----
    .o_home_menu {
        background-color: var(--body-bg, #212529);
    }

    .o_app {
        color: var(--body-color, #dee2e6);
    }

    // ---- Scrollbar theming ----
    * {
        scrollbar-color: var(--secondary-bg, #343a40) var(--body-bg, #212529);
    }
}

// =============================================================================
// 2. DARK MODE CSS VARIABLE ADAPTATIONS
// =============================================================================

html[data-bs-theme="dark"] {
    --ops-card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
}

// =============================================================================
// 3. BRANDED NAVBAR — DROPDOWN MENUS IN DARK MODE
// =============================================================================

html[data-bs-theme="dark"] {
    .o_main_navbar {
        .dropdown-menu,
        .o-dropdown--menu {
            background-color: var(--body-bg, #212529);
            border-color: var(--border-color, #495057);
            color: var(--body-color, #dee2e6);

            .dropdown-item {
                color: var(--body-color, #dee2e6);

                &:hover,
                &:focus {
                    background-color: rgba(255, 255, 255, 0.08);
                    color: #ffffff;
                }

                &.active,
                &:active {
                    background-color: rgba(255, 255, 255, 0.12);
                }
            }

            .dropdown-divider {
                border-color: var(--border-color, #495057);
            }
        }

        .o_navbar_apps_menu .dropdown-menu {
            background-color: var(--body-bg, #212529);
        }
    }

    .o_menu_sections {
        .dropdown-menu,
        .o-dropdown--menu {
            background-color: var(--body-bg, #212529);
            border-color: var(--border-color, #495057);

            .dropdown-item,
            a,
            button {
                color: var(--body-color, #dee2e6);

                &:hover,
                &:focus {
                    background-color: rgba(255, 255, 255, 0.08);
                    color: #ffffff;
                }
            }
        }
    }
}

// =============================================================================
// 4. POPUPS / TOASTS / AUTOCOMPLETE IN DARK MODE
// =============================================================================

html[data-bs-theme="dark"] {
    .o_notification {
        &.border-info,
        &.border-success,
        &.border-warning,
        &.border-danger {
            background-color: var(--body-bg, #212529);
            color: var(--body-color, #dee2e6);
        }
    }

    .o-autocomplete--dropdown-menu {
        background-color: var(--body-bg, #212529);
        border-color: var(--border-color, #495057);

        .o-autocomplete--dropdown-item {
            color: var(--body-color, #dee2e6);

            &:hover,
            &.focus {
                background-color: rgba(255, 255, 255, 0.08);
            }
        }
    }

    .o_command_palette {
        .o_command_palette_search input {
            background-color: var(--body-bg, #212529);
            color: var(--body-color, #dee2e6);
            border-color: var(--border-color, #495057);
        }

        .o_command {
            color: var(--body-color, #dee2e6);

            &:hover,
            &.focused {
                background-color: rgba(255, 255, 255, 0.08);
            }
        }
    }

    .o_popover,
    .popover {
        --popover-bg: var(--tertiary-bg, #2b3035);
        --popover-border-color: var(--border-color, #495057);
        --popover-body-color: var(--body-color, #dee2e6);
        --popover-header-bg: var(--secondary-bg, #343a40);
    }
}

// =============================================================================
// 5. LOGIN PAGE (OPS CUSTOM COMPONENT)
// =============================================================================

html[data-bs-theme="dark"] {
    .ops-login-container {
        background: linear-gradient(135deg, var(--body-bg, #212529) 0%, var(--ops-primary, #1e293b) 100%);
    }

    .ops-login-panel {
        background: var(--ops-primary, #1e293b);
        border-color: var(--border-color, #495057);
    }

    .ops-login-brand {
        color: var(--body-color, #dee2e6);
    }

    .ops-login-form-panel {
        background-color: var(--body-bg, #212529) !important;
        color: var(--body-color, #dee2e6);
    }

    .ops-login-header h2,
    .ops-login-header p {
        color: var(--body-color, #dee2e6);
    }

    .ops-login-form-panel input[type="text"],
    .ops-login-form-panel input[type="password"],
    .ops-login-form-panel input[type="email"] {
        background-color: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);
        color: var(--body-color, #dee2e6);

        &:focus {
            background-color: var(--tertiary-bg, #2b3035);
            border-color: var(--ops-secondary, #3b82f6);
        }
    }
}

// =============================================================================
// 6. BUTTONS & BADGES — Branded colors in dark mode
// =============================================================================

html[data-bs-theme="dark"] {
    .btn-primary {
        --btn-bg: var(--ops-secondary, #3b82f6);
        --btn-border-color: var(--ops-secondary, #3b82f6);
        --btn-hover-bg: #2563eb;
        --btn-hover-border-color: #2563eb;
        --btn-active-bg: #1d4ed8;
        --btn-active-border-color: #1d4ed8;
        --btn-color: #fff;
    }

    .btn-success {
        --btn-bg: var(--ops-success, #10b981);
        --btn-border-color: var(--ops-success, #10b981);
    }

    .btn-warning {
        --btn-bg: var(--ops-warning, #f59e0b);
        --btn-border-color: var(--ops-warning, #f59e0b);
    }

    .btn-danger {
        --btn-bg: var(--ops-danger, #ef4444);
        --btn-border-color: var(--ops-danger, #ef4444);
    }

    .badge.text-bg-primary,
    .badge.bg-primary {
        background-color: var(--ops-secondary, #3b82f6) !important;
        color: #fff !important;
    }
}

// =============================================================================
// 7. APP GRID (OPS CUSTOM)
// =============================================================================

html[data-bs-theme="dark"] {
    .ops-app-grid {
        background: var(--body-bg, #212529);
    }

    .ops-app-tile {
        background: var(--tertiary-bg, #2b3035);
        border-color: var(--border-color, #495057);

        &:hover {
            background: var(--secondary-bg, #343a40);
        }
    }
}
