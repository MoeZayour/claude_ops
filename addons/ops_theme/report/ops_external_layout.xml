<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS EXTERNAL LAYOUT — Shared Component Library
         ================================================================
         Single source of truth for ALL OPS external document components.

         Structure:
           1. Paper format
           2. Main layout (header/article/footer)
           3. Reusable components: title_bar, address_block, info_bar,
              totals_block, bottom_section (words + bank + terms + sigs)
           4. Layout registration

         All CSS is inline for wkhtmltopdf compatibility.
         Colors come from _ops dict via company.get_ops_report_settings().
         ================================================================ -->

    <!-- ======================== PAPER FORMAT ========================= -->
    <record id="paperformat_ops_external" model="report.paperformat">
        <field name="name">OPS External Document A4</field>
        <field name="default">False</field>
        <field name="format">A4</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">35</field>
        <field name="margin_bottom">25</field>
        <field name="margin_left">12</field>
        <field name="margin_right">12</field>
        <field name="header_line">False</field>
        <field name="header_spacing">30</field>
        <field name="dpi">96</field>
    </record>

    <!-- ======================== MAIN LAYOUT ========================== -->
    <template id="external_layout_ops" name="OPS Corporate">
        <!-- Resolve company with safe fallback chain -->
        <t t-if="not o" t-set="o" t-value="doc"/>
        <t t-if="not company">
            <t t-if="company_id">
                <t t-set="company" t-value="company_id"/>
            </t>
            <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                <t t-set="company" t-value="o.company_id.sudo()"/>
            </t>
            <t t-else="">
                <t t-set="company" t-value="res_company"/>
            </t>
        </t>

        <!-- Load ALL settings via single Python helper (crash-proof dict) -->
        <t t-set="_ops" t-value="company.get_ops_report_settings()"/>

        <!-- Backward-compatible color aliases used by individual reports -->
        <t t-set="ops_primary" t-value="_ops['primary']"/>
        <t t-set="ops_text_on_primary" t-value="_ops['text_on_primary']"/>
        <t t-set="ops_body_text" t-value="_ops['body_text']"/>
        <t t-set="ops_rgb" t-value="_ops['rgb']"/>

        <!-- =================== HEADER =================== -->
        <div t-attf-class="header o_company_#{company.id}_layout" style="border-bottom: none !important; padding-bottom: 0;">
            <style>
                .header, .header * { border: none !important; outline: none !important; box-shadow: none !important; }
                hr.ops-accent-line { border: none !important; display: block !important; }
            </style>
            <table style="width: 100%; border-collapse: collapse; font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                <tr>
                    <!-- Logo or initials -->
                    <t t-set="_logo_size" t-value="str(_ops.get('logo_size', 80))"/>
                    <td t-attf-style="width: #{str(int(_ops.get('logo_size', 80)) + 10)}px; vertical-align: top; padding-right: 10px;">
                        <t t-if="company.logo">
                            <img t-att-src="image_data_uri(company.logo)"
                                 t-attf-style="max-width: #{_logo_size}px; max-height: #{_logo_size}px; border-radius: 5px;"
                                 alt="Company Logo"/>
                        </t>
                        <t t-else="">
                            <div t-attf-style="width: #{_logo_size}px; height: #{_logo_size}px; border-radius: 5px; background: #{_ops['primary']}; color: #{_ops['text_on_primary']}; text-align: center; line-height: #{_logo_size}px; font-size: 16px; font-weight: 700;">
                                <t t-esc="(company.name or 'CO')[:2].upper()"/>
                            </div>
                        </t>
                    </td>
                    <!-- Company info -->
                    <td style="vertical-align: top;">
                        <div t-attf-style="font-size: 14pt; font-weight: 700; color: #{_ops['primary']}; margin-bottom: 1px;">
                            <t t-esc="company.name"/>
                        </div>
                        <div style="font-size: 7.5pt; color: #64748b; line-height: 1.55;">
                            <t t-if="company.is_company_details_empty">
                                <t t-if="company.street"><t t-esc="company.street"/>
                                    <t t-if="company.street2">, <t t-esc="company.street2"/></t>
                                    <br/>
                                </t>
                                <t t-if="company.city"><t t-esc="company.city"/></t>
                                <t t-if="company.state_id">, <t t-esc="company.state_id.name"/></t>
                                <t t-if="company.zip"> <t t-esc="company.zip"/></t>
                                <t t-if="company.country_id">, <t t-esc="company.country_id.name"/></t>
                                <t t-if="company.city or company.state_id or company.zip or company.country_id"><br/></t>
                                <t t-if="company.phone">Tel: <t t-esc="company.phone"/></t>
                                <t t-if="company.phone and company.email"> &#160;|&#160; </t>
                                <t t-if="company.email"><t t-esc="company.email"/></t>
                                <t t-if="company.phone or company.email"><br/></t>
                                <t t-if="company.company_registry">CR: <t t-esc="company.company_registry"/></t>
                                <t t-if="company.company_registry and company.vat"> &#160;|&#160; </t>
                                <t t-if="company.vat">VAT: <t t-esc="company.vat"/></t>
                            </t>
                            <t t-else="">
                                <span t-field="company.company_details"/>
                            </t>
                        </div>
                    </td>
                    <!-- Doc ref + Print date -->
                    <td style="vertical-align: top; text-align: right; white-space: nowrap;">
                        <div style="font-size: 7pt; color: #94a3b8; font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                            <t t-set="_doc" t-value="o or doc"/>
                            <t t-if="_doc and _doc.name">
                                <span style="font-weight: 600; color: #64748b;">Ref:</span>
                                <span t-esc="_doc.name"/>
                                <span style="margin: 0 4px;">|</span>
                            </t>
                            Printed: <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d %b %Y')"/>
                        </div>
                    </td>
                </tr>
            </table>
            <hr class="ops-accent-line" t-attf-style="background: #{_ops['primary']}; height: 2.5px; margin: 6px 0 0 0;"/>
        </div>

        <!-- =================== ARTICLE =================== -->
        <div t-attf-class="article o_report_layout_ops o_company_#{company.id}_layout"
             t-attf-style="font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #{_ops['body_text']}; font-size: 9pt; line-height: 1.5;">
            <t t-out="0"/>
        </div>

        <!-- =================== FOOTER =================== -->
        <div t-attf-class="footer o_company_#{company.id}_layout" style="font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
            <style>
                .footer, .footer * { border: none !important; outline: none !important; box-shadow: none !important; }
                .footer table.ops-footer-table { border-top: 1px solid #e2e8f0 !important; }
            </style>
            <table class="ops-footer-table" style="width: 100%; border-collapse: collapse; padding-top: 6px; font-size: 7pt;">
                <tr>
                    <td style="vertical-align: middle; color: #94a3b8;">
                        <strong style="color: #64748b;"><t t-esc="company.name"/></strong>
                        <t t-if="company.company_registry">
                            &#160;|&#160; CR: <t t-esc="company.company_registry"/>
                        </t>
                        <t t-if="company.vat">
                            &#160;|&#160; VAT: <t t-esc="company.vat"/>
                        </t>
                        <t t-if="company.phone">
                            &#160;|&#160; Tel: <t t-esc="company.phone"/>
                        </t>
                        <t t-if="company.email">
                            &#160;|&#160; <t t-esc="company.email"/>
                        </t>
                        <t t-if="company.website">
                            &#160;|&#160; <t t-esc="company.website"/>
                        </t>
                    </td>
                    <td style="text-align: right; vertical-align: middle; white-space: nowrap;">
                        <t t-if="_ops['show_badge']">
                            <span style="font-size: 6.5pt; color: #94a3b8; margin-right: 3px;">Powered by</span>
                            <span style="background: #1e40af; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color: white; padding: 2px 7px; border-radius: 3px; font-weight: 600; font-size: 6pt; text-transform: uppercase; letter-spacing: 0.5px;">OPS Framework</span>
                            <span style="margin-left: 8px;"/>
                        </t>
                        <t t-if="report_type == 'pdf'">
                            <span style="font-size: 7pt; color: #94a3b8;">
                                Page <span class="page"/> / <span class="topage"/>
                            </span>
                        </t>
                    </td>
                </tr>
            </table>
        </div>
    </template>

    <!-- ===================== REUSABLE COMPONENTS ===================== -->

    <!-- =================== TITLE BAR =================== -->
    <template id="ops_title_bar" name="OPS Title Bar">
        <!--
            Usage: <t t-set="doc_title" t-value="'Sales Quotation'"/>
                   <t t-set="doc_ref" t-value="doc.name"/>
                   <t t-set="doc_status" t-value="'PAID'"/>  (optional)
                   <t t-set="title_bg" t-value="'#dc2626'"/>  (optional override)
                   <t t-call="ops_theme.ops_title_bar"/>
        -->
        <t t-set="_title_bg" t-value="title_bg or _ops['primary']"/>
        <div t-attf-style="background: #{_title_bg}; color: #{_ops['text_on_primary']}; padding: 10px 14px; border-radius: 3px; margin-bottom: 14px;">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="font-size: 14pt; font-weight: 700;">
                        <t t-esc="doc_title"/>
                    </td>
                    <td style="text-align: right;">
                        <div style="font-size: 12pt; font-weight: 600;">
                            <t t-esc="doc_ref"/>
                        </div>
                        <t t-if="doc_status">
                            <span style="font-size: 7.5pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 3px; margin-top: 2px; display: inline-block;">
                                <t t-esc="doc_status"/>
                            </span>
                        </t>
                    </td>
                </tr>
            </table>
        </div>
    </template>

    <!-- =================== ADDRESS BLOCK =================== -->
    <template id="ops_address_block" name="OPS Address Block">
        <!--
            Usage: <t t-call="ops_theme.ops_address_block">
                       <t t-set="partner" t-value="doc.partner_id"/>
                       <t t-set="addr_label" t-value="'Invoice To'"/>
                       <t t-set="contact_person" t-value="doc.ops_contact_id"/>  (optional)
                   </t>
        -->
        <t t-if="partner">
            <div style="font-size: 8.5pt; margin-bottom: 12px;">
                <div t-if="addr_label" t-attf-style="font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #{_ops['primary']}; margin-bottom: 4px;">
                    <t t-esc="addr_label"/>
                </div>
                <div style="font-weight: 600; font-size: 9.5pt;">
                    <t t-esc="partner.name"/>
                </div>
                <!-- Contact Person (if provided) -->
                <t t-if="contact_person">
                    <t t-set="_cp_mobile" t-value="contact_person.mobile if 'mobile' in contact_person._fields else ''"/>
                    <div style="color: #1e293b; margin-top: 3px; font-size: 8.5pt;">
                        <span style="font-weight: 600;">Attn:</span> <t t-esc="contact_person.name"/>
                        <t t-if="contact_person.function">
                            <span style="color: #64748b;"> — <t t-esc="contact_person.function"/></span>
                        </t>
                    </div>
                    <div t-if="contact_person.phone or _cp_mobile or contact_person.email"
                         style="color: #475569; font-size: 8pt; margin-top: 1px;">
                        <t t-if="_cp_mobile">M: <t t-esc="_cp_mobile"/></t>
                        <t t-elif="contact_person.phone">T: <t t-esc="contact_person.phone"/></t>
                        <t t-if="(_cp_mobile or contact_person.phone) and contact_person.email"> | </t>
                        <t t-if="contact_person.email"><t t-esc="contact_person.email"/></t>
                    </div>
                </t>
                <!-- Address details -->
                <div style="color: #475569; line-height: 1.6; margin-top: 2px; font-size: 8pt;">
                    <t t-if="partner.street"><t t-esc="partner.street"/><br/></t>
                    <t t-if="partner.street2"><t t-esc="partner.street2"/><br/></t>
                    <t t-if="partner.city"><t t-esc="partner.city"/></t>
                    <t t-if="partner.state_id">, <t t-esc="partner.state_id.name"/></t>
                    <t t-if="partner.zip"> <t t-esc="partner.zip"/></t>
                    <t t-if="partner.city or partner.state_id or partner.zip"><br/></t>
                    <t t-if="partner.country_id"><t t-esc="partner.country_id.name"/><br/></t>
                    <t t-if="partner.vat">Tax ID: <t t-esc="partner.vat"/><br/></t>
                    <!-- Only show partner phone/email if no contact person (avoid duplication) -->
                    <t t-if="not contact_person">
                        <t t-if="partner.phone">Tel: <t t-esc="partner.phone"/></t>
                        <t t-if="partner.phone and partner.email"> | </t>
                        <t t-if="partner.email"><t t-esc="partner.email"/></t>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- =================== TOTALS BLOCK =================== -->
    <template id="ops_totals_block" name="OPS Totals Block">
        <!--
            Usage: <t t-set="amount_untaxed" t-value="doc.amount_untaxed"/>
                   <t t-set="amount_tax" t-value="doc.amount_tax"/>
                   <t t-set="amount_total" t-value="doc.amount_total"/>
                   <t t-set="currency" t-value="doc.currency_id"/>
                   <t t-set="total_label" t-value="'Total'"/>  (optional)
                   <t t-set="total_bg" t-value="'#dc2626'"/>  (optional override)
                   <t t-set="amount_paid" t-value="..."/>  (optional)
                   <t t-set="amount_residual" t-value="..."/>  (optional)
                   <t t-call="ops_theme.ops_totals_block"/>
        -->
        <table style="width: 40%; margin-left: auto; border-collapse: collapse; margin-top: 4px;">
            <tr class="ops-totals-row">
                <td style="padding: 5px 10px; font-size: 8pt; color: #64748b;">Untaxed Amount</td>
                <td style="padding: 5px 10px; text-align: right; font-variant-numeric: tabular-nums; font-size: 9pt;">
                    <t t-esc="amount_untaxed" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                </td>
            </tr>
            <t t-if="amount_tax">
                <tr class="ops-totals-row">
                    <td style="padding: 5px 10px; font-size: 8pt; color: #64748b;">Taxes</td>
                    <td style="padding: 5px 10px; text-align: right; font-variant-numeric: tabular-nums; font-size: 9pt;">
                        <t t-esc="amount_tax" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </td>
                </tr>
            </t>
            <tr t-attf-style="background: #{total_bg or _ops['primary']}; color: #{_ops['text_on_primary']};">
                <td style="padding: 8px 10px; font-size: 9pt; font-weight: 700;">
                    <t t-esc="total_label or 'Total'"/>
                </td>
                <td style="padding: 8px 10px; text-align: right; font-size: 11pt; font-weight: 700; font-variant-numeric: tabular-nums;">
                    <t t-esc="amount_total" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                </td>
            </tr>
        </table>
        <!-- Paid + Balance due (for partial payments) -->
        <t t-if="amount_paid and amount_residual">
            <table style="width: 40%; margin-left: auto; border-collapse: collapse; margin-top: -1px;">
                <tr class="ops-totals-row">
                    <td style="padding: 5px 10px; font-size: 8pt; color: #16a34a;">Amount Paid</td>
                    <td style="padding: 5px 10px; text-align: right; font-variant-numeric: tabular-nums; font-size: 9pt; color: #16a34a;">
                        <t t-esc="amount_paid" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </td>
                </tr>
                <tr style="background: #fef3c7;">
                    <td style="padding: 8px 10px; font-size: 9pt; font-weight: 700; color: #92400e;">Balance Due</td>
                    <td style="padding: 8px 10px; text-align: right; font-size: 11pt; font-weight: 700; font-variant-numeric: tabular-nums; color: #92400e;">
                        <t t-esc="amount_residual" t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                    </td>
                </tr>
            </table>
        </t>
    </template>

    <!-- =================== BOTTOM SECTION =================== -->
    <template id="ops_bottom_section" name="OPS Bottom Section">
        <!--
            Orchestrator: calls all bottom components in order.
            Each sub-template is self-guarded (renders nothing if not applicable).

            Expects in scope:
              _ops           — settings dict
              company        — res.company record
              o or doc       — the document record
              amount_for_words   — float (optional)
              currency_for_words — res.currency (optional)
              doc_note       — html/text (optional, for terms)
              show_bank      — override (optional, default from _ops)
        -->
        <!-- Amount in Words -->
        <t t-call="ops_theme.ops_amount_words_block"/>
        <!-- Bank Details -->
        <t t-call="ops_theme.ops_bank_block"/>
        <!-- Terms & Conditions -->
        <t t-call="ops_theme.ops_terms_block"/>
        <!-- Signatures -->
        <t t-call="ops_theme.ops_signature_block"/>
    </template>

    <!-- =================== AMOUNT IN WORDS =================== -->
    <template id="ops_amount_words_block" name="OPS Amount in Words">
        <!--
            Usage: Set amount_for_words and currency_for_words before calling.
            Reads _ops['show_words'] and _ops['words_lang'] for toggle/language.
        -->
        <t t-if="_ops['show_words'] and amount_for_words and currency_for_words">
            <t t-set="_words" t-value="env['ops.report.helpers'].amount_to_words(amount_for_words, currency_for_words, _ops['words_lang'])"/>
            <t t-if="_words">
                <div t-attf-style="margin-top: 10px; padding: 6px 10px; background: rgba(#{_ops['rgb']}, 0.07); border-radius: 3px; font-size: 8.5pt; page-break-inside: avoid;">
                    <span style="font-weight: 600; color: #475569;">Amount in Words:</span>
                    <t t-if="_words.get('en')">
                        <span style="color: #1e293b;"> <t t-esc="_words['en']"/></span>
                    </t>
                    <t t-if="_words.get('ar')">
                        <br/><span dir="rtl" style="color: #1e293b; font-family: 'Arial', 'Tahoma', sans-serif;"><t t-esc="_words['ar']"/></span>
                    </t>
                </div>
            </t>
        </t>
    </template>

    <!-- =================== BANK DETAILS =================== -->
    <template id="ops_bank_block" name="OPS Bank Details">
        <!--
            Self-guarded: only renders if _ops['show_bank'] and company has bank accounts.
            Set show_bank_override=False to suppress even when enabled.
        -->
        <t t-if="_ops['show_bank'] and company.partner_id.bank_ids">
            <t t-set="_bank" t-value="company.partner_id.bank_ids[:1]"/>
            <div class="ops-bank-box" style="margin-top: 14px; padding: 8px 10px; font-size: 7.5pt; page-break-inside: avoid;">
                <div t-attf-style="font-weight: 600; margin-bottom: 4px; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px; color: #{_ops['primary']};">Bank Details for Payment</div>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <t t-if="_bank.bank_id and _bank.bank_id.name">
                            <td style="padding: 2px 8px 2px 0;">
                                <span style="font-weight: 600; color: #64748b;">Bank:</span>
                                <t t-esc="_bank.bank_id.name"/>
                            </td>
                        </t>
                        <t t-if="_bank.acc_number">
                            <td style="padding: 2px 8px;">
                                <span style="font-weight: 600; color: #64748b;">Account:</span>
                                <t t-esc="_bank.acc_number"/>
                            </td>
                        </t>
                        <t t-if="_bank.bank_id and _bank.bank_id.bic">
                            <td style="padding: 2px 8px;">
                                <span style="font-weight: 600; color: #64748b;">SWIFT:</span>
                                <t t-esc="_bank.bank_id.bic"/>
                            </td>
                        </t>
                        <t t-if="_bank.acc_holder_name">
                            <td style="padding: 2px 0 2px 8px;">
                                <span style="font-weight: 600; color: #64748b;">Holder:</span>
                                <t t-esc="_bank.acc_holder_name"/>
                            </td>
                        </t>
                    </tr>
                </table>
            </div>
        </t>
    </template>

    <!-- =================== TERMS & CONDITIONS =================== -->
    <template id="ops_terms_block" name="OPS Terms Block">
        <!--
            Usage: <t t-set="doc_note" t-value="doc.note"/>
                   <t t-call="ops_theme.ops_terms_block"/>
            Falls back to company.ops_report_terms if no doc_note.
        -->
        <t t-set="terms" t-value="doc_note or _ops['report_terms'] or False"/>
        <t t-if="terms">
            <div class="ops-terms-box" style="margin-top: 16px; padding: 8px 10px; font-size: 7.5pt; color: #64748b; page-break-inside: avoid;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px;">Terms &amp; Conditions</div>
                <t t-out="terms"/>
            </div>
        </t>
    </template>

    <!-- =================== SIGNATURE BLOCK =================== -->
    <template id="ops_signature_block" name="OPS Signature Block">
        <!--
            Self-guarded by _ops['show_sig'].
            Reads signature labels from _ops dict.
            Set sig_labels override: <t t-set="sig_labels" t-value="['Prepared By', 'Approved By']"/>
        -->
        <t t-if="_ops['show_sig']">
            <div style="margin-top: 30px; page-break-inside: avoid;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 33%; padding: 0 10px 0 0; vertical-align: top;">
                            <div class="ops-sig-line" style="padding-top: 6px; text-align: center;">
                                <div style="font-size: 7pt; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px;">
                                    <t t-esc="_ops['sig1']"/>
                                </div>
                            </div>
                        </td>
                        <td style="width: 33%; padding: 0 5px; vertical-align: top;">
                            <div class="ops-sig-line" style="padding-top: 6px; text-align: center;">
                                <div style="font-size: 7pt; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px;">
                                    <t t-esc="_ops['sig2']"/>
                                </div>
                            </div>
                        </td>
                        <td style="width: 33%; padding: 0 0 0 10px; vertical-align: top;">
                            <div class="ops-sig-line" style="padding-top: 6px; text-align: center;">
                                <div style="font-size: 7pt; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px;">
                                    <t t-esc="_ops['sig3']"/>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </t>
    </template>

    <!-- =================== REGISTER AS LAYOUT OPTION ================ -->
    <record id="report_layout_ops" model="report.layout">
        <field name="name">OPS Professional</field>
        <field name="sequence">100</field>
        <field name="view_id" ref="external_layout_ops"/>
        <field name="image">/ops_theme/static/description/layout_ops.png</field>
    </record>

</odoo>
