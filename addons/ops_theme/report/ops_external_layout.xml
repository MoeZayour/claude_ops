<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS EXTERNAL LAYOUT — Selectable Document Layout
         ================================================================
         This template integrates with Odoo's layout dispatcher system.
         When selected as company layout, ALL external documents
         (invoices, quotations, POs, etc.) get the OPS corporate look.

         Architecture:
         - Header: Company letterhead (logo, name, address, CR/VAT)
         - Article: Document content (injected by each report)
         - Footer: Company line + optional OPS Framework badge

         wkhtmltopdf rules:
         - ALL CSS inline (no external stylesheets)
         - NO CSS variables (colors injected via t-esc)
         - NO flexbox gap (use margins)
         - display:table for layout (reliable in wkhtmltopdf)
    ================================================================ -->

    <template id="external_layout_ops">
        <!-- Resolve company -->
        <t t-if="not o" t-set="o" t-value="doc"/>
        <t t-if="not company">
            <t t-if="company_id">
                <t t-set="company" t-value="company_id"/>
            </t>
            <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                <t t-set="company" t-value="o.company_id.sudo()"/>
            </t>
            <t t-else="">
                <t t-set="company" t-value="res_company"/>
            </t>
        </t>

        <!-- Compute dynamic colors once -->
        <t t-set="ops_primary" t-value="company.ops_primary_color or '#1e293b'"/>
        <t t-set="ops_rgb" t-value="'%s,%s,%s' % (int(ops_primary[1:3], 16), int(ops_primary[3:5], 16), int(ops_primary[5:7], 16)) if ops_primary.startswith('#') and len(ops_primary) == 7 else '30,41,59'"/>

        <!-- ========== HEADER ========== -->
        <div t-attf-class="header o_company_#{company.id}_layout" style="border-bottom: none;">
            <style>
                .ops-lh { display: table; width: 100%; padding-bottom: 10px; margin-bottom: 0; }
                .ops-lh-l { display: table-cell; vertical-align: top; width: 65%; }
                .ops-lh-r { display: table-cell; vertical-align: top; text-align: right; width: 35%; }
                .ops-logo { width: 55px; height: 55px; border-radius: 5px; vertical-align: top; margin-right: 10px; }
                .ops-logo-ph { display: inline-block; width: 55px; height: 55px; border-radius: 5px; color: white; text-align: center; line-height: 55px; font-weight: 700; font-size: 16px; vertical-align: top; margin-right: 10px; }
                .ops-cn { font-size: 14pt; font-weight: 700; margin-bottom: 1px; }
                .ops-cd { font-size: 7.5pt; color: #64748b; line-height: 1.55; }
                .ops-hdr-line { height: 2.5px; margin: 0; border: none; }
            </style>
            <div class="ops-lh">
                <div class="ops-lh-l">
                    <t t-if="company.logo">
                        <img t-att-src="image_data_uri(company.logo)" class="ops-logo" alt="Logo"/>
                    </t>
                    <t t-else="">
                        <div class="ops-logo-ph" t-att-style="'background:' + ops_primary">
                            <t t-esc="(company.name or 'CO')[:2].upper()"/>
                        </div>
                    </t>
                    <div style="display: inline-block; vertical-align: top;">
                        <div class="ops-cn" t-att-style="'color:' + ops_primary"><t t-esc="company.name"/></div>
                        <div class="ops-cd">
                            <t t-if="company.is_company_details_empty">
                                <t t-if="company.street"><t t-esc="company.street"/><br/></t>
                                <t t-if="company.street2"><t t-esc="company.street2"/><br/></t>
                                <t t-if="company.city"><t t-esc="company.city"/></t>
                                <t t-if="company.state_id">, <t t-esc="company.state_id.name"/></t>
                                <t t-if="company.country_id">, <t t-esc="company.country_id.name"/></t>
                                <br/>
                                <t t-if="company.phone">Tel: <t t-esc="company.phone"/></t>
                                <t t-if="company.email"> &#160;|&#160; <t t-esc="company.email"/></t>
                                <br/>
                                <t t-if="company.company_registry">CR: <t t-esc="company.company_registry"/></t>
                                <t t-if="company.vat"> &#160;|&#160; VAT: <t t-esc="company.vat"/></t>
                            </t>
                            <t t-else="">
                                <span t-field="company.company_details"/>
                            </t>
                        </div>
                    </div>
                </div>
                <div class="ops-lh-r">
                    <!-- Document ref area — populated by calling template if needed -->
                </div>
            </div>
            <hr class="ops-hdr-line" t-att-style="'background:' + ops_primary"/>
        </div>

        <!-- ========== ARTICLE ========== -->
        <div t-attf-class="article o_report_layout_ops o_company_#{company.id}_layout"
             style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1e293b; font-size: 9pt; line-height: 1.5;">

            <!-- Inject OPS styles into document body -->
            <t t-call="ops_theme.ops_report_css"/>

            <!-- Standard address layout -->
            <t t-call="web.address_layout"/>

            <!-- Document title -->
            <t t-if="layout_document_title">
                <div class="ops-title-bar" t-att-style="'background:' + ops_primary + '; color: white; padding: 8px 14px; border-radius: 4px; margin-bottom: 16px;'">
                    <h2 style="font-size: 12pt; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0; display: inline-block;">
                        <t t-out="layout_document_title"/>
                    </h2>
                </div>
            </t>

            <!-- Document content -->
            <t t-out="0"/>
        </div>

        <!-- ========== FOOTER ========== -->
        <div t-attf-class="footer o_company_#{company.id}_layout {{report_type != 'pdf' and 'mt-auto'}}">
            <style>
                .ops-ft { display: table; width: 100%; border-top: 1px solid #e2e8f0; padding-top: 6px; font-size: 7pt; }
                .ops-ft-l { display: table-cell; vertical-align: middle; color: #94a3b8; }
                .ops-ft-l strong { color: #64748b; }
                .ops-ft-r { display: table-cell; vertical-align: middle; text-align: right; }
                .ops-badge { background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 2px 7px; border-radius: 3px; font-weight: 600; font-size: 6pt; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
                .ops-pby { font-size: 6.5pt; color: #94a3b8; margin-right: 3px; }
            </style>
            <div class="ops-ft">
                <div class="ops-ft-l">
                    <strong><t t-esc="company.name"/></strong>
                    <t t-if="company.company_registry">
                        &#160;|&#160; CR: <t t-esc="company.company_registry"/>
                    </t>
                    <t t-if="company.vat">
                        &#160;|&#160; VAT: <t t-esc="company.vat"/>
                    </t>
                    <t t-if="company.website">
                        &#160;|&#160; <t t-esc="company.website"/>
                    </t>
                </div>
                <div class="ops-ft-r">
                    <t t-if="company.ops_show_external_badge">
                        <span class="ops-pby">Powered by</span>
                        <span class="ops-badge">OPS Framework</span>
                        <span style="margin-left: 8px;"/>
                    </t>
                    <t t-if="report_type == 'pdf'" >
                        <span style="font-size: 7pt; color: #94a3b8;">
                            Page <span class="page"/> / <span class="topage"/>
                        </span>
                    </t>
                </div>
            </div>
        </div>
    </template>

    <!-- ================================================================
         REGISTER AS SELECTABLE LAYOUT OPTION
    ================================================================ -->
    <record id="report_layout_ops" model="report.layout">
        <field name="name">OPS Professional</field>
        <field name="sequence">100</field>
        <field name="view_id" ref="external_layout_ops"/>
        <field name="image">/ops_theme/static/description/layout_ops.png</field>
    </record>

</odoo>
