<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         OPS EXTERNAL LAYOUT — Single Source of Truth

         Registered as a layout option in Odoo's Document Layout picker.
         When selected, all reports using t-call="web.external_layout"
         will use this layout.

         Structure: div.header → div.article → div.footer
         wkhtmltopdf extracts header/footer for page repetition.

         All CSS is inline — no external stylesheet dependencies.
         ================================================================ -->

    <!-- ======================== PAPER FORMAT ========================= -->
    <record id="paperformat_ops_external" model="report.paperformat">
        <field name="name">OPS External Document A4</field>
        <field name="default">False</field>
        <field name="format">A4</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">35</field>
        <field name="margin_bottom">25</field>
        <field name="margin_left">12</field>
        <field name="margin_right">12</field>
        <field name="header_line">False</field>
        <field name="header_spacing">30</field>
        <field name="dpi">96</field>
    </record>

    <!-- ======================== MAIN LAYOUT ========================== -->
    <template id="external_layout_ops" name="OPS Corporate">
        <!-- Resolve company with safe fallback chain -->
        <t t-if="not o" t-set="o" t-value="doc"/>
        <t t-if="not company">
            <t t-if="company_id">
                <t t-set="company" t-value="company_id"/>
            </t>
            <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                <t t-set="company" t-value="o.company_id.sudo()"/>
            </t>
            <t t-else="">
                <t t-set="company" t-value="res_company"/>
            </t>
        </t>

        <!-- Dynamic colors — ops_report_primary_color from accounting, ops_primary_color from theme -->
        <t t-set="ops_primary" t-value="company.ops_report_primary_color or '#3d58a3'"/>
        <t t-set="ops_text_on_primary" t-value="company.ops_report_text_on_primary or '#FFFFFF'"/>
        <t t-set="ops_body_text" t-value="company.ops_report_body_text_color or '#1a1a1a'"/>
        <t t-set="ops_rgb" t-value="'%s,%s,%s' % (int(ops_primary[1:3], 16), int(ops_primary[3:5], 16), int(ops_primary[5:7], 16)) if ops_primary.startswith('#') and len(ops_primary) == 7 else '61,88,163'"/>

        <!-- =================== HEADER =================== -->
        <div t-attf-class="header o_company_#{company.id}_layout" style="border-bottom: none; padding-bottom: 0;">
            <table style="width: 100%; border-collapse: collapse; font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                <tr>
                    <!-- Logo or initials -->
                    <td style="width: 60px; vertical-align: top; padding-right: 10px;">
                        <t t-if="company.logo">
                            <img t-att-src="image_data_uri(company.logo)"
                                 style="max-width: 55px; max-height: 55px; border-radius: 5px;"
                                 alt="Company Logo"/>
                        </t>
                        <t t-else="">
                            <div t-attf-style="width: 55px; height: 55px; border-radius: 5px; background: #{ops_primary}; color: #{ops_text_on_primary}; text-align: center; line-height: 55px; font-size: 16px; font-weight: 700;">
                                <t t-esc="(company.name or 'CO')[:2].upper()"/>
                            </div>
                        </t>
                    </td>
                    <!-- Company info -->
                    <td style="vertical-align: top;">
                        <div t-attf-style="font-size: 14pt; font-weight: 700; color: #{ops_primary}; margin-bottom: 1px;">
                            <t t-esc="company.name"/>
                        </div>
                        <div style="font-size: 7.5pt; color: #64748b; line-height: 1.55;">
                            <t t-if="company.is_company_details_empty">
                                <t t-if="company.street"><t t-esc="company.street"/>
                                    <t t-if="company.street2">, <t t-esc="company.street2"/></t>
                                    <br/>
                                </t>
                                <t t-if="company.city"><t t-esc="company.city"/></t>
                                <t t-if="company.state_id">, <t t-esc="company.state_id.name"/></t>
                                <t t-if="company.zip"> <t t-esc="company.zip"/></t>
                                <t t-if="company.country_id">, <t t-esc="company.country_id.name"/></t>
                                <t t-if="company.city or company.state_id or company.zip or company.country_id"><br/></t>
                                <t t-if="company.phone">Tel: <t t-esc="company.phone"/></t>
                                <t t-if="company.phone and company.email"> &#160;|&#160; </t>
                                <t t-if="company.email"><t t-esc="company.email"/></t>
                                <t t-if="company.phone or company.email"><br/></t>
                                <t t-if="company.company_registry">CR: <t t-esc="company.company_registry"/></t>
                                <t t-if="company.company_registry and company.vat"> &#160;|&#160; </t>
                                <t t-if="company.vat">VAT: <t t-esc="company.vat"/></t>
                            </t>
                            <t t-else="">
                                <span t-field="company.company_details"/>
                            </t>
                        </div>
                    </td>
                    <!-- Print date -->
                    <td style="vertical-align: top; text-align: right; white-space: nowrap;">
                        <div style="font-size: 7pt; color: #94a3b8; font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                            Printed: <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d %b %Y')"/>
                        </div>
                    </td>
                </tr>
            </table>
            <hr t-attf-style="background: #{ops_primary}; height: 2.5px; margin: 6px 0 0 0; border: none;"/>
        </div>

        <!-- =================== ARTICLE =================== -->
        <div t-attf-class="article o_report_layout_ops o_company_#{company.id}_layout"
             t-attf-style="font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #{ops_body_text}; font-size: 9pt; line-height: 1.5;">
            <t t-out="0"/>
        </div>

        <!-- =================== FOOTER =================== -->
        <div t-attf-class="footer o_company_#{company.id}_layout" style="font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
            <table style="width: 100%; border-collapse: collapse; border-top: 1px solid #e2e8f0; padding-top: 6px; font-size: 7pt;">
                <tr>
                    <td style="vertical-align: middle; color: #94a3b8;">
                        <strong style="color: #64748b;"><t t-esc="company.name"/></strong>
                        <t t-if="company.company_registry">
                            &#160;|&#160; CR: <t t-esc="company.company_registry"/>
                        </t>
                        <t t-if="company.vat">
                            &#160;|&#160; VAT: <t t-esc="company.vat"/>
                        </t>
                        <t t-if="company.website">
                            &#160;|&#160; <t t-esc="company.website"/>
                        </t>
                    </td>
                    <td style="text-align: right; vertical-align: middle; white-space: nowrap;">
                        <t t-if="company.ops_show_external_badge">
                            <span style="font-size: 6.5pt; color: #94a3b8; margin-right: 3px;">Powered by</span>
                            <span style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 2px 7px; border-radius: 3px; font-weight: 600; font-size: 6pt; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;">OPS Framework</span>
                            <span style="margin-left: 8px;"/>
                        </t>
                        <t t-if="report_type == 'pdf'">
                            <span style="font-size: 7pt; color: #94a3b8;">
                                Page <span class="page"/> / <span class="topage"/>
                            </span>
                        </t>
                    </td>
                </tr>
            </table>
        </div>
    </template>

    <!-- ===================== HELPER TEMPLATES ======================== -->

    <!-- Address block: renders partner address with fail-safe -->
    <template id="ops_address_block" name="OPS Address Block">
        <!--
            Usage: <t t-call="ops_theme.ops_address_block">
                       <t t-set="partner" t-value="doc.partner_id"/>
                       <t t-set="addr_label" t-value="'Invoice To'"/>
                   </t>
        -->
        <t t-if="partner">
            <div style="font-size: 8.5pt; margin-bottom: 12px;">
                <div t-if="addr_label" t-attf-style="font-size: 7pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #{company.ops_report_primary_color or '#3d58a3'}; margin-bottom: 4px;">
                    <t t-esc="addr_label"/>
                </div>
                <div style="font-weight: 600; font-size: 9.5pt;">
                    <t t-esc="partner.name"/>
                </div>
                <div style="color: #475569; line-height: 1.6; margin-top: 2px; font-size: 8pt;">
                    <t t-if="partner.street"><t t-esc="partner.street"/><br/></t>
                    <t t-if="partner.street2"><t t-esc="partner.street2"/><br/></t>
                    <t t-if="partner.city"><t t-esc="partner.city"/></t>
                    <t t-if="partner.state_id">, <t t-esc="partner.state_id.name"/></t>
                    <t t-if="partner.zip"> <t t-esc="partner.zip"/></t>
                    <t t-if="partner.city or partner.state_id or partner.zip"><br/></t>
                    <t t-if="partner.country_id"><t t-esc="partner.country_id.name"/><br/></t>
                    <t t-if="partner.vat">Tax ID: <t t-esc="partner.vat"/><br/></t>
                    <t t-if="partner.phone">Tel: <t t-esc="partner.phone"/></t>
                    <t t-if="partner.phone and partner.email"> | </t>
                    <t t-if="partner.email"><t t-esc="partner.email"/></t>
                </div>
            </div>
        </t>
    </template>

    <!-- Signature block -->
    <template id="ops_signature_block" name="OPS Signature Block">
        <!--
            Usage: <t t-call="ops_theme.ops_signature_block"/>
            Requires: company in context
        -->
        <t t-if="company.ops_show_signature_block">
            <t t-set="sig1" t-value="company.ops_signature_label_1 or 'Prepared By'"/>
            <t t-set="sig2" t-value="company.ops_signature_label_2 or 'Authorized Signatory'"/>
            <t t-set="sig3" t-value="company.ops_signature_label_3 or 'Customer Acceptance'"/>
            <div style="margin-top: 30px; page-break-inside: avoid;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 33%; padding: 0 10px 0 0; vertical-align: top;">
                            <div style="border-top: 1px solid #cbd5e1; padding-top: 6px; text-align: center;">
                                <div style="font-size: 7pt; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px;">
                                    <t t-esc="sig1"/>
                                </div>
                            </div>
                        </td>
                        <td style="width: 33%; padding: 0 5px; vertical-align: top;">
                            <div style="border-top: 1px solid #cbd5e1; padding-top: 6px; text-align: center;">
                                <div style="font-size: 7pt; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px;">
                                    <t t-esc="sig2"/>
                                </div>
                            </div>
                        </td>
                        <td style="width: 33%; padding: 0 0 0 10px; vertical-align: top;">
                            <div style="border-top: 1px solid #cbd5e1; padding-top: 6px; text-align: center;">
                                <div style="font-size: 7pt; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px;">
                                    <t t-esc="sig3"/>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </t>
    </template>

    <!-- Terms & Conditions -->
    <template id="ops_terms_block" name="OPS Terms Block">
        <!--
            Usage: <t t-call="ops_theme.ops_terms_block">
                       <t t-set="doc_note" t-value="doc.note"/>
                   </t>
            Falls back to company.ops_report_terms if no doc_note
        -->
        <t t-set="terms" t-value="doc_note or company.ops_report_terms or False"/>
        <t t-if="terms">
            <div style="margin-top: 16px; padding: 8px 10px; border-left: 3px solid #e2e8f0; font-size: 7.5pt; color: #64748b; page-break-inside: avoid;">
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 7pt; text-transform: uppercase; letter-spacing: 0.3px;">Terms &amp; Conditions</div>
                <t t-out="terms"/>
            </div>
        </t>
    </template>

    <!-- Amount in words -->
    <template id="ops_amount_words_block" name="OPS Amount in Words">
        <!--
            Usage: <t t-call="ops_theme.ops_amount_words_block">
                       <t t-set="amount_words_en" t-value="'...'"/>
                       <t t-set="amount_words_ar" t-value="'...'"/>
                   </t>
        -->
        <t t-if="amount_words_en or amount_words_ar">
            <div t-attf-style="margin-top: 10px; padding: 6px 10px; background: rgba(#{company.ops_report_primary_color and ('%s,%s,%s' % (int(company.ops_report_primary_color[1:3], 16), int(company.ops_report_primary_color[3:5], 16), int(company.ops_report_primary_color[5:7], 16))) or '61,88,163'}, 0.07); border-radius: 3px; font-size: 8.5pt; page-break-inside: avoid;">
                <span style="font-weight: 600; color: #475569;">Amount in Words:</span>
                <t t-if="amount_words_en">
                    <span style="color: #1e293b;"> <t t-esc="amount_words_en"/></span>
                </t>
                <t t-if="amount_words_ar">
                    <br/><span dir="rtl" style="color: #1e293b; font-family: 'Arial', 'Tahoma', sans-serif;"><t t-esc="amount_words_ar"/></span>
                </t>
            </div>
        </t>
    </template>

    <!-- =================== REGISTER AS LAYOUT OPTION ================ -->
    <record id="report_layout_ops" model="report.layout">
        <field name="name">OPS Professional</field>
        <field name="sequence">100</field>
        <field name="view_id" ref="external_layout_ops"/>
        <field name="image">/ops_theme/static/description/layout_ops.png</field>
    </record>

</odoo>
